<!DOCTYPE html>
<html th:replace="~{fragments/layout/base :: base(~{::head}, ~{::body})}" xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <title>프로필 페이지</title>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <style>
        :where([class^="ri-"])::before { content: "\f3c2"; }
        body { background-color: #f9fafb; }
        .profile-image { width: 120px; height: 120px; object-fit: cover; border: 3px solid white; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .card { box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); transition: all 0.3s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1); }
        .survey-item { border-bottom: 1px solid #e5e7eb; }
        .survey-item:last-child { border-bottom: none; }
        input:focus, textarea:focus { outline: none; border-color: #3b82f6; }
    </style>
</head>
<body>
<div class="bg-gray-50 min-h-screen">
    <header class="bg-white shadow-sm">
        <nav th:replace="~{fragments/common/nav-user :: nav-user}"></nav>
    </header>

    <main class="container mx-auto pt-20 px-4 py-8">
        <!-- 프로필 정보 섹션 -->
        <section class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <div class="flex justify-between items-start mb-6">
                <h2 class="text-2xl font-bold text-gray-800">내 프로필</h2>
                <button id="editProfileBtn"
                        class="flex items-center space-x-1 text-primary hover:text-primary/80 !rounded-button px-4 py-2 border border-primary/30 bg-primary/5">
                    <i class="ri-edit-line ri-sm"></i>
                    <span class="whitespace-nowrap">프로필 편집</span>
                </button>

                <div id="editProfileModal"
                     class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg w-full max-w-2xl mx-4">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-xl font-bold text-gray-800">프로필 편집</h3>
                        </div>
                        <div class="p-6">
                            <form id="profileEditForm">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-500 mb-1">이름</label>
                                        <input type="text" name="name" id="editName"
                                               class="w-full px-4 py-2 border border-gray-300 rounded-button focus:border-primary focus:ring-1 focus:ring-primary"
                                               th:value="${profileDto.member.memberName}"/>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-500 mb-1">생년월일</label>
                                        <input type="date" name="birthdate" id="editBirthdate"
                                               class="w-full px-4 py-2 border border-gray-300 rounded-button focus:border-primary focus:ring-1 focus:ring-primary"
                                               th:value="${profileDto.member.birth}"/>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-500 mb-1">이메일</label>
                                        <input type="email" name="email" id="editEmail"
                                               class="w-full px-4 py-2 border border-gray-300 rounded-button focus:border-primary focus:ring-1 focus:ring-primary"
                                               th:value="${profileDto.member.email}"/>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-500 mb-1">전화번호</label>
                                        <input type="tel" name="phone" id="editHomePhoneNum"
                                               class="w-full px-4 py-2 border border-gray-300 rounded-button focus:border-primary focus:ring-1 focus:ring-primary"
                                               th:value="${profileDto.member.homePhoneNumber}"/>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-500 mb-1">휴대폰번호</label>
                                        <input type="tel" name="phone" id="editPhoneNum"
                                               class="w-full px-4 py-2 border border-gray-300 rounded-button focus:border-primary focus:ring-1 focus:ring-primary"
                                               th:value="${profileDto.member.phoneNumber}"/>
                                    </div>

                                    <div class="md:col-span-2">
                                        <div class="flex items-center justify-between mb-1">
                                            <label class="block text-sm font-medium text-gray-500">주소</label>

                                            <div class="flex items-center space-x-2 ml-auto">
                                                <button type="button" id="openChineseModal"
                                                        class="whitespace-nowrap !rounded-button bg-blue-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 text-sm font-medium transition openChineseModal"
                                                        data-target="address">
                                                    중국 주소 검색
                                                </button>
                                                <button type="button"
                                                        class="text-sm px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-button transition"
                                                        onclick="openPostcode('member')">
                                                    한국 주소 검색
                                                </button>
                                            </div>
                                        </div>
                                        <input id="editAddress1"
                                               class="w-full px-4 py-2 border border-gray-300 rounded-button focus:border-primary focus:ring-1 focus:ring-primary"
                                               placeholder="기본 주소" th:value="${profileDto.member.address1}" readonly/>
                                        <input id="editAddress2"
                                               class="mt-2 w-full px-4 py-2 border border-gray-300 rounded-button focus:border-primary focus:ring-1 focus:ring-primary"
                                               placeholder="상세 주소" th:value="${profileDto.member.address2}"/>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                            <button id="cancelEditBtn"
                                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-button hover:bg-gray-50">
                                취소
                            </button>
                            <button id="saveProfileBtn"
                                    class="px-4 py-2 bg-primary text-white rounded-button hover:bg-primary/90">
                                저장
                            </button>
                        </div>
                    </div>
                </div>

                <div id="successToast"
                     class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-full opacity-0 transition-all duration-300 hidden">
                    프로필이 성공적으로 업데이트되었습니다
                </div>
            </div>

            <!-- ... (중간 내용 동일) ... -->
            <div class="flex flex-col gap-8">
                <div class="flex-1">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-500 mb-1">이름</label>
                            <p class="text-gray-900 font-medium" th:text="${profileDto.member.memberName}">김지현</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-500 mb-1">생년월일</label>
                            <p class="text-gray-900 font-medium" th:text="${profileDto.member.birth}">1998년 5월 12일</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-500 mb-1">이메일</label>
                            <p class="text-gray-900 font-medium" th:text="${profileDto.member.email}">jihyun.kim@example.com</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-500 mb-1"> 전화 번호</label>
                            <p class="text-gray-900 font-medium" th:text="${profileDto.member.homePhoneNumber}">010-1234-5678</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-500 mb-1"> 휴대전화 번호</label>
                            <p class="text-gray-900 font-medium" th:text="${profileDto.member.phoneNumber}">010-1234-5678</p>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-500 mb-1">주소</label>
                            <p class="text-gray-700" th:text="${profileDto.member.address1+' '+profileDto.member.address2}">경기도 성남시</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 유학원 정보 섹션 -->
        <section class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <div class="flex justify-between items-start mb-6">
                <h2 class="text-2xl font-bold text-gray-800">유학원 정보</h2>
                <button id="editAgencyBtn"
                        class="flex items-center space-x-1 text-primary hover:text-primary/80 !rounded-button px-4 py-2 border border-primary/30 bg-primary/5">
                    <i class="ri-edit-line ri-sm"></i>
                    <span class="whitespace-nowrap">정보 수정</span>
                </button>

                <div id="editAgencyModal"
                     class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg w-full max-w-2xl mx-4">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-xl font-bold text-gray-800">유학원 정보 수정</h3>
                        </div>

                        <div class="p-6">
                            <form id="agencyEditForm">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-500 mb-1">유학원명</label>
                                        <input type="text" id="editAgencyName"
                                               class="w-full px-4 py-2 border border-gray-300 rounded-button focus:border-primary focus:ring-1 focus:ring-primary"
                                               th:value="${profileDto.agency.agencyName}">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-500 mb-1">대표자</label>
                                        <input type="text" id="editAgencyOwner"
                                               class="w-full px-4 py-2 border border-gray-300 rounded-button focus:border-primary focus:ring-1 focus:ring-primary"
                                               th:value="${profileDto.agency.agencyOwner}">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-500 mb-1">대표 전화</label>
                                        <input type="tel" id="editAgencyPhone"
                                               class="w-full px-4 py-2 border border-gray-300 rounded-button focus:border-primary focus:ring-1 focus:ring-primary"
                                               th:value="${profileDto.agency.agencyPhone}">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-500 mb-1">유학원 지역</label>
                                        <select id="editAgencyRegion" name="agencyRegion"
                                                class="w-full px-4 py-2 border border-gray-300 rounded-button focus:border-primary focus:ring-1 focus:ring-primary">
                                            <option value="">지역 선택</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-500 mb-1">이메일</label>
                                        <input type="email" id="editAgencyEmail"
                                               class="w-full px-4 py-2 border border-gray-300 rounded-button focus:border-primary focus:ring-1 focus:ring-primary"
                                               th:value="${profileDto.agency.agencyEmail}">
                                    </div>

                                    <div class="md:col-span-2">
                                        <div class="flex items-center justify-between mb-1">
                                            <label class="block text-sm font-medium text-gray-500">주소</label>
                                            <div class="flex items-center space-x-2 ml-auto">
                                                <button type="button"
                                                        class="whitespace-nowrap !rounded-button bg-blue-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 text-sm font-medium transition openChineseModal"
                                                        data-target="agency">
                                                    중국 주소 검색
                                                </button>

                                                <!-- ✅ 여기 버그 수정: member → agency -->
                                                <button type="button"
                                                        class="text-sm px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-button transition"
                                                        onclick="openPostcode('agency')">
                                                    한국 주소 검색
                                                </button>
                                            </div>
                                        </div>

                                        <input id="editAgencyAddress1"
                                               class="w-full px-4 py-2 border border-gray-300 rounded-button focus:border-primary focus:ring-1 focus:ring-primary"
                                               placeholder="기본 주소" th:value="${profileDto.agency.agencyAddress1}"
                                               readonly/>
                                        <input id="editAgencyAddress2"
                                               class="mt-2 w-full px-4 py-2 border border-gray-300 rounded-button focus:border-primary focus:ring-1 focus:ring-primary"
                                               placeholder="상세 주소" th:value="${profileDto.agency.agencyAddress2}"/>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                            <button id="cancelAgencyBtn"
                                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-button hover:bg-gray-50">
                                취소
                            </button>
                            <button id="saveAgencyBtn"
                                    class="px-4 py-2 bg-primary text-white rounded-button hover:bg-primary/90">
                                저장
                            </button>
                        </div>
                    </div>
                </div>

                <div id="agencySuccessToast"
                     class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-full opacity-0 transition-all duration-300 hidden">
                    유학원 정보가 성공적으로 업데이트되었습니다
                </div>
            </div>

            <!-- ... (중간 내용 동일) ... -->
            <!-- (이 아래 섹션들은 너 코드 그대로 두었음) -->
            <!-- 사업자등록증 / 대표사진 / 설문 기록 ... -->
        </section>

        <!-- 이하 전체 구조 동일 -->
        <!-- ... -->
    </main>

    <!-- postcode layer / chinese modal / scripts 그대로 -->
</div>

<div id="postcode-layer"
     class="hidden fixed left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 z-[9999] w-[360px] h-[480px] border border-gray-300 bg-white shadow-lg rounded-lg">
    <div class="flex justify-between items-center px-4 py-2 border-b border-gray-200">
        <h4 class="font-semibold text-gray-700">주소 검색</h4>
        <button id="closePostcode" onclick="closePostcode()" class="text-gray-500 hover:text-gray-700">
            <i class="ri-close-line ri-lg"></i>
        </button>
    </div>
    <div id="postcode-wrap" class="w-full h-[400px]"></div>
</div>

<div id="chinese-address-modal" class="hidden fixed left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2
            z-[9999] w-[400px] bg-white border border-gray-300 shadow-lg rounded-lg p-5">
    <div class="flex justify-between items-center mb-4 border-b pb-2">
        <h4 class="text-lg font-semibold text-gray-700">중국 주소 검색</h4>
        <button id="closeChineseModal" class="text-gray-500 hover:text-gray-700">
            <i class="ri-close-line ri-lg"></i>
        </button>
    </div>

    <input type="text" id="chineseAddressInput" placeholder="예: 上海市徐汇区漕溪北路333号"
           class="w-full border border-gray-300 rounded-button px-4 py-2 mb-3 focus:ring-2 focus:ring-primary outline-none"/>

    <ul id="chineseAddressList" class="border border-gray-200 rounded-lg max-h-60 overflow-y-auto hidden"></ul>
</div>

<script id="profileEditHandler" type="module">
    const editProfileBtn = document.getElementById("editProfileBtn");
    const editProfileModal = document.getElementById("editProfileModal");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const saveProfileBtn = document.getElementById("saveProfileBtn");
    const successToast = document.getElementById("successToast");

    editProfileBtn?.addEventListener("click", () => editProfileModal.classList.remove("hidden"));
    cancelEditBtn?.addEventListener("click", () => editProfileModal.classList.add("hidden"));

    // ✅ once 제거: 실패/재시도 시 버튼이 먹통되는 문제 방지
    saveProfileBtn?.addEventListener("click", async () => {
        const payload = {
            memberName: document.getElementById("editName")?.value?.trim() || null,
            birth: document.getElementById("editBirthdate")?.value || null,
            email: document.getElementById("editEmail")?.value?.trim() || null,
            homePhoneNumber: document.getElementById("editHomePhoneNum")?.value?.trim() || null,
            phoneNumber: document.getElementById("editPhoneNum")?.value?.trim() || null,
            address1: document.getElementById("editAddress1")?.value?.trim() || null,
            address2: document.getElementById("editAddress2")?.value?.trim() || null
        };

        try {
            saveProfileBtn.disabled = true;
            await window.api.patchJson("/profile/member", payload);
            editProfileModal.classList.add("hidden");
            successToast.classList.remove("hidden", "translate-y-full", "opacity-0");
            setTimeout(() => location.reload(), 800);
        } catch (e) {
            console.error(e);
        } finally {
            saveProfileBtn.disabled = false;
        }
    });

    window?.addEventListener("click", (e) => {
        if (e.target === editProfileModal) editProfileModal.classList.add("hidden");
    });
</script>

<script id="agencyEditHandler" type="module">
    const editAgencyBtn = document.getElementById("editAgencyBtn");
    const editAgencyModal = document.getElementById("editAgencyModal");
    const cancelAgencyBtn = document.getElementById("cancelAgencyBtn");
    const saveAgencyBtn = document.getElementById("saveAgencyBtn");
    const agencySuccessToast = document.getElementById("agencySuccessToast");

    // ✅ 요소 없을 때도 안 터지게
    editAgencyBtn?.addEventListener("click", () => editAgencyModal?.classList.remove("hidden"));
    cancelAgencyBtn?.addEventListener("click", () => editAgencyModal?.classList.add("hidden"));

    saveAgencyBtn?.addEventListener("click", async () => {
        const payload = {
            agencyOwner: document.getElementById("editAgencyOwner")?.value?.trim() || null,
            agencyName: document.getElementById("editAgencyName")?.value?.trim() || null,
            agencyPhone: document.getElementById("editAgencyPhone")?.value?.trim() || null,
            agencyRegion: document.getElementById("editAgencyRegion")?.value?.trim() || null,
            agencyEmail: document.getElementById("editAgencyEmail")?.value?.trim() || null,
            agencyAddress1: document.getElementById("editAgencyAddress1")?.value?.trim() || null,
            agencyAddress2: document.getElementById("editAgencyAddress2")?.value?.trim() || null
        };

        try {
            saveAgencyBtn.disabled = true;
            await window.api.patchJson("/profile/agency", payload);

            editAgencyModal?.classList.add("hidden");
            agencySuccessToast?.classList.remove("hidden", "translate-y-full", "opacity-0");
            setTimeout(() => location.reload(), 800);
        } catch (e) {
            console.error(e);
        } finally {
            saveAgencyBtn.disabled = false;
        }
    });

    window.addEventListener("click", (e) => {
        if (e.target === editAgencyModal) editAgencyModal?.classList.add("hidden");
    });
</script>

<script th:inline="javascript" type="module">
    // ✅ null-safe (agency 없는 유저도 페이지 렌더링 가능하게)
    const CURRENT_REGION = /*[[${profileDto?.agency?.agencyRegion}]]*/ '';

    async function populateAgencyRegions() {
        const sel = document.getElementById("editAgencyRegion");
        if (!sel) return;

        try {
            // ✅ api.get → window.api.get 통일
            const res = await window.api.get("/agency/region");

            const regions =
                Array.isArray(res) ? res :
                    Array.isArray(res?.data) ? res.data :
                        Array.isArray(res?.result) ? res.result : [];

            sel.innerHTML = '<option value="">지역 선택</option>';

            regions.forEach(label => {
                const opt = document.createElement("option");
                opt.value = label;
                opt.textContent = label;
                sel.appendChild(opt);
            });

            if (CURRENT_REGION) {
                sel.value = CURRENT_REGION;
                if (sel.value !== CURRENT_REGION) {
                    const opt = document.createElement("option");
                    opt.value = CURRENT_REGION;
                    opt.textContent = `${CURRENT_REGION}`;
                    opt.selected = true;
                    sel.appendChild(opt);
                }
            }
        } catch (e) {
            console.error("지역 목록 조회 실패:", e);
        }
    }

    // ✅ 페이지 로드 시 1회만 채워두기(모달 열 때마다 중복 바인딩/중복 fetch 방지)
    populateAgencyRegions().then();
</script>

<!-- 아래 스크립트들은 너 원본 그대로 둠 -->
<script type="module">
    const BASE = "/api/v1/profile";
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute("content");
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute("content");
    const toast = document.getElementById("profileToast");

    const wirePatchUpload = ({
                                 openBtnIds = [],
                                 modalId,
                                 closeBtnId,
                                 formId,
                                 fileInputId,
                                 previewId,
                                 endpoint,
                                 fileFieldName,
                                 acceptPdf = false
                             }) => {
        const modal = document.getElementById(modalId);
        const close = document.getElementById(closeBtnId);
        const form = document.getElementById(formId);
        const fileInp = document.getElementById(fileInputId);
        const preview = document.getElementById(previewId);

        openBtnIds.map(id => document.getElementById(id))
            .filter(Boolean)
            .forEach(btn => btn.addEventListener("click", () => {
                modal.classList.remove("hidden");
                modal.classList.add("flex");
                preview.classList.add("hidden");
                preview.innerHTML = "";
                form.reset();
            }));

        const closeModal = () => {
            modal.classList.add("hidden");
            modal.classList.remove("flex");
        };
        close?.addEventListener("click", closeModal);
        modal?.addEventListener("click", e => {
            if (e.target === modal) closeModal();
        });

        fileInp?.addEventListener("change", () => {
            const file = fileInp.files?.[0];
            if (!file) {
                preview.classList.add("hidden");
                preview.innerHTML = "";
                return;
            }
            preview.classList.remove("hidden");
            preview.innerHTML = "";
            const isImage = /^image\//.test(file.type);
            if (isImage) {
                const img = document.createElement("img");
                img.className = "max-h-full max-w-full object-contain";
                img.alt = "미리보기";
                const fr = new FileReader();
                fr.onload = () => (img.src = fr.result);
                fr.readAsDataURL(file);
                preview.appendChild(img);
            } else {
                const box = document.createElement("div");
                box.className = "flex flex-col items-center justify-center text-gray-500";
                box.innerHTML = '<i class="ri-file-pdf-2-line text-5xl mb-2"></i><span class="text-sm">PDF 문서</span>';
                preview.appendChild(box);
            }
        });

        form?.addEventListener("submit", async (e) => {
            e.preventDefault();
            const file = fileInp.files?.[0];
            if (!file) { alert("파일을 선택해주세요."); return; }
            if (file.size > 10 * 1024 * 1024) { alert("최대 10MB까지 업로드 가능합니다."); return; }
            if (!acceptPdf && !/^image\//.test(file.type)) { alert("이미지 파일만 업로드할 수 있습니다."); return; }
            if (acceptPdf && !(/^image\//.test(file.type) || file.type === "application/pdf")) {
                alert("이미지 또는 PDF만 업로드할 수 있습니다."); return;
            }

            const fd = new FormData();
            fd.append(fileFieldName, file);

            try {
                await window.api.patchMultipart(endpoint, fd);
                closeModal();
                showToast("업데이트되었습니다.");
                location.reload();
            } catch (err) {
                console.error("업로드 실패:", err);
            }
        });
    };

    function showToast(msg) {
        if (msg) toast.textContent = msg;
        toast.classList.remove("hidden");
        requestAnimationFrame(() => toast.classList.remove("translate-y-full", "opacity-0"));
        setTimeout(() => {
            toast.classList.add("translate-y-full", "opacity-0");
            setTimeout(() => toast.classList.add("hidden"), 300);
        }, 2000);
    }

    wirePatchUpload({
        openBtnIds: ["openBizCertModal", "openBizCertModal__empty"],
        modalId: "bizCertModal",
        closeBtnId: "closeBizCertModal",
        formId: "bizCertForm",
        fileInputId: "bizCertFile",
        previewId: "bizCertPreview",
        endpoint: `/profile/businessCert`,
        fileFieldName: "businessCertificate",
        acceptPdf: true
    });

    wirePatchUpload({
        openBtnIds: ["openAgencyPicModal", "openAgencyPicModal__empty"],
        modalId: "agencyPicModal",
        closeBtnId: "closeAgencyPicModal",
        formId: "agencyPicForm",
        fileInputId: "agencyPicFile",
        previewId: "agencyPicPreview",
        endpoint: `/profile/agencyPicture`,
        fileFieldName: "agencyPicture",
        acceptPdf: false
    });
</script>

<script type="module">
    const addrEl = document.getElementById('editAddress1');
    const agencyAddrEl = document.getElementById('editAgencyAddress1');
    const layer = document.getElementById('postcode-layer');
    const wrap = document.getElementById('postcode-wrap');

    function openPostcode(type) {
        layer.classList.remove('hidden');
        new daum.Postcode({
            oncomplete: function (data) {
                const addr = data.roadAddress || data.jibunAddress;
                if (type === 'member') {
                    if (addrEl) addrEl.value = addr;
                    document.getElementById('editAddress2')?.focus();
                } else if (type === 'agency') {
                    if (agencyAddrEl) agencyAddrEl.value = addr;
                    document.getElementById('editAgencyAddress2')?.focus();
                }
                closePostcode();
            },
            width: '100%',
            height: '100%'
        }).embed(wrap);
    }

    function closePostcode() {
        layer.classList.add('hidden');
    }

    window.openPostcode = openPostcode;
    window.closePostcode = closePostcode;
</script>

<script id="chinese-address-modal-script" type="module">
    const modal = document.getElementById("chinese-address-modal");
    const closeBtn = document.getElementById("closeChineseModal");
    const input = document.getElementById("chineseAddressInput");
    const list = document.getElementById("chineseAddressList");

    const openBtns = document.querySelectorAll(".openChineseModal");
    let currentTarget = null;

    openBtns.forEach(btn => {
        btn.addEventListener("click", () => {
            currentTarget = btn.dataset.target;
            modal.classList.remove("hidden");
            input.value = "";
            list.innerHTML = "";
            list.classList.add("hidden");
            input.focus();
        });
    });

    closeBtn.addEventListener("click", () => {
        modal.classList.add("hidden");
        list.innerHTML = "";
        list.classList.add("hidden");
    });

    let debounceTimer;
    input.addEventListener("input", () => {
        const keyword = input.value.trim();
        if (!keyword) {
            list.classList.add("hidden");
            return;
        }
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => fetchSuggestions(keyword), 300);
    });

    async function fetchSuggestions(keyword) {
        const url = `/api/v1/tencent/address?keyword=${encodeURIComponent(keyword)}`;
        try {
            const resp = await fetch(url);
            const data = await resp.json();

            if (!data || !data.data || data.data.length === 0) {
                list.classList.add("hidden");
                return;
            }

            list.classList.remove("hidden");
            list.innerHTML = data.data
                .map((item, i) => `
                    <li data-index="${i}" class="px-3 py-2 hover:bg-gray-100 cursor-pointer border-b last:border-0">
                        <span class="font-medium">${item.title}</span>
                        <p class="text-sm text-gray-500">${item.address}</p>
                    </li>`)
                .join("");

            list.querySelectorAll("li").forEach(li => {
                li.addEventListener("click", () => {
                    const idx = li.dataset.index;
                    applyChineseAddress(data.data[idx]);
                });
            });
        } catch (err) {
            console.error("Tencent Suggestion API Error:", err);
        }
    }

    function applyChineseAddress(sel) {
        const addr1 = `${sel.province || ""} ${sel.city || ""} ${sel.district || ""}`.trim();
        const addr2 = `${sel.title || ""} ${sel.address || ""}`.trim();

        if (currentTarget === "address") {
            document.getElementById("editAddress1").value = addr1;
            document.getElementById("editAddress2").value = addr2;
        } else if (currentTarget === "agency") {
            document.getElementById("editAgencyAddress1").value = addr1;
            document.getElementById("editAgencyAddress2").value = addr2;
        }

        modal.classList.add("hidden");
        list.innerHTML = "";
        list.classList.add("hidden");
    }
</script>

</body>
</html>
