<!DOCTYPE html>
<html th:replace="~{fragments/layout/main-layout :: main-layout(~{::head}, ~{::body}, ~{::script})}"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>유학원 정보 - 유학 정보 플랫폼</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <style>
        :where([class^="ri-"])::before {
            content: "\f3c2";
        }
    </style>
</head>

<body>
<!-- 메인 컨텐츠 -->
<main>
    <!-- 헤더 섹션 -->
    <div class="bg-white shadow-sm">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">유학원 찾기</h1>
                    <p class="mt-2 text-lg text-gray-600">
                        전문적인 유학 상담을 제공하는 신뢰할 수 있는 유학원을
                        찾아보세요. </p>
                </div>
            </div>
        </div>
    </div>
    <!-- 필터 섹션 -->
    <div class="bg-white shadow-sm mt-4">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center space-x-4">
                <!-- 검색바 -->
                <div class="relative flex-grow">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <div class="w-5 h-5 text-gray-400 flex items-center justify-center">
                            <i class="ri-search-line"></i>
                        </div>
                    </div>
                    <input type="text" id="searchKeyword" th:placeholder="${keyword}"
                           class="pl-10 pr-4 py-2 w-full border border-gray-300 !rounded-button focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm"/>
                </div>
                <!-- 지역 필터 -->
                <div class="relative inline-block text-left" id="region-filter">
                    <button id="region-menu-button" type="button"
                            class="inline-flex justify-between items-center w-full px-4 py-2 border border-gray-300 !rounded-button bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        <span>지역</span>
                        <span class="w-5 h-5 ml-2 flex items-center justify-center">
                            <i class="ri-arrow-down-s-line"></i>
                        </span>
                    </button>
                    <div
                            class="hidden origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-10"
                            id="region-menu"
                    >
                        <div class="class= py-1 max-h-60 overflow-y-auto region-menu-list" role="none">
                            <button type="button" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">전체</button>
                        </div>
                    </div>
                </div>
                <div>
                    <!--                    검색 버튼-->
                    <button id="searchButton" type="submit"
                            class="bg-primary text-white px-4 py-2 rounded-button whitespace-nowrap flex items-center">
                        검색
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- 목록 보기 섹션 -->
    <div id="list-view" class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-6 flex justify-between items-center">
            <h2 class="text-xl font-semibold text-gray-900">
                총 <span class="text-primary" th:text="${agencyDto.totalElements}">0</span>개의 유학원 </h2>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <th:block th:each="agency : ${agencyDto}">
                <div th:replace="~{fragments/agency/agencyCard :: card(${agency})}"></div>
            </th:block>
        </div>

        <!--        <div th:replace="~{fragments/common/pagination :: pagination(page=${agencyDto}, maxButtons=5)}"></div>-->

        <!-- TODO: Pagination 컴포넌트 구현하기-->
        <div class="mt-8 flex justify-center items-center space-x-2" th:if="${agencyDto.totalPages > 0}">
            <!-- 이전 버튼 -->
            <a th:if="${agencyDto.hasPrevious()}" th:href="@{/agency/list(page=${agencyDto.number - 1})}"
               class="px-3 py-1 rounded border text-sm text-gray-700 hover:bg-gray-100">이전</a>

            <!-- 페이지 번호 -->
            <span th:each="pageNum : ${#numbers.sequence(0, agencyDto.totalPages - 1)}">
                <a th:href="@{/agency/list(page=${pageNum}, keyword=${keyword}, region=${region})}"
                   th:text="${pageNum + 1}" th:class="${pageNum == agencyDto.number} ?
                             'px-3 py-1 rounded bg-primary text-white text-sm' :
                             'px-3 py-1 rounded border text-sm text-gray-700 hover:bg-gray-100'">
                </a>
            </span>
            <!-- 다음 버튼 -->
            <a th:if="${agencyDto.hasNext()}" th:href="@{/agency/list(page=${agencyDto.number + 1})}"
               class="px-3 py-1 rounded border text-sm text-gray-700 hover:bg-gray-100">다음</a>
        </div>

    </div>
</main>

<script type="module" id="api-bootstrap">
    import { api } from "/js/homepage/lib/apiClient.js";
    window.api = api;
    window.dispatchEvent(new Event("api-ready"));
</script>

        <script id="region-dropdown-loader">
            (function () {
                let selectedRegion = "";

                async function initRegionFilter() {
                    const menu = document.getElementById("region-menu");
                    const menuButton = document.getElementById("region-menu-button");
                    const list = document.querySelector("#region-menu .region-menu-list");
                    const searchButton = document.getElementById("searchButton");
                    const keywordInput = document.getElementById("searchKeyword");

                    if (!menu || !menuButton || !list) {
                        console.warn("region filter 요소를 찾을 수 없습니다.");
                        return;
                    }

                    // 1) 드롭다운 열기/닫기 토글
                    menuButton.addEventListener("click", () => {
                        menu.classList.toggle("hidden");
                    });

                    // 2) ESC / 바깥 클릭 시 닫기 (선택)
                    document.addEventListener("click", (e) => {
                        if (!menu.contains(e.target) && !menuButton.contains(e.target)) {
                            menu.classList.add("hidden");
                        }
                    });

                    // 3) 지역 목록 API 호출
                    try {
                        const res = await window.api.get("/api/v1/agency/region");
                        console.log("region api result:", res);

                        const regions =
                            Array.isArray(res) ? res
                                : Array.isArray(res.data) ? res.data
                                    : Array.isArray(res.result) ? res.result
                                        : [];

                        list.innerHTML = ""; // 초기화
                        const btn = document.createElement("button");
                        btn.type = "button";
                        btn.className = "block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100";
                        btn.textContent = "전체";
                        list.appendChild(btn);
                        regions.forEach(region => {
                            const btn = document.createElement("button");
                            btn.type = "button";
                            btn.className = "block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100";
                            btn.textContent = region;
                            list.appendChild(btn);
                        });

                    } catch (e) {
                        console.error("지역 목록 불러오기 실패:", e);
                        return;
                    }



                    // 5) 버튼 클릭 시 선택값 반영 (이벤트 위임)
                    list.addEventListener("click", (e) => {
                        const target = e.target;
                        if (!target.matches("button")) return;

                        selectedRegion = target.textContent.trim();
                        const labelSpan = menuButton.querySelector("span");
                        if (labelSpan) {
                            labelSpan.textContent = selectedRegion;
                        }
                        menu.classList.add("hidden");
                    });

                    if (searchButton) {
                        searchButton.addEventListener("click", (e) => {
                            e.preventDefault();

                            const keyword = keywordInput?.value.trim() || "";
                            const params = new URLSearchParams();

                            if (keyword) params.append("keyword", keyword);
                            if (selectedRegion) params.append("region", selectedRegion);

                            window.location.href = `/agency/list?${params.toString()}`;
                        });
                    }

                }

                document.addEventListener("DOMContentLoaded", () => {
                    initRegionFilter();
                });
            })();
        </script>

</body>
</html>
