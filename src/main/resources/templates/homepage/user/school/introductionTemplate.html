<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout/university-layout :: university-layout(~{::head}, ~{::main}, ~{::script})}">
<head>
    <title th:text="${school}">大学介绍</title>
</head>

<main class="min-w-0 flex-1 py-6 px-0 md:px-6">
    <div th:replace="~{fragments/school/universityNavHeader :: universityNavHeader(${content.schoolDto.koreanName}+' 介绍')}"></div>

    <div th:replace="~{fragments/school/universityIntroSection :: universityIntroSection(
    ${content.intro.title},
    ${content.intro.description},
    ${content.intro.advantages},
    ${content.homepageUrl},
    ${content.englishPageUrl},
    ${content.intro.schoolPicUrl}
)}"></div>

    <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">

        <div th:replace="~{fragments/school/universityBasicInfo :: universityBasicInfo(
    ${content.schoolDto.koreanName},
    ${content.schoolDto.englishName},
    ${content.basicInfo.builtAt},
    ${content.basicInfo.location},
    ${#strings.arrayJoin(content.basicInfo.feature, ' / ')}
)}">
        </div>

        <div th:replace="~{fragments/school/universityInfoCard :: universityInfoCard(
          'QS 世界大学排名',
          ${content.collegeRank},
          'QS World University Rankings 2026',
          '',
          '* 以 TopUniversities 为准'
        )}"></div>

        <div th:replace="~{fragments/school/universityInfoCard :: universityLinkCard(
          '相关网站',
          ${content.homepageUrls.urlNames},
          ${content.homepageUrls.urls}
        )}"></div>
    </section>

    <!-- (옵션) 학과/프로그램 카드 미리보기: 필요 없으면 섹션 삭제 -->
    <section id="sejong-academics" class="bg-white rounded-lg shadow-sm p-6 mb-8">
        <!-- 헤더 + 검색 -->
        <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-900"
                th:text="|${content.schoolDto.koreanName} 本科院系/专业|">本科院系/专业</h2>
            <div class="w-full md:w-80 relative">
                <i class="ri-search-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input id="deptSearch" type="text" placeholder="搜索院系/专业"
                       class="w-full pl-10 pr-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"/>
            </div>
        </div>

        <!-- 단과대학 탭 (가로 스크롤) -->
        <div id="collegeFilters" class="flex items-center gap-2 overflow-x-auto pb-2 mb-6">

            <!-- 전체 버튼 -->
            <button data-filter="all"
                    class="px-3 py-1.5 rounded-full bg-primary text-white text-sm whitespace-nowrap">
                全部
            </button>

            <!-- 학사 단과대 자동 생성 -->
            <button th:each="college : ${content.colleges}"
                    th:if="${college.type == 'UNDERGRADUATE'}"
                    th:attr="data-filter=${college.collegeName}"
                    class="px-3 py-1.5 rounded-full bg-gray-100 text-gray-700 text-sm whitespace-nowrap hover:bg-gray-200"
                    th:text="${college.collegeName}">
            </button>

        </div>

        <div id="collegeGrid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-5">

            <article class="border rounded-xl p-5 hover:shadow-md transition group"
                     th:each="college : ${content.colleges}"
                     th:if="${college.type == 'UNDERGRADUATE'}"
                     th:attr="data-college=${college.collegeName}">

                <header class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold text-gray-900" th:text="${college.collegeName}">
                        学院名称
                    </h3>
                    <span class="text-xs text-gray-500" data-count
                          th:text="${#lists.size(college.departments)} + '个'">
                        —
                    </span>
                </header>

                <div class="flex flex-wrap gap-2" data-chips>
                    <span class="chip" data-dept
                          th:each="dept : ${college.departments}"
                          th:text="${dept}">
                        专业
                    </span>
                </div>

                <button class="show-more mt-3 hidden text-sm text-primary hover:underline" data-more>更多</button>
            </article>

        </div>
    </section>

    <!--        석박사 과-->
    <section id="sejong-graduate" class="bg-white rounded-lg shadow-sm p-6 mb-8">
        <!-- 헤더 + 검색 -->
        <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-900"
                th:text="|${content.schoolDto.koreanName} 研究生院系/学科|">研究生院系/学科</h2>
            <div class="w-full md:w-80 relative">
                <i class="ri-search-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input id="gradDeptSearch" type="text" placeholder="搜索研究生院系/学科"
                       class="w-full pl-10 pr-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"/>
            </div>
        </div>

        <!-- 단과대학 필터 -->
        <div id="gradCollegeFilters" class="flex items-center gap-2 overflow-x-auto pb-2 mb-6">

            <button data-filter="all"
                    class="px-3 py-1.5 rounded-full bg-primary text-white text-sm whitespace-nowrap">
                全部
            </button>

            <button th:each="college : ${content.colleges}"
                    th:if="${college.type == 'GRADUATE'}"
                    th:attr="data-filter=${college.collegeName}"
                    class="px-3 py-1.5 rounded-full bg-gray-100 text-gray-700 text-sm whitespace-nowrap hover:bg-gray-200"
                    th:text="${college.collegeName}">
            </button>

        </div>

        <!-- 카드 그리드 -->
        <div id="gradCollegeGrid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-5">

            <article class="border rounded-xl p-5 hover:shadow-md transition group"
                     th:each="college : ${content.colleges}"
                     th:if="${college.type == 'GRADUATE'}"
                     th:attr="data-college=${college.collegeName}">

                <header class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold text-gray-900" th:text="${college.collegeName}">
                        研究生学院
                    </h3>
                    <span class="text-xs text-gray-500" data-count
                          th:text="${#lists.size(college.departments)} + '个'">
                        —
                    </span>
                </header>

                <div class="flex flex-wrap gap-2" data-chips>
                    <span class="chip" data-dept
                          th:each="dept : ${college.departments}"
                          th:text="${dept}">
                        研究生学科
                    </span>
                </div>

                <button class="show-more mt-3 hidden text-sm text-primary hover:underline" data-more>更多</button>
            </article>

        </div>

    </section>

    <div th:replace="~{fragments/school/universityCampusMap :: universityCampus(
  '校区位置',
  ${content.mapLocationURl},
  ${content.basicInfo.location},
  ${content.mapUrl},
  '路线指南'
)}"></div>

</main>

<th:block th:fragment="script">
    <script type="module">
        const grid = document.getElementById('collegeGrid');
        const filters = document.getElementById('collegeFilters');
        const search = document.getElementById('deptSearch');

        // ✅ (한국어) 이 섹션이 제거되거나 요소가 렌더링되지 않은 경우, 아래 코드가 NPE로 터지지 않도록 방어합니다.
        if (!grid || !filters || !search) {
            // (한국어) 요소가 없으면 조용히 종료
            return;
        }

        const cards = Array.from(grid.querySelectorAll('article[data-college]'));

        // 칩 개수 > 10 이면 접기 처리
        cards.forEach(card => {
            const chipsWrap = card.querySelector('[data-chips]');
            const chips = Array.from(chipsWrap.querySelectorAll('.chip[data-dept]'));
            const moreBtn = card.querySelector('[data-more]');
            const countEl = card.querySelector('[data-count]');

            // 카운트 표시
            countEl.textContent = chips.length + '个';

            if (chips.length > 10) {
                chips.slice(10).forEach(ch => ch.classList.add('hidden'));
                moreBtn.classList.remove('hidden');
                moreBtn?.addEventListener('click', () => {
                    const hidden = chips.slice(10).some(ch => ch.classList.contains('hidden'));
                    chips.slice(10).forEach(ch => ch.classList.toggle('hidden'));
                    // (화면 문구만 중국어로 변경)
                    moreBtn.textContent = hidden ? '收起' : '更多';
                });
            }
        });

        function applyFilter() {
            const activeBtn = filters.querySelector('button.active');
            const collegeFilter = activeBtn ? activeBtn.dataset.filter : 'all';
            const q = (search.value || '').trim().toLowerCase();

            cards.forEach(card => {
                const college = card.dataset.college;
                const chips = Array.from(card.querySelectorAll('.chip[data-dept]'));
                // 검색
                let hitChip = false;
                chips.forEach(c => {
                    const match = c.textContent.toLowerCase().includes(q);
                    c.style.opacity = q ? (match ? '1' : '0.25') : '1';
                    if (match) hitChip = true;
                });
                // 카드 표시 조건
                const passCollege = (collegeFilter === 'all') || (collegeFilter === college);
                const passSearch = q ? hitChip : true;
                card.style.display = (passCollege && passSearch) ? '' : 'none';
            });
        }

        // 초기 active
        // ✅ (한국어) 기존 코드: filters?.querySelector(...).classList.add(...) 는 버튼이 없으면 터질 수 있어,
        //             querySelector 결과에도 ?. 를 붙여 안전하게 처리합니다.
        filters?.querySelector('button[data-filter="all"]')?.classList.add('active');

        // 탭 클릭
        filters?.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-filter]');
            if (!btn) return;
            filters.querySelectorAll('button').forEach(b => {
                b.classList.remove('active', 'bg-primary', 'text-white');
                b.classList.add('bg-gray-100', 'text-gray-700');
            });
            btn.classList.add('active', 'bg-primary', 'text-white');
            btn.classList.remove('bg-gray-100', 'text-gray-700');
            applyFilter();
        });

        // 검색
        search?.addEventListener('input', applyFilter);
    </script>

    <script type="module">
        //대학원 모듈
        const grid = document.getElementById('gradCollegeGrid');
        const filters = document.getElementById('gradCollegeFilters');
        const search = document.getElementById('gradDeptSearch');

        // ✅ (한국어) 요소가 없으면(섹션 삭제/미렌더링 등) NPE 방지
        if (!grid || !filters || !search) {
            return;
        }

        const cards = Array.from(grid.querySelectorAll('article[data-college]'));

        // chip 접기
        cards.forEach(card => {
            const chipsWrap = card.querySelector('[data-chips]');
            const chips = Array.from(chipsWrap.querySelectorAll('.chip[data-dept]'));
            const moreBtn = card.querySelector('[data-more]');
            const countEl = card.querySelector('[data-count]');

            countEl.textContent = chips.length + '个';

            if (chips.length > 10) {
                chips.slice(10).forEach(ch => ch.classList.add('hidden'));
                moreBtn.classList.remove('hidden');
                moreBtn?.addEventListener('click', () => {
                    const hidden = chips.slice(10).some(ch => ch.classList.contains('hidden'));
                    chips.slice(10).forEach(ch => ch.classList.toggle('hidden'));
                    // (화면 문구만 중국어로 변경)
                    moreBtn.textContent = hidden ? '收起' : '更多';
                });
            }
        });

        function applyFilter() {
            const activeBtn = filters.querySelector('button.active');
            const collegeFilter = activeBtn ? activeBtn.dataset.filter : 'all';
            const q = (search.value || '').trim().toLowerCase();

            cards.forEach(card => {
                const college = card.dataset.college;
                const chips = Array.from(card.querySelectorAll('.chip[data-dept]'));

                let hitChip = false;
                chips.forEach(c => {
                    const match = c.textContent.toLowerCase().includes(q);
                    c.style.opacity = q ? (match ? '1' : '0.25') : '1';
                    if (match) hitChip = true;
                });

                const passCollege = (collegeFilter === 'all') || (collegeFilter === college);
                const passSearch = q ? hitChip : true;
                card.style.display = (passCollege && passSearch) ? '' : 'none';
            });
        }

        // 초기 active
        // ✅ (한국어) querySelector 결과가 null일 때 classList 접근으로 터질 수 있어 ?. 를 추가합니다.
        filters?.querySelector('button[data-filter="all"]')?.classList.add('active');

        // 탭 클릭
        filters?.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-filter]');
            if (!btn) return;

            filters.querySelectorAll('button').forEach(b => {
                b.classList.remove('active', 'bg-primary', 'text-white');
                b.classList.add('bg-gray-100', 'text-gray-700');
            });

            btn.classList.add('active', 'bg-primary', 'text-white');
            btn.classList.remove('bg-gray-100', 'text-gray-700');
            applyFilter();
        });

        // 검색 바인딩
        search?.addEventListener('input', applyFilter);
    </script>
</th:block>
</html>
