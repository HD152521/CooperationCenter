<!DOCTYPE html>
<html th:replace="~{fragments/layout/main-layout :: main-layout(~{::head}, ~{::body}, ~{::script})}"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ìœ í•™ì› íšŒì›ê°€ì…</title>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <!--    ì¤‘êµ­ ì£¼ì†Œ ê²€ìƒ‰-->
    <script src="https://map.qq.com/api/js?v=2.exp&key=DC7BZ-EPNWL-3R6PE-MFU2I-VCHAO-FUB4R"></script>
    <style>
        :where([class^="ri-"])::before {
            content: "\f3c2";
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .password-strength-meter {
            height: 4px;
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 2px;
            margin-top: 4px;
        }

        .password-strength-meter div {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .file-drop-area {
            border: 2px dashed #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .file-drop-area.drag-over {
            border-color: #4F46E5;
            background-color: rgba(79, 70, 229, 0.05);
        }

        .preview-image {
            max-height: 150px;
            max-width: 100%;
            object-fit: contain;
            margin-top: 1rem;
        }
    </style>
    <!--    ì£¼ì†Œ ê²€ìƒ‰ ìŠ¤íƒ€ì¼-->
    <style>
        label {
            display: block;
            margin: 8px 0 4px
        }

        input {
            width: 100%;
            padding: 8px
        }

        #postcode-layer {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            width: 360px;
            height: 480px;
            border: 1px solid #ccc;
            background: #fff
        }

        #close {
            position: absolute;
            right: 8px;
            top: 8px;
            cursor: pointer
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
<div class="max-w-4xl mx-auto p-6 md:p-8">
    <div class="bg-white rounded-lg shadow-md p-6 md:p-8 mb-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">ìœ í•™ì› íšŒì›ê°€ì…</h1>
            <p class="text-gray-600 mt-2">
                ìœ í•™ì› ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•œ íšŒì›ê°€ì… ì–‘ì‹ì…ë‹ˆë‹¤. </p>
        </div>
        <form id="signupForm" action="/api/v1/member/signup" method="POST" class="space-y-8">

            <!-- ëŒ€í‘œì ì •ë³´ ì„¹ì…˜ -->
            <h2 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200">ì‚¬ìš©ì ì •ë³´ </h2>
            <div th:replace="~{fragments/member/userSignup :: userSignup}"></div>

            <!-- ìœ í•™ì› ì •ë³´ ì„¹ì…˜ -->
<!--            <h2 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200">ìœ í•™ì› ì •ë³´ </h2>-->
            <div class="flex items-center justify-between mb-4 pb-2 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800">
                    ìœ í•™ì› ì •ë³´
                </h2>

                <div class="inline-flex rounded-lg overflow-hidden border border-gray-200 bg-gray-50 text-sm">
                    <button
                            type="button"
                            class="px-3 py-1.5 font-medium text-gray-700 bg-white"
                            data-agency-mode="existing"
                    >
                        ê¸°ì¡´ ìœ í•™ì› ê°€ì…
                    </button>
                    <button
                            type="button"
                            class="px-3 py-1.5 font-medium text-gray-500 hover:text-gray-700"
                            data-agency-mode="new"
                    >
                        ìƒˆ ìœ í•™ì› ë“±ë¡
                    </button>
                </div>
            </div>

            <div id="agency-existing-section">
                <div th:replace="~{fragments/member/agencyAlreadySignup :: agencyAlreadySignup}"></div>
            </div>

            <div id="agency-new-section" class="hidden">
                <div th:replace="~{fragments/member/agencySignup :: agencySignup}"></div>
            </div>




            <div class="space-y-3">
                <div class="flex items-center">
                    <div class="relative w-5 h-5 mr-2">
                        <input type="checkbox" id="agreeAll" class="sr-only"/>
                        <div class="w-5 h-5 border border-gray-300 rounded cursor-pointer flex items-center justify-center"
                             id="agreeAllBox">
                            <i class="ri-check-line text-white hidden"></i>
                        </div>
                    </div>
                    <label for="agreeAll" class="text-sm font-medium text-gray-800 cursor-pointer">ì „ì²´ ë™ì˜</label>
                </div>
                <div class="ml-7 space-y-2">
                    <div class="flex items-center">
                        <div class="relative w-5 h-5 mr-2">
                            <input type="checkbox" id="agreeTerms" name="agreeTerms" required class="sr-only"/>
                            <div class="w-5 h-5 border border-gray-300 rounded cursor-pointer flex items-center justify-center"
                                 id="agreeTermsBox">
                                <i class="ri-check-line text-white hidden"></i>
                            </div>
                        </div>
                        <label for="agreeTerms" class="text-sm text-gray-700 cursor-pointer">ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€ ë™ì˜
                            <span class="text-red-500">*</span></label>
                        <button type="button" class="ml-auto text-xs text-gray-500 underline">
                            ë³´ê¸°
                        </button>
                    </div>
                    <div class="flex items-center">
                        <div class="relative w-5 h-5 mr-2">
                            <input type="checkbox" id="agreePrivacy" name="agreePrivacy" required class="sr-only"/>
                            <div class="w-5 h-5 border border-gray-300 rounded cursor-pointer flex items-center justify-center"
                                 id="agreePrivacyBox">
                                <i class="ri-check-line text-white hidden"></i>
                            </div>
                        </div>
                        <label for="agreePrivacy" class="text-sm text-gray-700 cursor-pointer">ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜
                            <span class="text-red-500">*</span></label>
                        <button type="button" class="ml-auto text-xs text-gray-500 underline">
                            ë³´ê¸°
                        </button>
                    </div>
                    <div class="flex items-center">
                        <div class="relative w-5 h-5 mr-2">
                            <input type="checkbox" id="agreeMarketing" name="agreeMarketing" class="sr-only"/>
                            <div class="w-5 h-5 border border-gray-300 rounded cursor-pointer flex items-center justify-center"
                                 id="agreeMarketingBox">
                                <i class="ri-check-line text-white hidden"></i>
                            </div>
                        </div>
                        <label for="agreeMarketing" class="text-sm text-gray-700 cursor-pointer">ë§ˆì¼€íŒ… ì •ë³´ ìˆ˜ì‹  ë™ì˜
                            (ì„ íƒ)</label>
                    </div>
                </div>
            </div>
            <!-- ë²„íŠ¼ ì˜ì—­ -->
            <div class="flex justify-center gap-4 pt-4">
                <button type="button" id="cancelButton"
                        class="whitespace-nowrap !rounded-button bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 font-medium transition min-w-[120px]">
                    ì·¨ì†Œ
                </button>
                <button type="submit" id="submitButton"
                        class="whitespace-nowrap !rounded-button bg-primary hover:bg-primary/90 text-white px-6 py-3 font-medium transition min-w-[120px]">
                    íšŒì›ê°€ì…
                </button>
            </div>
        </form>
    </div>
</div>

<div id="postcode-layer"
     class="hidden fixed left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 z-[9999] w-[360px] h-[480px] border border-gray-300 bg-white shadow-lg rounded-lg">
    <div class="flex justify-between items-center px-4 py-2 border-b border-gray-200">
        <h4 class="font-semibold text-gray-700">ì£¼ì†Œ ê²€ìƒ‰</h4>
        <button id="closePostcode" onclick="closePostcode()" class="text-gray-500 hover:text-gray-700">
            <i class="ri-close-line ri-lg"></i>
        </button>
    </div>
    <div id="postcode-wrap" class="w-full h-[400px]"></div>
</div>


<!--ì¤‘êµ­ ì£¼ì†Œ ê²€ìƒ‰-->
<div id="chinese-address-modal" class="hidden fixed left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2
            z-[9999] w-[400px] bg-white border border-gray-300 shadow-lg rounded-lg p-5">
    <div class="flex justify-between items-center mb-4 border-b pb-2">
        <h4 class="text-lg font-semibold text-gray-700">ì¤‘êµ­ ì£¼ì†Œ ê²€ìƒ‰</h4>
        <button id="closeChineseModal" class="text-gray-500 hover:text-gray-700">
            <i class="ri-close-line ri-lg"></i>
        </button>
    </div>

    <input type="text" id="chineseAddressInput" placeholder="ì˜ˆ: ä¸Šæµ·å¸‚å¾æ±‡åŒºæ¼•æºªåŒ—è·¯333å·"
           class="w-full border border-gray-300 rounded-button px-4 py-2 mb-3 focus:ring-2 focus:ring-primary outline-none"/>

    <ul id="chineseAddressList" class="border border-gray-200 rounded-lg max-h-60 overflow-y-auto hidden"></ul>
</div>
</body>

<th:block th:fragment="script">
    <script id="passwordToggleScript" type="module">
        const togglePassword = document.getElementById("togglePassword");
        const toggleConfirmPassword = document.getElementById(
            "toggleConfirmPassword",
        );
        const passwordInput = document.getElementById("password");
        const confirmPasswordInput = document.getElementById("confirmPassword");
        togglePassword?.addEventListener("click", function () {
            const type =
                passwordInput.getAttribute("type") === "password" ? "text" : "password";
            passwordInput.setAttribute("type", type);
            togglePassword.innerHTML =
                type === "password"
                    ? '<i class="ri-eye-line"></i>'
                    : '<i class="ri-eye-off-line"></i>';
        });
        toggleConfirmPassword?.addEventListener("click", function () {
            const type =
                confirmPasswordInput.getAttribute("type") === "password"
                    ? "text"
                    : "password";
            confirmPasswordInput.setAttribute("type", type);
            toggleConfirmPassword.innerHTML =
                type === "password"
                    ? '<i class="ri-eye-line"></i>'
                    : '<i class="ri-eye-off-line"></i>';
        });
    </script>
    <script id="passwordStrengthScript" type="module">
        const passwordInput = document.getElementById("password");
        const confirmPasswordInput = document.getElementById("confirmPassword");
        const passwordStrength = document.getElementById("passwordStrength");
        const passwordStrengthText = document.getElementById("passwordStrengthText");
        const passwordMatch = document.getElementById("passwordMatch");
        passwordInput?.addEventListener("input", function () {
            const password = passwordInput.value;
            let strength = 0;
            let message = "";
            if (password.length >= 8) strength += 25;
            if (password.match(/[a-z]+/)) strength += 25;
            if (password.match(/[A-Z]+/)) strength += 25;
            if (password.match(/[0-9]+/)) strength += 25;
            if (password.match(/[^a-zA-Z0-9]+/)) strength += 25;
            passwordStrength.style.width = `${Math.min(strength, 100)}%`;
            if (strength < 25) {
                passwordStrength.className = "bg-red-500";
                message = "ë§¤ìš° ì•½í•¨";
            } else if (strength < 50) {
                passwordStrength.className = "bg-orange-500";
                message = "ì•½í•¨";
            } else if (strength < 75) {
                passwordStrength.className = "bg-yellow-500";
                message = "ë³´í†µ";
            } else {
                passwordStrength.className = "bg-green-500";
                message = "ê°•í•¨";
            }
            passwordStrengthText.textContent = `ë¹„ë°€ë²ˆí˜¸ ê°•ë„: ${message} (ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì¡°í•© 8ìë¦¬ ì´ìƒ)`;
            // ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ ì—¬ë¶€ í™•ì¸
            checkPasswordMatch();
        });
        confirmPasswordInput?.addEventListener("input", checkPasswordMatch);

        function checkPasswordMatch() {
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            if (confirmPassword === "") {
                passwordMatch.textContent = "";
                passwordMatch.className = "mt-1 text-sm";
            } else if (password === confirmPassword) {
                passwordMatch.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.";
                passwordMatch.className = "mt-1 text-sm text-green-600";
            } else {
                passwordMatch.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                passwordMatch.className = "mt-1 text-sm text-red-600";
            }
        }
    </script>
    <script id="fileUploadScript" type="module">
        // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
        const imageDropArea = document.getElementById("imageDropArea");
        const agencyImage = document.getElementById("agencyImage");
        const imagePreviewContainer = document.getElementById(
            "imagePreviewContainer",
        );
        const imagePreview = document.getElementById("imagePreview");
        const removeImage = document.getElementById("removeImage");
        // ì‚¬ì—…ì ë“±ë¡ì¦ ì—…ë¡œë“œ ì²˜ë¦¬
        const licenseDropArea = document.getElementById("licenseDropArea");
        const businessLicense = document.getElementById("businessLicense");
        const licenseFileInfo = document.getElementById("licenseFileInfo");
        const licenseFileName = document.getElementById("licenseFileName");
        const licenseFileSize = document.getElementById("licenseFileSize");
        const removeLicense = document.getElementById("removeLicense");

        // ì´ë¯¸ì§€ íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜
        function handleImageFile(file) {
            if (file) {
                // íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬
                const validTypes = ["image/jpeg", "image/png", "image/gif"];
                const maxSize = 5 * 1024 * 1024; // 5MB
                if (!validTypes.includes(file.type)) {
                    alert("JPG, PNG, GIF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                    return;
                }
                if (file.size > maxSize) {
                    alert("íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
                    return;
                }
                // ë¯¸ë¦¬ë³´ê¸° ìƒì„±
                const reader = new FileReader();
                reader.onload = function (e) {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove("hidden");
                };
                reader.readAsDataURL(file);
            }
        }

        // ì‚¬ì—…ì ë“±ë¡ì¦ íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜
        function handleLicenseFile(file) {
            if (file) {
                // íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬
                const validTypes = ["application/pdf", "image/jpeg", "image/png"];
                const maxSize = 10 * 1024 * 1024; // 10MB
                if (!validTypes.includes(file.type)) {
                    alert("PDF, JPG, PNG íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                    return;
                }
                if (file.size > maxSize) {
                    alert("íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
                    return;
                }
                // íŒŒì¼ ì •ë³´ í‘œì‹œ
                licenseFileName.textContent = file.name;
                licenseFileSize.textContent = formatFileSize(file.size);
                licenseFileInfo.classList.remove("hidden");
            }
        }

        // íŒŒì¼ í¬ê¸° í¬ë§·íŒ…
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + " B";
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + " KB";
            else return (bytes / 1048576).toFixed(1) + " MB";
        }

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì´ë²¤íŠ¸
        agencyImage?.addEventListener("change", function (e) {
            handleImageFile(this.files[0]);
        });
        // ì´ë¯¸ì§€ ë“œë˜ê·¸ ì•¤ ë“œë¡­
        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
            imageDropArea?.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ["dragenter", "dragover"].forEach((eventName) => {
            imageDropArea?.addEventListener(
                eventName,
                function () {
                    imageDropArea.classList.add("drag-over");
                },
                false,
            );
        });
        ["dragleave", "drop"].forEach((eventName) => {
            imageDropArea?.addEventListener(
                eventName,
                function () {
                    imageDropArea.classList.remove("drag-over");
                },
                false,
            );
        });
        imageDropArea?.addEventListener(
            "drop",
            function (e) {
                const file = e.dataTransfer.files[0];
                agencyImage.files = e.dataTransfer.files;
                handleImageFile(file);
            },
            false,
        );
        // ì´ë¯¸ì§€ ì œê±°
        removeImage?.addEventListener("click", function () {
            agencyImage.value = "";
            imagePreview.src = "#";
            imagePreviewContainer.classList.add("hidden");
        });
        // ì‚¬ì—…ì ë“±ë¡ì¦ ì—…ë¡œë“œ ì´ë²¤íŠ¸
        businessLicense?.addEventListener("change", function (e) {
            handleLicenseFile(this.files[0]);
        });
        // ì‚¬ì—…ì ë“±ë¡ì¦ ë“œë˜ê·¸ ì•¤ ë“œë¡­
        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
            licenseDropArea?.addEventListener(eventName, preventDefaults, false);
        });
        ["dragenter", "dragover"].forEach((eventName) => {
            licenseDropArea.addEventListener(
                eventName,
                function () {
                    licenseDropArea.classList.add("drag-over");
                },
                false,
            );
        });
        ["dragleave", "drop"].forEach((eventName) => {
            licenseDropArea.addEventListener(
                eventName,
                function () {
                    licenseDropArea.classList.remove("drag-over");
                },
                false,
            );
        });
        licenseDropArea.addEventListener(
            "drop",
            function (e) {
                const file = e.dataTransfer.files[0];
                businessLicense.files = e.dataTransfer.files;
                handleLicenseFile(file);
            },
            false,
        );
        // ì‚¬ì—…ì ë“±ë¡ì¦ ì œê±°
        removeLicense.addEventListener("click", function () {
            businessLicense.value = "";
            licenseFileInfo.classList.add("hidden");
        });
    </script>
    <script id="checkboxScript" type="module">
        const agreeAll = document.getElementById("agreeAll");
        const agreeAllBox = document.getElementById("agreeAllBox");
        const agreeTerms = document.getElementById("agreeTerms");
        const agreeTermsBox = document.getElementById("agreeTermsBox");
        const agreePrivacy = document.getElementById("agreePrivacy");
        const agreePrivacyBox = document.getElementById("agreePrivacyBox");
        const agreeMarketing = document.getElementById("agreeMarketing");
        const agreeMarketingBox = document.getElementById("agreeMarketingBox");

        // ì²´í¬ë°•ìŠ¤ í† ê¸€ í•¨ìˆ˜
        function toggleCheckbox(checkbox, box) {
            checkbox.checked = !checkbox.checked;
            updateCheckboxStyle(checkbox, box);
        }

        // ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        function updateCheckboxStyle(checkbox, box) {
            if (checkbox.checked) {
                box.classList.add("bg-primary", "border-primary");
                box.querySelector("i").classList.remove("hidden");
            } else {
                box.classList.remove("bg-primary", "border-primary");
                box.querySelector("i").classList.add("hidden");
            }
        }

        // ì „ì²´ ë™ì˜ ì—…ë°ì´íŠ¸
        function updateAgreeAll() {
            const allChecked =
                agreeTerms.checked && agreePrivacy.checked && agreeMarketing.checked;
            agreeAll.checked = allChecked;
            updateCheckboxStyle(agreeAll, agreeAllBox);
        }

        // ê°œë³„ ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸
        function updateIndividualCheckboxes() {
            agreeTerms.checked = agreeAll.checked;
            agreePrivacy.checked = agreeAll.checked;
            agreeMarketing.checked = agreeAll.checked;
            updateCheckboxStyle(agreeTerms, agreeTermsBox);
            updateCheckboxStyle(agreePrivacy, agreePrivacyBox);
            updateCheckboxStyle(agreeMarketing, agreeMarketingBox);
        }

        // ì „ì²´ ë™ì˜ í´ë¦­ ì´ë²¤íŠ¸
        agreeAllBox.addEventListener("click", function () {
            toggleCheckbox(agreeAll, agreeAllBox);
            updateIndividualCheckboxes();
        });
        // ê°œë³„ ì²´í¬ë°•ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸
        agreeTermsBox.addEventListener("click", function () {
            toggleCheckbox(agreeTerms, agreeTermsBox);
            updateAgreeAll();
        });
        agreePrivacyBox.addEventListener("click", function () {
            toggleCheckbox(agreePrivacy, agreePrivacyBox);
            updateAgreeAll();
        });
        agreeMarketingBox.addEventListener("click", function () {
            toggleCheckbox(agreeMarketing, agreeMarketingBox);
            updateAgreeAll();
        });
    </script>
    <script id="search-address" type="module">
        // ì£¼ì†Œ ê²€ìƒ‰ (ëŒ€í‘œì)
        const zoneEl = document.getElementById('address');
        const addrEl = document.getElementById('address1');

        const agencyZoneEl = document.getElementById('agencyAddress');
        const agencyAddrEl = document.getElementById('agencyAddress1');

        const layer = document.getElementById('postcode-layer');
        const wrap = document.getElementById('postcode-wrap');

        function openPostcode(type) {
            layer.style.display = 'block';
            new daum.Postcode({
                oncomplete: function (data) {
                    // ë„ë¡œëª…(data.roadAddress) / ì§€ë²ˆ(data.jibunAddress)
                    const addr = data.roadAddress || data.jibunAddress;
                    if ('member' === type) {
                        zoneEl.value = data.zonecode;
                        addrEl.value = addr;
                        document.getElementById('address2').focus();
                    } else if ('agency' === type) {
                        agencyZoneEl.value = data.zonecode;
                        agencyAddrEl.value = addr;
                        document.getElementById('agencyAddress2').focus();
                    }

                    closePostcode();
                },
                width: '100%',
                height: '100%'
            }).embed(wrap);
        }

        function closePostcode() {
            layer.style.display = 'none';
        }

        // export module functions
        window.openPostcode = openPostcode;
        window.closePostcode = closePostcode;
    </script>

    <script id="checkAgencySignup">
        document.addEventListener("DOMContentLoaded", function () {
            const buttons = document.querySelectorAll("[data-agency-mode]");
            const existingSection = document.getElementById("agency-existing-section");
            const newSection = document.getElementById("agency-new-section");

            function setActive(mode) {
                buttons.forEach(btn => {
                    const isActive = btn.dataset.agencyMode === mode;
                    if (isActive) {
                        btn.classList.remove("text-gray-500", "bg-gray-50");
                        btn.classList.add("text-blue-600", "bg-white");
                    } else {
                        btn.classList.remove("text-blue-600", "bg-white");
                        btn.classList.add("text-gray-500", "bg-gray-50");
                    }
                });

                if (mode === "existing") {
                    existingSection.classList.remove("hidden");
                    newSection.classList.add("hidden");
                } else {
                    existingSection.classList.add("hidden");
                    newSection.classList.remove("hidden");
                }
            }

            // ê¸°ë³¸ê°’: ê¸°ì¡´ ìœ í•™ì› ê°€ì…
            setActive("existing");

            buttons.forEach(btn => {
                btn.addEventListener("click", () => {
                    setActive(btn.dataset.agencyMode);
                });
            });
        });
    </script>

    <script id="formSubmitScript" type="module">
        const form = document.getElementById("signupForm");
        const submitButton = document.getElementById("submitButton");
        const cancelButton = document.getElementById("cancelButton");
        // ì•„ì´ë”” ì¤‘ë³µ í™•ì¸
        let isUsernameChecked = false;

        document
            .getElementById("checkUsername")
            .addEventListener("click", function () {
                const username = document.getElementById("email").value;
                const usernameStatus = document.getElementById("usernameStatus");
                isUsernameChecked = false;

                if (!username) {
                    usernameStatus.textContent = "ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                    usernameStatus.className = "mt-1 text-sm text-red-600";
                    return;
                }

                // ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì‚¬
                const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                if (!emailRegex.test(username)) {
                    usernameStatus.textContent = "ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.";
                    usernameStatus.className = "mt-1 text-sm text-red-600";
                    return;
                }
                // ì—¬ê¸°ì„œëŠ” ì‹¤ì œ API í˜¸ì¶œ ëŒ€ì‹  ì‹œë®¬ë ˆì´ì…˜
                setTimeout(() => {
                    (async () => {
                        try {
                            const data = await api.get(
                                `${memberUrl}/check-id?username=${encodeURIComponent(username)}`
                            ); // BaseURL ì´ë¯¸ ì„¤ì •ëœ ê°€ì •
                            // ì„œë²„ê°€ {isSuccess:true,result:boolean} ë˜ëŠ” boolean ë‘˜ ë‹¤ ëŒ€ì‘
                            const isDuplicate =
                                data && typeof data === "object" && "result" in data ? data.result : !!data;

                            console.log(isDuplicate);
                            if (isDuplicate) {
                                usernameStatus.textContent = "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.";
                                usernameStatus.className = "mt-1 text-sm text-red-600";
                            } else {
                                usernameStatus.textContent = "ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤.";
                                isUsernameChecked = true;
                                usernameStatus.className = "mt-1 text-sm text-green-600";
                            }
                        } catch (error) {
                            console.error("ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜:", error);
                            usernameStatus.textContent = "ì¤‘ë³µ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                            usernameStatus.className = "mt-1 text-sm text-gray-500";
                        }
                    })();
                }, 100);
            });

        // ì·¨ì†Œ ë²„íŠ¼
        cancelButton.addEventListener("click", function () {
            if (
                confirm("íšŒì›ê°€ì…ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì…ë ¥í•œ ì •ë³´ëŠ” ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            ) {
                Turbo.visit("/"); // ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
            }
        });
        // í¼ ì œì¶œ
        form.addEventListener("submit", async function (e) {
            e.preventDefault();
            if (!isUsernameChecked) {
                alert("ì•„ì´ë”” ì¤‘ë³µ í™•ì¸ì„ ë¨¼ì € í•´ì£¼ì„¸ìš”.");
                return;
            }

            // í•„ìˆ˜ ì…ë ¥ í•„ë“œ ê²€ì‚¬
            const requiredFields = form.querySelectorAll("[required]");
            let isValid = true;
            requiredFields.forEach((field) => {
                if (!field.value) {
                    isValid = false;
                    field.classList.add("border-red-500");
                } else {
                    field.classList.remove("border-red-500");
                }
            });
            // ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ í™•ì¸
            const password = document.getElementById("password").value;
            const confirmPassword = document.getElementById("confirmPassword").value;
            if (password !== confirmPassword) {
                isValid = false;
                document
                    .getElementById("confirmPassword")
                    .classList.add("border-red-500");
                document.getElementById("passwordMatch").textContent =
                    "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                document.getElementById("passwordMatch").className =
                    "mt-1 text-sm text-red-600";
            }
            // ì•½ê´€ ë™ì˜ í™•ì¸
            const agreeTerms = document.getElementById("agreeTerms");
            const agreePrivacy = document.getElementById("agreePrivacy");
            if (!agreeTerms.checked || !agreePrivacy.checked) {
                isValid = false;
                const modal = document.createElement("div");
                modal.className = "fixed inset-0 flex items-center justify-center z-50";
                modal.innerHTML = `
                  <div class="fixed inset-0 bg-black opacity-50"></div>
                  <div class="bg-white rounded-lg p-6 relative z-10 max-w-sm w-full mx-4">
                  <h3 class="text-lg font-medium text-gray-900 mb-4">ì•Œë¦¼</h3>
                  <p class="text-gray-500 mb-6">í•„ìˆ˜ ì•½ê´€ì— ë™ì˜í•´ì£¼ì„¸ìš”.</p>
                  <button class="w-full !rounded-button bg-primary hover:bg-primary/90 text-white px-4 py-2 font-medium transition">í™•ì¸</button>
                  </div>
                  `;
                document.body.appendChild(modal);
                modal.querySelector("button").onclick = () => modal.remove();
                return;
            }
            console.log(isValid);

            if (isValid) {
                try {
                    submitButton.disabled = true;
                    submitButton.innerHTML =
                        '<i class="ri-loader-4-line animate-spin mr-2"></i> ì²˜ë¦¬ ì¤‘...';
                    console.log("Submitë²„íŠ¼ ë³€í™˜");


                    const jsonData = {
                        memberName: form.name.value,
                        email: form.email.value,
                        password: form.password.value,
                        homePhoneNumber: form.telNum.value,
                        phoneNumber: form.mobile.value,
                        address1: form.address1.value,
                        address2: form.address2.value,
                        agencyName: form.agencyName.value,
                        agencyAddress1: form.agencyAddress1.value,
                        agencyAddress2: form.agencyAddress2.value,
                        agencyPhone: form.agencyPhone.value,
                        birth: form.birthDate.value,
                        agencyOwner: form.owner.value,
                        agencyRegion: form.agencyRegion.value,
                        agencyEmail: form.agencyEmail.value
                    };

                    //ë°ì´í„° ìˆ˜ì§‘
                    const formData = new FormData();
                    formData.append('data', JSON.stringify(jsonData));
                    // íŒŒì¼ ì—…ë¡œë“œ
                    const agencyImage = form.agencyImage.files[0];
                    if (agencyImage) formData.append('agencyPicture', agencyImage);

                    const businessLicense = form.businessLicense.files[0];
                    if (businessLicense) formData.append('businessCertificate', businessLicense);

                    //data check
                    for (let [key, value] of formData.entries()) {
                        console.log(key, value);
                    }
                    console.log("input element:", form.agencyImage); // <input> íƒœê·¸ ì¡´ì¬ ì—¬ë¶€
                    console.log("íŒŒì¼ ì„ íƒ ì—¬ë¶€:", form.agencyImage.files[0]);
                    console.log("input element:", form.businessLicense); // <input> íƒœê·¸ ì¡´ì¬ ì—¬ë¶€
                    console.log("íŒŒì¼ ì„ íƒ ì—¬ë¶€:", form.businessLicense.files[0]);


                    console.log("ğŸ” ìš”ì²­ ì‹œì‘: POST", form.action);
                    await api.postMultipart(form.action, formData);
                    console.log("âœ… ê°€ì… ìš”ì²­ ì„±ê³µ");

                    const modal = document.createElement("div");
                    modal.className =
                        "fixed inset-0 flex items-center justify-center z-50";
                    modal.innerHTML = `
      <div class="fixed inset-0 bg-black opacity-50"></div>
      <div class="bg-white rounded-lg p-6 relative z-10 max-w-sm w-full mx-4">
      <div class="flex items-center justify-center mb-4">
      <i class="ri-checkbox-circle-line text-green-500 text-4xl"></i>
      </div>
      <h3 class="text-lg font-medium text-gray-900 text-center mb-2">íšŒì›ê°€ì… ì™„ë£Œ</h3>
      <p class="text-gray-500 text-center mb-6">íšŒì›ê°€ì…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
      <button class="w-full !rounded-button bg-primary hover:bg-primary/90 text-white px-4 py-2 font-medium transition">í™•ì¸</button>
      </div>
      `;
                    document.body.appendChild(modal);
                    modal.querySelector("button").onclick = () => {
                        modal.remove();
                        Turbo.visit("/member/login");
                    };
                } catch (error) {
                    const modal = document.createElement("div");
                    modal.className = "fixed inset-0 flex items-center justify-center z-50";
                    modal.innerHTML = `
      <div class="fixed inset-0 bg-black opacity-50"></div>
      <div class="bg-white rounded-lg p-6 relative z-10 max-w-sm w-full mx-4">
      <div class="flex items-center justify-center mb-4">
      <i class="ri-error-warning-line text-red-500 text-4xl"></i>
      </div>
      <h3 class="text-lg font-medium text-gray-900 text-center mb-2">ì˜¤ë¥˜ ë°œìƒ</h3>
      <p class="text-gray-500 text-center mb-6">íšŒì›ê°€ì… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
      <button class="w-full !rounded-button bg-primary hover:bg-primary/90 text-white px-4 py-2 font-medium transition">í™•ì¸</button>
      </div>
      `;
                    document.body.appendChild(modal);
                    modal.querySelector("button").onclick = () => modal.remove();
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = "íšŒì›ê°€ì…";
                }
            } else {
                const firstErrorField = form.querySelector(".border-red-500");
                if (firstErrorField) {
                    firstErrorField.scrollIntoView({behavior: "smooth", block: "center"});
                    firstErrorField.focus();
                }
            }
        });
    </script>
    <script id="chinese-address-modal-script" type="module">
        const modal = document.getElementById("chinese-address-modal");
        const closeBtn = document.getElementById("closeChineseModal");
        const input = document.getElementById("chineseAddressInput");
        const list = document.getElementById("chineseAddressList");

        // ì—¬ëŸ¬ ë²„íŠ¼(íšŒì› / ìœ í•™ì›) ê³µìš©
        const openBtns = document.querySelectorAll(".openChineseModal");
        let currentTarget = null;

        // ëª¨ë‹¬ ì—´ê¸°
        openBtns.forEach(btn => {
            btn.addEventListener("click", () => {
                currentTarget = btn.dataset.target; // "address" or "agency"
                modal.classList.remove("hidden");
                input.value = "";
                list.innerHTML = "";
                list.classList.add("hidden");
                input.focus();
            });
        });

        // ëª¨ë‹¬ ë‹«ê¸°
        closeBtn.addEventListener("click", () => {
            modal.classList.add("hidden");
            list.innerHTML = "";
            list.classList.add("hidden");
        });

        // ì…ë ¥ ì‹œ ìë™ì™„ì„± ê²€ìƒ‰ (ë””ë°”ìš´ìŠ¤)
        let debounceTimer;
        input.addEventListener("input", () => {
            const keyword = input.value.trim();
            if (!keyword) {
                list.classList.add("hidden");
                return;
            }
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => fetchSuggestions(keyword), 300);
        });

        async function fetchSuggestions(keyword) {
            const url = `/tencent/address?keyword=${encodeURIComponent(keyword)}`;
            try {
                const data = await api.get(url);
                console.log("Tencent API result:", data);

                if (!data || !data.data || data.data.length === 0) {
                    list.classList.add("hidden");
                    return;
                }

                list.classList.remove("hidden");
                list.innerHTML = data.data
                    .map(
                        (item, i) => `
                        <li data-index="${i}" class="px-3 py-2 hover:bg-gray-100 cursor-pointer border-b last:border-0">
                            <span class="font-medium">${item.title}</span>
                            <p class="text-sm text-gray-500">${item.address}</p>
                        </li>`
                    )
                    .join("");

                list.querySelectorAll("li").forEach(li => {
                    li.addEventListener("click", () => {
                        const idx = li.dataset.index;
                        const sel = data.data[idx];
                        applyChineseAddress(sel);
                    });
                });
            } catch (err) {
                console.error("Tencent Suggestion API Error:", err);
            }
        }

        // ì„ íƒ ì‹œ address or agencyì— ê°’ ì±„ìš°ê¸°
        function applyChineseAddress(sel) {
            const addr1 = `${sel.province || ""} ${sel.city || ""} ${sel.district || ""}`.trim();
            const addr2 = `${sel.title || ""} ${sel.address || ""}`.trim();
            const adcode = sel.adcode || "";

            if (currentTarget === "address") {
                document.getElementById("address").value = adcode;
                document.getElementById("address1").value = addr1;
                document.getElementById("address2").value = addr2;
            } else if (currentTarget === "agency") {
                document.getElementById("agencyAddress").value = adcode;
                document.getElementById("agencyAddress1").value = addr1;
                document.getElementById("agencyAddress2").value = addr2;
            }

            modal.classList.add("hidden");
            list.innerHTML = "";
            list.classList.add("hidden");
        }
    </script>
    <script id="agency-region-loader" type="module">
        (async () => {
            const select = document.getElementById("agencyRegion");
            if (!select || !window.api) {
                console.warn("agencyRegion select ë˜ëŠ” window.api ì—†ìŒ");
                return;
            }

            try {
                // /agency/region í˜¸ì¶œ
                const res = await window.api.get("/api/v1/agency/region");
                console.log("region api result:", res);

                const regions =
                    Array.isArray(res) ? res
                        : Array.isArray(res.data) ? res.data
                            : Array.isArray(res.result) ? res.result
                                : [];

                regions.forEach(region => {
                    let value, label;

                    if (typeof region === "string") {
                        value = region;
                        label = region;
                    } else {
                        // ê°ì²´ì¼ ê²½ìš° í•„ë“œ ì´ë¦„ ëª‡ ê°€ì§€ ê°€ì •
                        label = region.name || region.label || region.regionName || region.value;
                        value = region.code || label;
                    }

                    if (!label) return; // ì œëŒ€ë¡œëœ ì´ë¦„ì´ ì—†ìœ¼ë©´ íŒ¨ìŠ¤

                    const option = document.createElement("option");
                    option.value = value;
                    option.textContent = label;
                    select.appendChild(option);
                });
            } catch (e) {
                console.error("ì§€ì—­ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e);
                // í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ í† ìŠ¤íŠ¸/ì•Œë¦¼ ë„ì›Œë„ ë¨
            }
        })().then();
    </script>
</th:block>
</html>
