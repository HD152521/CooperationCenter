<!DOCTYPE html>
<html th:replace="~{fragments/layout/main-layout :: main-layout(~{::head}, ~{::body}, ~{::script})}"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>설문 폴더</title>
    <style>
        :where([class^="ri-"])::before {
            content: "\f3c2";
        }

        body {
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
        }

        .folder-card {
            transition: all .25s ease;
        }

        .folder-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, .1), 0 4px 6px -2px rgba(0, 0, 0, .05);
        }

        .dropdown-menu {
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: opacity .2s, transform .2s, visibility .2s;
        }

        .dropdown:hover .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .tooltip {
            position: absolute;
            visibility: hidden;
            opacity: 0;
            transition: .2s;
            z-index: 50;
        }

        .tooltip-trigger:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
<!-- 삭제 모달 -->
<div id="delete-confirm-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 mx-4">
        <div class="text-center mb-5">
            <div class="w-16 h-16 mx-auto flex items-center justify-center rounded-full bg-red-100 text-red-500 mb-4">
                <i class="ri-delete-bin-line ri-xl"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-900 mb-2">폴더 삭제</h3>
            <p class="text-gray-500">이 폴더를 삭제하시겠습니까? 폴더의 설문은 서버 정책에 따라 이동/고아 처리됩니다.</p>
        </div>
        <div class="flex gap-3">
            <button id="cancel-delete" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-button">취소</button>
            <button id="confirm-delete" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-button">삭제</button>
        </div>
    </div>
</div>

<!-- 생성/이름변경 모달 -->
<div id="simple-input-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 mx-4">
        <h3 id="sim-title" class="text-lg font-bold text-gray-900 mb-3">새 폴더</h3>

        <label class="block text-sm font-medium text-gray-700 mb-1">표시용 폴더 이름</label>
        <input id="sim-input-display" type="text" class="w-full px-3 py-2 border border-gray-300 rounded mb-4"
               placeholder="표시용 폴더 이름을 입력하세요"/>

        <label class="block text-sm font-medium text-gray-700 mb-1">저장용 폴더 이름 (영어/숫자, -, _)</label>
        <input id="sim-input-stored" type="text" class="w-full px-3 py-2 border border-gray-300 rounded mb-4"
               placeholder="예: my-folder_1"/>

        <div class="flex gap-3">
            <button id="sim-cancel" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-button">취소</button>
            <button id="sim-confirm" class="flex-1 px-4 py-2 bg-primary text-white rounded-button">확인</button>
        </div>
    </div>
</div>

<main class="container mx-auto px-4 py-6 pt-16 md:pt-20">
    <!-- 헤더 -->
    <div class="flex flex-row flex-wrap items-center justify-between gap-3 mb-6">
        <h1 class="text-xl sm:text-2xl font-bold">설문 폴더</h1>
        <div class="flex flex-row gap-2">
            <button id="open-create-modal"
                    class="bg-primary text-white px-4 py-2 rounded-button flex items-center justify-center text-sm sm:text-base">
                <i class="ri-add-line mr-2"></i> 새 폴더 만들기
            </button>
        </div>
    </div>

    <!--- 검색바(제목 검색만) -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <form th:action="@{/survey/folders}" method="get" class="flex flex-col sm:flex-row gap-3">
            <div class="relative flex-1">
                <input type="text" name="q" th:value="${condition.text}" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded
                       focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm sm:text-base"
                       placeholder="폴더명 검색"/>
                <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                    <i class="ri-search-line"></i>
                </div>
            </div>
            <button type="submit"
                    class="w-full sm:w-auto bg-primary text-white px-4 py-2 rounded-button text-sm sm:text-base">
                검색
            </button>
        </form>
    </div>
    <!-- 폴더 그리드 (페이지네이션 없음) -->
    <div id="folder-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <div th:each="folder : ${folders}"
             class="folder-card bg-white rounded-lg shadow-sm overflow-hidden border border-gray-100"
             th:data-folder-id="${folder.folderId}" th:data-stored-name="${folder.storedName}">
            <div class="p-6">
                <div class="flex items-start justify-between mb-3">
                    <a th:href="@{/survey/list(folderId=${folder.folderId})}" class="flex items-center gap-2 group">
            <span class="w-10 h-10 rounded-lg bg-indigo-50 flex items-center justify-center">
              <i class="ri-folder-2-line text-indigo-600"></i>
            </span>
                        <div>
                            <h3 class="text-lg font-bold text-gray-900 group-hover:text-primary"
                                th:text="${folder.displayName}">폴더명</h3>
                            <p class="text-xs text-gray-500" th:text="'ID: ' + ${folder.folderId}">ID</p>
                        </div>
                    </a>

                    <div class="relative dropdown">
                        <button class="w-8 h-8 flex items-center justify-center rounded hover:bg-gray-100 text-gray-600">
                            <i class="ri-more-2-fill"></i>
                        </button>
                        <div class="dropdown-menu absolute right-0 mt-2 w-40 bg-white border border-gray-200 rounded shadow-lg z-10">
                            <button class="w-full text-left px-3 py-2 hover:bg-gray-50 rename-folder-btn">이름 변경</button>
                            <button class="w-full text-left px-3 py-2 hover:bg-red-50 text-red-600 delete-folder-btn">
                                삭제
                            </button>
                        </div>
                    </div>
                </div>

                <div class="space-y-2 text-sm text-gray-600">
                    <div class="flex items-center">
                        <i class="ri-file-list-3-line mr-2 text-gray-500"></i>
                        <!--                        <span th:text="'설문 ' + ${folder.surveyCount} + '개'">설문 0개</span>-->
                        <span th:text="'설문: ' + ${folder.surveyCnt} + '개'">설문 0개</span>
                    </div>
                    <div class="flex items-center">
                        <i class="ri-calendar-line mr-2 text-gray-500"></i>
                        <span th:text="'생성일: ' + ${#temporals.format(folder.createdAt, 'yyyy년 MM월 dd일 HH:mm')}">생성일</span>
                    </div>
                </div>

                <div class="mt-4 flex items-center justify-between pt-4 border-t border-gray-100">
                    <a th:href="@{/survey/list(folderId=${folder.folderId})}"
                       class="px-3 py-1 bg-white text-indigo-600 border border-indigo-600 text-sm rounded hover:bg-indigo-50 transition">열기</a>
                    <!--                    <div class="text-xs text-gray-500" th:text="${folder.isDefault} ? '기본 폴더' : ''"></div>-->
                    <div class="text-xs text-gray-500" th:text="'기본 폴더'"></div>
                </div>
            </div>
        </div>

        <!-- 폴더가 없을 때 -->
        <div th:if="${#lists.isEmpty(folders)}"
             class="col-span-full bg-white rounded-lg shadow-sm p-10 text-center text-gray-500">
            <i class="ri-folder-2-line text-3xl mb-2 block"></i>
            아직 폴더가 없습니다.
            <button id="open-create-modal-2" class="text-primary underline">폴더를 만들어 보세요.</button>
        </div>
    </div>
</main>

<th:block th:fragment="script">
    <script th:inline="javascript">
        // ===== 공통: API Base URL 및 인증 헤더 =====
        const folderApiUrl = "/api/v1/survey/admin/folders";
        const authHeaders = (() => {
            const token = localStorage.getItem("accessToken");
            return token ? {Authorization: `Bearer ${token}`} : {};
        })();

        // ===== 삭제 모달 =====
        (function () {
            const modal = document.getElementById("delete-confirm-modal");
            const cancelBtn = document.getElementById("cancel-delete");
            const confirmBtn = document.getElementById("confirm-delete");
            let targetFolderId = null;

            document.addEventListener("click", (e) => {
                const btn = e.target.closest(".delete-folder-btn");
                if (!btn) return;
                const card = btn.closest("[data-folder-id]");
                targetFolderId = card?.dataset.folderId;
                if (!targetFolderId) return;
                open();
            });

            function open() {
                modal.classList.remove("hidden");
                modal.classList.add("flex");
                document.body.style.overflow = "hidden";
            }

            function close() {
                modal.classList.add("hidden");
                modal.classList.remove("flex");
                document.body.style.overflow = "";
                targetFolderId = null;
            }

            cancelBtn?.addEventListener("click", close);
            modal?.addEventListener("click", (e) => {
                if (e.target === modal) close();
            });

            confirmBtn?.addEventListener("click", async () => {
                if (!targetFolderId) return;
                try {
                    const res = await fetch(`${folderApiUrl}/${encodeURIComponent(targetFolderId)}`, {
                        method: "DELETE",
                        headers: {...authHeaders}
                    });
                    if (res.ok) {
                        document.querySelector(`[data-folder-id="${CSS.escape(targetFolderId)}"]`)?.remove();
                        close();
                        alert("삭제되었습니다.");
                        if (!document.querySelector("#folder-grid [data-folder-id]")) location.reload();
                    } else {
                        close();
                        alert("삭제 실패");
                    }
                } catch (err) {
                    console.error(err);
                    alert("서버 오류로 삭제에 실패했습니다.");
                }
            });
        })();

        // ===== 생성/이름변경 공용 모달 =====
        (function () {
            const sim = document.getElementById("simple-input-modal");
            const title = document.getElementById("sim-title");
            const inputDisplay = document.getElementById("sim-input-display");
            const inputStored = document.getElementById("sim-input-stored");
            const cancel = document.getElementById("sim-cancel");
            const confirm = document.getElementById("sim-confirm");

            let mode = null;            // "create" | "rename"
            let targetFolderId = null;

            function open() {
                sim.classList.remove("hidden");
                sim.classList.add("flex");
                document.body.style.overflow = "hidden";
                setTimeout(() => inputDisplay.focus(), 0);
            }

            function close() {
                sim.classList.add("hidden");
                sim.classList.remove("flex");
                document.body.style.overflow = "";
                mode = null;
                targetFolderId = null;
                inputDisplay.value = "";
                inputStored.value = "";
            }

            // 생성 모달 열기
            const openCreate = () => {
                mode = "create";
                title.textContent = "새 폴더";
                inputDisplay.value = "";
                inputStored.value = "";
                open();
            };
            document.getElementById("open-create-modal")?.addEventListener("click", openCreate);
            document.getElementById("open-create-modal-2")?.addEventListener("click", openCreate);

            // 이름변경 모달 열기
            document.addEventListener("click", (e) => {
                const btn = e.target.closest(".rename-folder-btn");
                if (!btn) return;

                const card = btn.closest("[data-folder-id]");
                targetFolderId = card?.dataset.folderId ?? null;
                const currentDisplay = card?.querySelector("h3")?.textContent?.trim() ?? "";
                const currentStored = card?.dataset.storedName ?? "";

                mode = "rename";
                title.textContent = "폴더 이름 변경";
                inputDisplay.value = currentDisplay;
                inputStored.value = currentStored;
                open();
            });

            // 닫기
            cancel?.addEventListener("click", close);
            sim.addEventListener("click", (e) => {
                if (e.target === sim) close();
            });

            // 저장용 이름 유효성
            const isValidStored = (v) => /^[A-Za-z0-9_-]+$/.test(v);

            // 확인(생성/수정 공용)
            confirm.addEventListener("click", async () => {
                const displayName = inputDisplay.value.trim();
                const storedName = inputStored.value.trim();

                if (!displayName) {
                    alert("표시용 폴더 이름을 입력하세요.");
                    return;
                }
                if (!storedName) {
                    alert("저장용 폴더 이름(영어/숫자, -, _)을 입력하세요.");
                    return;
                }
                if (!isValidStored(storedName)) {
                    alert("저장용 폴더 이름은 영어/숫자, -, _만 사용할 수 있습니다.");
                    return;
                }

                try {
                    console.log("save");
                    if (mode === "create") {
                        // POST /api/v1/survey/admin/folders
                        // Body: SurveyFolderDto 호환 (folderId/createdAt은 서버에서 생성/세팅)
                        const res = await fetch(`${folderApiUrl}`, {
                            method: "POST",
                            headers: {"Content-Type": "application/json", ...authHeaders},
                            body: JSON.stringify({
                                displayName,
                                storedName
                            })
                        });
                        if (res.ok) {
                            location.reload();
                            return;
                        }
                    } else if (mode === "rename" && targetFolderId) {
                        // PATCH /api/v1/survey/admin/folders/{folderId}
                        // 현 컨트롤러 시그니처가 @RequestBody만 받고 있으므로 body에 folderId 포함
                        const res = await fetch(`${folderApiUrl}/${encodeURIComponent(targetFolderId)}`, {
                            method: "PATCH",
                            headers: {"Content-Type": "application/json", ...authHeaders},
                            body: JSON.stringify({
                                folderId: targetFolderId,   // DTO: String folderId
                                displayName,                // DTO: String displayName
                                storedName                  // DTO: String storedName
                                // createdAt 은 수정 시 보낼 필요 없음
                            })
                        });
                        if (res.ok) {
                            location.reload();
                            return;
                        }
                    }
                    alert("처리에 실패했습니다.");
                } catch (e) {
                    console.error(e);
                    alert("서버 오류가 발생했습니다.");
                } finally {
                    close();
                }
            });
        })();
    </script>
</th:block>
</body>
</html>
