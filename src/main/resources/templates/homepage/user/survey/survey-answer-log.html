<!DOCTYPE html>
<html th:replace="~{fragments/layout/base :: base(~{::head}, ~{::body})}" xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <title th:text="${AnswerDto.surveyTitle}">설문조사 로그</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <style>
        :where([class^="ri-"])::before {
            content: "\f3c2";
        }

        body {
            background-color: #f9fafb;
        }

        .tab-active {
            color: #4F46E5;
            border-bottom: 2px solid #4F46E5;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .custom-checkbox {
            position: relative;
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .custom-checkbox.checked {
            background-color: #4F46E5;
            border-color: #4F46E5;
        }

        .custom-checkbox.checked::after {
            content: '';
            position: absolute;
            left: 5px;
            top: 2px;
            width: 6px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .custom-radio {
            position: relative;
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #d1d5db;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .custom-radio.checked {
            border-color: #4F46E5;
        }

        .custom-radio.checked::after {
            content: '';
            position: absolute;
            left: 3px;
            top: 3px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #4F46E5;
        }

        .custom-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
            background-color: #e5e7eb;
            border-radius: 34px;
            transition: all 0.3s;
        }

        .custom-switch.checked {
            background-color: #4F46E5;
        }

        .custom-switch::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            left: 2px;
            top: 2px;
            background-color: white;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .custom-switch.checked::after {
            transform: translateX(18px);
        }

        .custom-range {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 5px;
            background: #e5e7eb;
            outline: none;
        }

        .custom-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4F46E5;
            cursor: pointer;
        }

        .custom-range::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4F46E5;
            cursor: pointer;
            border: none;
        }

        .word-cloud {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .word-cloud span {
            margin: 5px;
            display: inline-block;
        }
    </style>
</head>
<body>
<div class="min-h-screen flex flex-col">
    <!-- 헤더 -->
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button class="w-10 h-10 flex items-center justify-center text-gray-500 hover:text-primary">
                    <a href="/survey/list">
                        <i class="ri-arrow-left-line ri-lg"></i>
                    </a>
                </button>
                <h1 class="text-xl font-bold">설문조사 결과</h1>
            </div>
            <!--            <div class="flex items-center space-x-3">-->
            <!--                <button-->
            <!--                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-button hover:bg-gray-50 whitespace-nowrap flex items-center"-->
            <!--                >-->
            <!--                    <i class="ri-share-line mr-1"></i>-->
            <!--                    공유하기-->
            <!--                </button>-->
            <!--                <button-->
            <!--                        class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primary/90 rounded-button whitespace-nowrap flex items-center"-->
            <!--                >-->
            <!--                    <i class="ri-download-line mr-1"></i>-->
            <!--                    내보내기-->
            <!--                </button>-->
            <!--            </div>-->
        </div>
    </header>
    <!-- 메인 컨텐츠 -->
    <main class="flex-1 container mx-auto px-4 py-6">
        <!-- 설문 제목 및 정보 -->
        <div class="mb-6">
            <h2 id="survey-title" class="text-2xl font-bold mb-2" th:data-id="${AnswerDto.surveyId}"
                th:text="${AnswerDto.surveyTitle}">제목</h2>
            <p class="text-gray-500" th:text="${AnswerDto.surveyStartDate}+'~'+${AnswerDto.surveyEndDate}"></p>
        </div>
        <!-- 요약 통계 카드 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white p-5 rounded shadow-sm border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">총 응답 수</p>
                        <p class="text-2xl font-bold mt-1" th:text="${AnswerDto.participantCnt} + '명'"></p>
                    </div>
                    <div class="w-12 h-12 flex items-center justify-center bg-primary/10 text-primary rounded-full">
                        <i class="ri-user-line ri-lg"></i>
                    </div>
                </div>
                <!--                <div class="mt-3 text-xs text-gray-500">-->
                <!--                    전주 대비-->
                <!--                    <span class="text-green-500 font-medium">+12%</span> 증가-->
                <!--                </div>-->
            </div>
            <div class="bg-white p-5 rounded shadow-sm border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">완료율</p>
                        <p class="text-2xl font-bold mt-1"
                           th:text="${#numbers.formatDecimal(AnswerDto.finishPercent, 1, 1)} + '%'"></p>
                    </div>
                    <div class="w-12 h-12 flex items-center justify-center bg-green-100 text-green-600 rounded-full">
                        <i class="ri-check-line ri-lg"></i>
                    </div>
                </div>
                <!--                <div class="mt-3 text-xs text-gray-500">-->
                <!--                    목표 완료율-->
                <!--                    <span class="text-gray-700 font-medium">90%</span> 달성-->
                <!--                </div>-->
            </div>
            <div class="bg-white p-5 rounded shadow-sm border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">평균 응답 시간</p>
                        <p class="text-2xl font-bold mt-1"
                           th:text="${AnswerDto.avgSpendTime / 60} + '분 ' + (${AnswerDto.avgSpendTime} % 60) + '초'"></p>
                    </div>
                    <div class="w-12 h-12 flex items-center justify-center bg-blue-100 text-blue-600 rounded-full">
                        <i class="ri-time-line ri-lg"></i>
                    </div>
                </div>
                <!--                <div class="mt-3 text-xs text-gray-500">-->
                <!--                    최근 응답:-->
                <!--                    <span class="text-gray-700 font-medium">2025-06-28 09:15</span>-->
                <!--                </div>-->
            </div>
        </div>
        <!-- 탭 네비게이션 -->
        <div class="border-b border-gray-200 mb-6">
            <div class="flex space-x-8">
                <button id="tab-responses" class="tab-active py-4 px-1 font-medium text-sm">
                    응답 기록
                </button>
            </div>
        </div>
        <!-- 응답 기록 탭 내용 -->
        <div id="content-responses" class="block">
            <!-- 필터링 섹션 -->
            <div class="bg-white p-5 rounded shadow-sm border border-gray-100 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">기간 선택</label>
                        <div class="flex items-center space-x-2">
                            <div class="relative flex-1">
                                <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                       value="2025-06-01"/>
                            </div>
                            <span class="text-gray-500">~</span>
                            <div class="relative flex-1">
                                <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                       value="2025-06-28"/>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">응답자 유형</label>
                        <div class="relative">
                            <button class="w-full px-3 py-2 bg-white border border-gray-300 rounded text-sm text-left flex items-center justify-between">
                                <span>전체 응답자</span>
                                <i class="ri-arrow-down-s-line"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">검색</label>
                        <div class="relative">
                            <input type="text" placeholder="응답자명 또는 이메일 검색"
                                   class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded text-sm"/>
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="ri-search-line text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center justify-end mt-4 pt-4 border-t border-gray-100 space-x-4">
                    <div class="flex items-center space-x-4">
                        <!--                        <div class="flex items-center">-->
                        <!--                            <div class="custom-checkbox" id="checkbox-complete"></div>-->
                        <!--                            <label-->
                        <!--                                    for="checkbox-complete"-->
                        <!--                                    class="ml-2 text-sm text-gray-700"-->
                        <!--                            >완료된 응답만</label-->
                        <!--                            >-->
                        <!--                        </div>-->
                        <!--                        <div class="flex items-center">-->
                        <!--                            <div class="custom-checkbox" id="checkbox-recent"></div>-->
                        <!--                            <label-->
                        <!--                                    for="checkbox-recent"-->
                        <!--                                    class="ml-2 text-sm text-gray-700"-->
                        <!--                            >최근 7일 응답</label-->
                        <!--                            >-->
                        <!--                        </div>-->
                    </div>
                    <div class="flex items-center">
                        <div class="custom-checkbox" id="select-all"></div>
                        <label class="ml-2 text-sm text-gray-700">전체 선택</label>
                    </div>
                    <button id="export-csv"
                            class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primary/90 rounded-button whitespace-nowrap flex items-center">
                        <i class="ri-file-download-line mr-1"></i>
                        선택항목 CSV 추출
                    </button>
                    <button id="export-csv-all"
                            class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primary/90 rounded-button whitespace-nowrap flex items-center">
                        <i class="ri-file-download-line mr-1"></i>
                        모든항목 CSV 추출
                    </button>
                    <button id="fileDownload-student"
                            class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primary/90 rounded-button whitespace-nowrap flex items-center">
                        <i class="ri-file-download-line mr-1"></i>
                        학생별로 파일 다운로드
                    </button>
                    <button id="fileDownload-survey"
                            class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primary/90 rounded-button whitespace-nowrap flex items-center">
                        <i class="ri-file-download-line mr-1"></i>
                        문항별로 파일 다운로드
                    </button>

                    <!--                    <button-->
                    <!--                            class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-button whitespace-nowrap"-->
                    <!--                    >-->
                    <!--                        필터 초기화-->
                    <!--                    </button>-->
                </div>
            </div>
            <!-- 응답 목록 테이블 -->
            <div class="bg-white rounded shadow-sm border border-gray-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                        <tr>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                응답자
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                응답 일시
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                소요 시간
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                상태
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                액션
                            </th>
                        </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" th:if="${AnswerDto != null}">
                        <tr class="hover:bg-gray-50 cursor-pointer" th:each="log, iterStat : ${AnswerDto.logs.content}">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="custom-checkbox mr-3"
                                         th:attr="data-id=${iterStat.index + 1}, data-log-id=${log.logId}"></div>
                                    <div class="w-8 h-8 flex items-center justify-center bg-blue-100 text-blue-600 rounded-full mr-3">
                                        <span class="text-sm font-medium"
                                              th:text="${log.memberName.substring(0,1)}">김</span>
                                    </div>
                                    <div>
                                        <div class="text-sm font-medium text-gray-900" th:text="${log.memberName}">김민준
                                        </div>
                                        <div class="text-sm text-gray-500" th:text="${log.memberEmail}">
                                            minjun.kim@example.com
                                        </div>
                                    </div>
                                </div>
                            </td>

                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900" th:text="${log.submitTime}">2025-06-28 09:15</div>
                            </td>

                            <td class="px-6 py-4 whitespace-nowrap">
                                <div th:with="min=${log.spendTime / 60}, sec=${log.spendTime % 60}">
                                    <span th:text="${min} + '분 ' + ${sec} + '초'"></span>
                                </div>
                            </td>

                            <td class="px-6 py-4 whitespace-nowrap">
                                <span th:class="'px-2 inline-flex text-xs leading-5 font-semibold rounded-full ' +
                                        (log.finishStatus == 'finish' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800')"
                                      th:text="${log.finishStatus == 'finish' ? '완료' : '부분 완료'}">
                                    완료
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <a th:href="@{'/survey/log/detail/'+ ${log.logId}}"
                                   class="text-primary hover:text-primary/80 mr-3">상세보기</a>
                                <!--                                <button class="text-primary hover:text-primary/80 mr-3">상세보기</button>-->
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-between">
                    <div class="text-sm text-gray-500">
                        총 <span th:text="${AnswerDto.logs.totalElements}">0</span>개 중
                        <span th:text="${AnswerDto.logs.number * AnswerDto.logs.size + 1}">1</span> -
                        <span th:text="${T(java.lang.Math).min(((AnswerDto.logs.number + 1) * AnswerDto.logs.size), AnswerDto.logs.totalElements.intValue())}">5</span>표시
                    </div>

                    <div class="flex items-center space-x-2">
                        <!-- 이전 버튼 -->
                        <a th:if="${AnswerDto.logs.hasPrevious()}"
                           th:href="@{/survey/log/{id}(id=${AnswerDto.surveyId}, page=${AnswerDto.logs.number - 1})}"
                           class="px-3 py-1 text-sm text-gray-700 bg-white border border-gray-300 rounded-button whitespace-nowrap">
                            이전
                        </a>
                        <span th:if="${!AnswerDto.logs.hasPrevious()}"
                              class="px-3 py-1 text-sm text-gray-500 bg-white border border-gray-300 rounded-button whitespace-nowrap cursor-not-allowed opacity-50">
            이전
        </span>

                        <!-- 페이지 번호 반복 -->
                        <a th:each="i : ${#numbers.sequence(1, AnswerDto.logs.totalPages)}"
                           th:href="@{/survey/log/{id}(id=${AnswerDto.surveyId}, page=${i - 1})}" th:text="${i}"
                           th:class="'px-3 py-1 text-sm border rounded-button whitespace-nowrap ' +
                      (${i - 1} == ${AnswerDto.logs.number}
                          ? 'text-white bg-primary border-primary'
                          : 'text-gray-700 bg-white border-gray-300')">
                        </a>

                        <!-- 다음 버튼 -->
                        <a th:if="${AnswerDto.logs.hasNext()}"
                           th:href="@{/survey/log/{id}(id=${AnswerDto.surveyId}, page=${AnswerDto.logs.number + 1})}"
                           class="px-3 py-1 text-sm text-gray-700 bg-white border border-gray-300 rounded-button whitespace-nowrap">
                            다음
                        </a>
                        <span th:if="${!AnswerDto.logs.hasNext()}"
                              class="px-3 py-1 text-sm text-gray-500 bg-white border border-gray-300 rounded-button whitespace-nowrap cursor-not-allowed opacity-50">
                            다음
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script id="checkbox-handler" type="module">
    // 체크박스 기능 구현
    const checkboxes = document.querySelectorAll(".custom-checkbox");
    const selectAllCheckbox = document.getElementById("select-all");
    const exportCsvButton = document.getElementById("export-csv");
    const exportAllCsvButton = document.getElementById("export-csv-all");
    const fileDownloadByStudentBtn = document.getElementById("fileDownload-student");
    const fileDownloadBySurveyBtn = document.getElementById("fileDownload-survey");

    // 개별 체크박스 클릭 처리
    checkboxes.forEach((checkbox) => {
        checkbox.addEventListener("click", function (e) {
            if (this.id !== "select-all" && this.id !== "checkbox-complete") {
                e.stopPropagation();
            }
            this.classList.toggle("checked");
            // 전체 선택 체크박스 상태 업데이트
            if (this.id !== "select-all" && this.id !== "checkbox-complete") {
                const totalCheckboxes = document.querySelectorAll(
                    ".custom-checkbox[data-id]",
                ).length;
                const checkedCheckboxes = document.querySelectorAll(
                    ".custom-checkbox[data-id].checked",
                ).length;
                selectAllCheckbox.classList.toggle(
                    "checked",
                    totalCheckboxes === checkedCheckboxes,
                );
            }
        });
    });
    // 전체 선택 체크박스 클릭 처리
    selectAllCheckbox.addEventListener("click", function () {

        console.log("전테 선택 버튼 클릭");
        this.classList.toggle("checked");

        const isChecked = this.classList.toggle("checked");
        console.log("ischecked:" + isChecked);
        document
            .querySelectorAll(".custom-checkbox[data-id]")
            .forEach((checkbox) => {
                console.log(checkbox);
                checkbox.classList.remove("checked"); // 초기화 후
                if (isChecked) {
                    checkbox.classList.add("checked"); // 체크 추가
                }
            });
    });
    // CSV 추출 버튼 클릭 처리
    exportCsvButton.addEventListener("click", async () => {
        const selectedRows = document.querySelectorAll(
            ".custom-checkbox[data-id].checked",
        );
        if (selectedRows.length === 0) {
            const notification = document.createElement("div");
            notification.className =
                "fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded";
            notification.innerHTML = `
      <div class="flex items-center">
      <i class="ri-error-warning-line mr-2"></i>
      <span>선택된 항목이 없습니다.</span>
      </div>
      `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
            return;
        }

        const logIds = [];
        selectedRows.forEach(box => {
            const logId = box.getAttribute('data-log-id');
            if (logId) {
                logIds.push(logId);
            }
        });

        const requestDto = {
            logIds: logIds
        };

        try {

            const csvText = await api.postJson(`${surveyAdminUrl}/log/csv`, requestDto);
            const titleText = document.getElementById("survey-title").textContent;
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // 0-based → +1
            const day = String(today.getDate()).padStart(2, '0');

            const todayStr = `${year}-${month}-${day}`;

            const blob = new Blob([csvText], {type: 'text/csv;charset=utf-8'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = titleText + "_" + todayStr + '.csv';
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
            const notification = document.createElement("div");
            notification.className =
                "fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded";
            notification.innerHTML = `
      <div class="flex items-center">
      <i class="ri-checkbox-circle-line mr-2"></i>
      <span>CSV 파일이 다운로드되었습니다.</span>
      </div>
      `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        } catch (error) {
            console.error(error);
            alert('CSV 다운로드 중 오류가 발생했습니다.');
        }

    });

    exportAllCsvButton.addEventListener("click", async () => {
        const Rows = document.querySelectorAll(
            ".custom-checkbox[data-id]",
        );

        if (Rows.length === 0) {
            const notification = document.createElement("div");
            notification.className =
                "fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded";
            notification.innerHTML = `
      <div class="flex items-center">
      <i class="ri-error-warning-line mr-2"></i>
      <span>설문에 대한 기록이 없습니다.</span>
      </div>
      `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
            return;
        }


        const surveyId = document.getElementById("survey-title").dataset.id;

        try {
            const csvData = await api._request("POST", `${surveyAdminUrl}/log/${surveyId}`, null, {});
            const titleText = document.getElementById("survey-title").textContent;
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // 0-based → +1
            const day = String(today.getDate()).padStart(2, '0');

            const todayStr = `${year}-${month}-${day}`;

            const blob = csvData instanceof Response
                ? await csvData.blob()
                : new Blob([csvData], {type: "text/csv;charset=utf-8"});

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');

            a.href = url;
            a.download = titleText + "_" + todayStr + '_all.csv';
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
            const notification = document.createElement("div");
            notification.className =
                "fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded";
            notification.innerHTML = `
      <div class="flex items-center">
      <i class="ri-checkbox-circle-line mr-2"></i>
      <span>CSV 파일이 다운로드되었습니다.</span>
      </div>
      `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        } catch (error) {
            console.error(error);
            alert('CSV 다운로드 중 오류가 발생했습니다.');
        }

    });

    fileDownloadByStudentBtn.addEventListener("click", async () => {
        const Rows = document.querySelectorAll(
            ".custom-checkbox[data-id]",
        );

        if (Rows.length === 0) {
            const notification = document.createElement("div");
            notification.className =
                "fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded";
            notification.innerHTML = `
      <div class="flex items-center">
      <i class="ri-error-warning-line mr-2"></i>
      <span>설문에 대한 기록이 없습니다.</span>
      </div>
      `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
            return;
        }


        const surveyId = document.getElementById("survey-title").dataset.id;

        try {
            const res = await api._request("POST", `${surveyAdminUrl}/log/file/student/${surveyId}`, null, {});

            const titleText = document.getElementById("survey-title").textContent;
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // 0-based → +1
            const day = String(today.getDate()).padStart(2, '0');

            const todayStr = `${year}-${month}-${day}`;

            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');

            a.href = url;
            a.download = titleText + "_" + todayStr + '_all.zip';
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
            const notification = document.createElement("div");
            notification.className =
                "fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded";
            notification.innerHTML = `
      <div class="flex items-center">
      <i class="ri-checkbox-circle-line mr-2"></i>
      <span>파일이 다운로드 되었습니다.</span>
      </div>
      `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        } catch (error) {
            console.error(error);
            alert('유저별 파일 다운로드에 실패했습니다.');
        }

    });

    fileDownloadBySurveyBtn.addEventListener("click", async () => {
        const Rows = document.querySelectorAll(
            ".custom-checkbox[data-id]",
        );

        if (Rows.length === 0) {
            const notification = document.createElement("div");
            notification.className =
                "fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded";
            notification.innerHTML = `
      <div class="flex items-center">
      <i class="ri-error-warning-line mr-2"></i>
      <span>설문에 대한 기록이 없습니다.</span>
      </div>
      `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
            return;
        }


        const surveyId = document.getElementById("survey-title").dataset.id;

        try {
            const res = await api._request("POST", `${surveyAdminUrl}/log/file/survey/${surveyId}`, null, {});
            const titleText = document.getElementById("survey-title").textContent;
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // 0-based → +1
            const day = String(today.getDate()).padStart(2, '0');

            const todayStr = `${year}-${month}-${day}`;

            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');

            a.href = url;
            a.download = titleText + "_" + todayStr + '_all.zip';
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
            const notification = document.createElement("div");
            notification.className =
                "fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded";
            notification.innerHTML = `
      <div class="flex items-center">
      <i class="ri-checkbox-circle-line mr-2"></i>
      <span>파일이 다운로드 되었습니다.</span>
      </div>
      `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        } catch (error) {
            console.error(error);
            alert('문항별 파일 다운로드에 실패했습니다.');
        }

    });


    // 라디오 버튼 기능 구현
    const radios = document.querySelectorAll(".custom-radio");
    radios.forEach((radio) => {
        radio.addEventListener("click", function () {
            const name = this.getAttribute("name");
            if (name) {
                document
                    .querySelectorAll(`.custom-radio[name="${name}"]`)
                    .forEach((r) => {
                        r.classList.remove("checked");
                    });
            }
            this.classList.add("checked");
        });
    });
    // 스위치 기능 구현
    const switches = document.querySelectorAll(".custom-switch");
    switches.forEach((switchEl) => {
        switchEl.addEventListener("click", function () {
            this.classList.toggle("checked");
        });
    });
</script>

</body>
</html>
