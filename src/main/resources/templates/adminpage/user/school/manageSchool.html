<!DOCTYPE html>
<html th:replace="~{fragments/layout/base :: base(~{::head}, ~{::body})}" xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <title>ê²Œì‹œíŒ ê´€ë¦¬</title>
    <!--    í¸ì§‘íˆ´-->
    <link href="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/css/suneditor.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/suneditor.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/src/lang/ko.js"></script>
    <style>
        :where([class^="ri-"])::before {
            content: "\f3c2";
        }

        .admin-card {
            background: linear-gradient(145deg, #2C2C3A, #232331);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .table-header {
            background: linear-gradient(135deg, #343446, #2A2A3C);
        }

        .table-row:hover {
            background: rgba(52, 152, 219, 0.1);
        }

        .status-badge {
            backdrop-filter: blur(10px);
        }

        .tree-node {
            transition: all 0.3s ease;
        }

        .tree-node.expanded > .tree-children {
            max-height: 1000px;
            opacity: 1;
        }

        .tree-children {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .editor-toolbar {
            background: linear-gradient(135deg, #343446, #2A2A3C);
            border-bottom: 1px solid #374151;
        }

        .editor-content {
            min-height: 400px;
            background: #1F2937;
            color: #F9FAFB;
        }

        .board-type-tag {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
        }

        .dark-input {
            width: 100%;
            padding: 0.6rem 0.9rem;
            border-radius: 9999px;
            background-color: #111827;
            border: 1px solid #374151;
            color: #e5e7eb;
            font-size: 0.875rem;
            outline: none;
            transition: all 0.15s ease-in-out;
        }

        .dark-input::placeholder {
            color: #6b7280;
        }

        .dark-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59,130,246,0.35);
            background-color: #020617;
        }

        .field-help {
            margin-top: 0.25rem;
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.25rem;
        }

        .section-header-line {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #374151;
        }

        .section-helper {
            font-size: 0.75rem;
            color: #9ca3af;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/school/admin/modals.html :: modals}"></div>
<div class="bg-gradient-to-br from-gray-900 via-slate-800 to-gray-900 min-h-screen text-gray-100">
    <div class="flex">

        <!--    leftSide-->

        <aside th:replace="~{adminpage/common/leftSide :: leftSide}"></aside>

        <main class="flex-1 p-8">
            <div th:replace="~{fragments/school/admin/board-list.html :: boardList(schoolDto=${schoolDto})}"></div>

            <div th:replace="~{fragments/school/admin/intro-editor :: introEditor()}"></div>

            <div th:replace="~{fragments/school/admin/board-list-editor.html :: board-list-editor}"></div>

            <div th:replace="~{fragments/school/admin/schedule-list-editor.html :: schedule-list-editor}"></div>

            <div th:replace="~{fragments/school/admin/post-editor.html :: postEditor}"></div>

            <div th:replace="~{fragments/school/admin/file-post-editor.html :: filePostEditor}"></div>

        </main>
    </div>
</div>

<script id="modal-functions" type="module">
    window.openAddBoardModal = function () {
        document.getElementById("addBoardModal").classList.remove("hidden");
    };
    window.closeAddBoardModal = function () {
        document.getElementById("addBoardModal").classList.add("hidden");
    };
    window.openCategoryModal = function () {
        document.getElementById("categoryModal").classList.remove("hidden");
    };
    window.closeCategoryModal = function () {
        document.getElementById("categoryModal").classList.add("hidden");
    };

    window.openAddCategoryModal = function (buttonElement) {
        const modal = document.getElementById("addCategoryModal");
        const schoolId = buttonElement.dataset.schoolId;
        modal.dataset.schoolId = schoolId;
        modal.classList.remove("hidden");
    };

    window.closeAddCategoryModal = function () {
        const modal = document.getElementById("addCategoryModal");
        modal.classList.add("hidden");
        modal.dataset.schoolId = "";
    };

    window.deleteCategory = function (categoryName) {
        if (confirm(`"${categoryName}" ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            const notification = document.createElement("div");
            notification.className =
                "fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
            notification.textContent = "ì¹´í…Œê³ ë¦¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤";
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    };

    window.saveNewBoard = async function () {
        const koreanNameInput = document.querySelectorAll(
            '#addBoardModal input[type="text"]'
        )[0]; // í•œêµ­ì–´ ì´ë¦„
        const englishNameInput = document.querySelectorAll(
            '#addBoardModal input[type="text"]'
        )[1]; // ì˜ì–´ ì´ë¦„
        const logoUrlInput = document.querySelector('#addBoardModal input[type="url"]');

        const schoolKoreanName = koreanNameInput.value.trim();
        const schoolEnglishName = englishNameInput.value.trim();
        const imgUrl = logoUrlInput.value.trim();

        if (!schoolKoreanName || !schoolEnglishName || !imgUrl) {
            const notification = document.createElement("div");
            notification.className =
                "fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
            notification.textContent = "ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”";
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
            return;
        }

        const payload = {
            schoolKoreanName: schoolKoreanName,
            schoolEnglishName: schoolEnglishName,
            imgUrl: imgUrl,
        };

        try {
            const response = await fetch("/api/v1/admin/school/save", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            });

            const result = await response.json();

            if (result.isSuccess) {
                const notification = document.createElement("div");
                notification.className =
                    "fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
                notification.textContent = "ìƒˆ ê²Œì‹œíŒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤";
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
                closeAddBoardModal();
                location.reload(); // ìƒˆë¡œê³ ì¹¨í•´ì„œ ë°˜ì˜
            } else {
                throw new Error(result.message || "ì¶”ê°€ ì‹¤íŒ¨");
            }
        } catch (error) {
            const notification = document.createElement("div");
            notification.className =
                "fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
            notification.textContent = "ì˜¤ë¥˜ ë°œìƒ: " + error.message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    };
</script>
<script id="schedule-modal-functions" type="module">
    // ì‹ ê·œ ì‘ì„± ì—´ê¸°
    window.openAddScheduleModal = function () {
        const modal = document.getElementById("addScheduleModal");
        // ëª¨ë“œ ì´ˆê¸°í™”
        modal.dataset.scheduleId = "";
        document.getElementById("scheduleTitle").value = "";
        document.getElementById("scheduleStartDate").value = "";
        document.getElementById("scheduleEndDate").value = "";
        // ê¸°ë³¸ íƒ€ì… ì²´í¬
        document.querySelector('input[name="scheduleType"][value="ACADEMIC"]').checked = true;

        // íƒ€ì´í‹€ë„ ë°”ê¾¸ê³  ì—´ê¸°
        modal.querySelector("h3").textContent = "ìƒˆ ì¼ì • ì¶”ê°€";
        modal.classList.remove("hidden");
        modal.setAttribute("aria-hidden", "false");
    };

    // ìˆ˜ì • ëª¨ë“œ ì—´ê¸° (ìŠ¤ì¼€ì¤„ ë°ì´í„° ë„£ì–´ì¤Œ)
    window.openEditScheduleModal = async function (scheduleId) {
        const modal = document.getElementById("addScheduleModal");
        const res = await fetch(`/api/v1/admin/school/schedule?postId=${scheduleId}`);
        const json = await res.json();
        if (!json.isSuccess) throw new Error(json.message || "ì¡°íšŒ ì‹¤íŒ¨");

        const s = json.result;

        modal.dataset.scheduleId = String(s.id);
        document.getElementById("scheduleTitle").value = s.title ?? "";
        document.getElementById("scheduleStartDate").value = s.startDate ?? "";
        document.getElementById("scheduleEndDate").value = s.endDate ?? "";
        // íƒ€ì… ë¼ë””ì˜¤
        const typeInput = document.querySelector(`input[name="scheduleType"][value="${s.type}"]`);
        if (typeInput) typeInput.checked = true;

        modal.querySelector("h3").textContent = "ì¼ì • ìˆ˜ì •";
        modal.classList.remove("hidden");
        modal.setAttribute("aria-hidden", "false");
    };

    // ë‹«ê¸°(ëª¨ë“  ê²½ë¡œì—ì„œ id ì œê±°)
    window.closeAddScheduleModal = function () {
        const modal = document.getElementById("addScheduleModal");
        modal.classList.add("hidden");
        modal.setAttribute("aria-hidden", "true");
        // ë‹¤ìŒ ì—´ë¦¼ì— ì˜í–¥ ì—†ê²Œ ë¹„ì›€
        modal.dataset.scheduleId = "";
    };

    // ëª¨ë‹¬ ì´ˆê¸° ë°”ì¸ë”©
    const modal = document.getElementById("addScheduleModal");
    if (!modal) {
        console.warn("[ScheduleModal] #addScheduleModal not in DOM at load (will still work if added later).");
    }

    // id="openAddScheduleBtn" ê°€ ìˆë‹¤ë©´ ìë™ ë°”ì¸ë”©(ì„ íƒ ì‚¬í•­)
    const openBtn = document.getElementById("openAddScheduleBtn");
    if (openBtn) openBtn.addEventListener("click", openAddScheduleModal);

    // ëª¨ë‹¬ ë‚´ë¶€ ë‹«ê¸°/ì·¨ì†Œ ë²„íŠ¼ ìœ„ì„ ë°”ì¸ë”©
    document.addEventListener("click", (e) => {
        // ì˜¤ë²„ë ˆì´ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
        const overlay = document.getElementById("addScheduleModal");
        if (overlay && e.target === overlay) {
            closeAddScheduleModal();
            return;
        }

        // ë‹«ê¸° ë²„íŠ¼ë“¤
        if (e.target.closest("#closeAddScheduleModalBtn")) {
            closeAddScheduleModal();
            return;
        }
        if (e.target.closest("#scheduleCancelBtn")) {
            closeAddScheduleModal();
            return;
        }
    });

    // ESC ë¡œ ë‹«ê¸°
    document.addEventListener("keydown", (e) => {
        const m = document.getElementById("addScheduleModal");
        if (e.key === "Escape" && m && !m.classList.contains("hidden")) {
            closeAddScheduleModal();
        }
    });
</script>
<script id="scheduleFetch" type="module">
    async function fetchScheduleList(boardId, page = 0) {
        const root = document.getElementById("schedule-list-editor");
        const typeEl = root.querySelector("#schedule-type-filter");
        const fromEl = root.querySelector("#schedule-date-from");
        const toEl = root.querySelector("#schedule-date-to");
        const kwEl = root.querySelector("#schedule-search");

        const type = (typeEl?.value || "").trim();           // ACADEMIC|...|""(ì „ì²´)
        const from = (fromEl?.value || "").trim();           // YYYY-MM-DD
        const to = (toEl?.value || "").trim();             // YYYY-MM-DD
        const keyword = (kwEl?.value || "").trim();

        const params = new URLSearchParams();
        params.append("boardId", boardId);
        params.append("page", String(page));
        // params.append("size", "10");
        if (keyword) params.append("title", keyword);
        if (type) params.append("type", type);
        if (from) params.append("startDate", from);
        if (to) params.append("endDate", to);

        try {
            const res = await fetch(`/api/v1/admin/school/schedules?${params.toString()}`);
            const json = await res.json();

            if (json.isSuccess) {
                const pageData = json.result;          // { content, totalPages, number, ... }
                renderScheduleTable(pageData.content); // tbody ë Œë”
                renderSchedulePagination(pageData, boardId);
            } else {
                alert("ì¼ì • ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + (json.message || ""));
            }
        } catch (e) {
            console.error(e);
            alert("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
        }
    }

    // âœ… í…Œì´ë¸” ë Œë” (#schedule-table-body)
    function renderScheduleTable(schedules = []) {
        const tbody = document.getElementById("schedule-table-body");
        if (!tbody) return;
        tbody.innerHTML = "";

        const today = new Date();
        const pad2 = (n) => String(n).padStart(2, "0");
        const fmt = (d) => {
            if (!d) return "-";
            // ì„œë²„ê°€ 'YYYY-MM-DD'ë¼ë©´ ê·¸ëŒ€ë¡œ ì¶œë ¥
            if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
            // í˜¹ì‹œ ISOë©´ ë‚ ì§œë§Œ
            const dt = new Date(d);
            return isNaN(dt) ? "-" : `${dt.getFullYear()}-${pad2(dt.getMonth() + 1)}-${pad2(dt.getDate())}`;
        };
        const statusBadge = (startDate, endDate) => {
            // ì§„í–‰ ìƒíƒœ ê³„ì‚° (í´ë¼ì´ì–¸íŠ¸ í‘œì‹œìš©)
            const s = startDate ? new Date(startDate) : null;
            const e = endDate ? new Date(endDate) : null;

            let label = "ì§„í–‰ì¤‘", cls = "bg-green-500 text-green-400";
            if (s && s > today) {
                label = "ì˜ˆì •";
                cls = "bg-yellow-500 text-yellow-400";
            }
            if (e && e < today) {
                label = "ì¢…ë£Œ";
                cls = "bg-gray-500 text-gray-400";
            }

            return `<span class="status-badge px-2 py-1 ${cls} bg-opacity-20 text-xs rounded-full">${label}</span>`;
        };

        schedules.forEach((sch) => {
            const tr = document.createElement("tr");
            tr.className = "table-row border-b border-gray-700";
            tr.innerHTML = `
        <td class="p-3 text-white">${sch.title || "-"}</td>
        <td class="p-3 text-gray-300">${fmt(sch.startDate)}</td>
        <td class="p-3 text-gray-300">${fmt(sch.endDate)}</td>
        <td class="p-3">
          <span class="status-badge px-2 py-1 bg-blue-500 bg-opacity-20 text-blue-400 text-xs rounded-full">
            ${sch.type || "-"}
          </span>
        </td>
        <td class="p-3">
          ${statusBadge(sch.startDate, sch.endDate)}
        </td>
        <td class="p-3">
          <div class="flex space-x-2">
            <button
              class="px-3 py-1 bg-primary text-white text-sm rounded-button hover:bg-blue-600 transition-colors whitespace-nowrap"
              onclick="openEditScheduleModal(${sch.id})"
            >
              ìˆ˜ì •
            </button>
            <button
              class="px-3 py-1 bg-red-600 text-white text-sm rounded-button hover:bg-red-700 transition-colors whitespace-nowrap"
              onclick="deleteSchedule(${sch.id})"
            >
              ì‚­ì œ
            </button>
          </div>
        </td>
      `;
            tbody.appendChild(tr);
        });
    }

    // âœ… í˜ì´ì§€ë„¤ì´ì…˜ ë Œë” (#schedule-pagination)
    function renderSchedulePagination(pageData, boardId) {
        const container = document.getElementById("schedule-pagination");
        if (!container) return;
        container.innerHTML = "";

        const {totalPages, number} = pageData;

        const makeBtn = (html, disabled, onClick) => {
            const b = document.createElement("button");
            b.innerHTML = html;
            b.className = `px-3 py-2 ${disabled ? "text-gray-600 cursor-not-allowed" : "text-gray-400 hover:text-white"} transition-colors`;
            b.disabled = !!disabled;
            if (!disabled) b.onclick = onClick;
            return b;
        };

        // Prev
        container.appendChild(
            makeBtn(`<i class="ri-arrow-left-line"></i>`, number === 0, () => fetchScheduleList(boardId, number - 1))
        );

        // Pages
        for (let i = 0; i < totalPages; i++) {
            const btn = document.createElement("button");
            btn.textContent = i + 1;
            btn.className = `px-3 py-2 ${i === number ? "bg-primary text-white" : "text-gray-400 hover:text-white"} transition-colors`;
            btn.onclick = () => fetchScheduleList(boardId, i);
            container.appendChild(btn);
        }

        // Next
        container.appendChild(
            makeBtn(`<i class="ri-arrow-right-line"></i>`, number >= totalPages - 1, () => fetchScheduleList(boardId, number + 1))
        );
    }

    // âœ… ì‚­ì œ/ìˆ˜ì •(ì„ íƒ)
    async function deleteSchedule(scheduleId) {
        if (!confirm("ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        try {
            const res = await fetch(`/api/v1/admin/school/schedule`, {
                method: "DELETE",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({postId: scheduleId}),
            });
            const json = await res.json();
            if (!json.isSuccess) throw new Error(json.message || "ì‚­ì œ ì‹¤íŒ¨");
            alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            fetchScheduleList(window.currentBoardId, 0);
        } catch (e) {
            console.error(e);
            alert("ì„œë²„ ì˜¤ë¥˜: " + e.message);
        }
    }

    // âœ… í•„í„° ì´ë²¤íŠ¸ ë°”ì¸ë”© (ë³€ê²½ ì‹œ ìë™ ì¡°íšŒ)
    (function () {
        const root = document.getElementById("schedule-list-editor");
        if (!root) return;

        const requery = () => fetchScheduleList(window.currentBoardId, 0);

        root.querySelector("#schedule-type-filter")?.addEventListener("change", requery);
        root.querySelector("#schedule-date-from")?.addEventListener("change", requery);
        root.querySelector("#schedule-date-to")?.addEventListener("change", requery);

        const search = root.querySelector("#schedule-search");
        if (search) {
            let t;
            search.addEventListener("input", () => {
                clearTimeout(t);
                t = setTimeout(requery, 300); // ê°„ë‹¨ ë””ë°”ìš´ìŠ¤
            });
            search.addEventListener("keydown", (e) => {
                if (e.key === "Enter") requery();
            });
        }
    })();

    // window module export
    window.fetchScheduleList = fetchScheduleList;
    window.deleteSchedule = deleteSchedule;
</script>
<script id="postSchedule" type="module">
    async function submitSchedule() {
        const btn = document.getElementById("scheduleSubmitBtn");
        const modal = document.getElementById("addScheduleModal"); // ëª¨ë‹¬ ë£¨íŠ¸ ì—˜ë¦¬ë¨¼íŠ¸
        const isEdit = !!modal.dataset.scheduleId;

        const boardId = Number(window.currentBoardId);
        const title = document.getElementById("scheduleTitle").value.trim();
        const startDate = document.getElementById("scheduleStartDate").value; // YYYY-MM-DD
        const endDate = document.getElementById("scheduleEndDate").value;   // YYYY-MM-DD or ""
        const type = document.querySelector('input[name="scheduleType"]:checked')?.value || "ACADEMIC";

        // ê¸°ë³¸ ê²€ì¦
        if (!boardId) return alert("boardIdê°€ ì—†ìŠµë‹ˆë‹¤.");
        if (!title) return alert("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");
        if (!startDate) return alert("ì‹œì‘ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        if (endDate && endDate < startDate) return alert("ë ë‚ ì§œê°€ ì‹œì‘ ë‚ ì§œë³´ë‹¤ ë¹ ë¦…ë‹ˆë‹¤.");

        // ê³µí†µ ë°”ë”” (PATCH/POST ë™ì¼)
        const fd = new FormData();
        fd.append("boardId", String(boardId));
        fd.append("title", title);
        fd.append("startDate", startDate);
        if (endDate) fd.append("endDate", endDate);
        fd.append("type", type);
        if (isEdit) fd.append("scheduleId", modal.dataset.scheduleId);

        const url = "/api/v1/admin/school/schedule";   // PATCH/POST ë™ì¼ URL
        const method = isEdit ? "PATCH" : "POST";

        btn.disabled = true;
        try {
            const res = await fetch(url, {method, body: fd});
            const json = await res.json();
            if (!json.isSuccess) throw new Error(json.message || "ì €ì¥ ì‹¤íŒ¨");

            alert(isEdit ? "ì¼ì •ì„ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤." : "ì¼ì •ì„ ë“±ë¡í–ˆìŠµë‹ˆë‹¤.");
            closeAddScheduleModal();               // ë‹«ìœ¼ë©´ì„œ dataset.scheduleId ë¹„ìš°ê¸°
            await fetchScheduleList(boardId, 0);   // ëª©ë¡ ê°±ì‹  (í”„ë¡œì íŠ¸ í•¨ìˆ˜ì— ë§ê²Œ)
        } catch (e) {
            console.error(e);
            alert("ì˜¤ë¥˜: " + e.message);
        } finally {
            btn.disabled = false;
        }
    }

    // ë²„íŠ¼ í´ë¦­ ë°”ì¸ë”© (ìœ„ì„)
    document.addEventListener("click", (e) => {
        if (e.target.closest("#scheduleSubmitBtn")) submitSchedule();
    });
</script>

<script id="loadIntroPage" type="module">

</script>

<script id="saveIntroPage" type="module">
    function collectIntro() {
        const titleInput = document.getElementById("intro-title");
        const descInput = document.getElementById("intro-description");

        const title = titleInput ? titleInput.value.trim() : "";
        const description = descInput ? descInput.value.trim() : "";

        const advantageInputs = document.querySelectorAll("#advantages-list input");
        const advantages = Array.from(advantageInputs)
            .map(i => i.value.trim())
            .filter(v => v.length > 0);

        return {
            title,
            description,
            advantages
        };
    }

    // ===== BasicInfo (ê¸°ë³¸ ì •ë³´) ìˆ˜ì§‘ =====
    function collectBasicInfo() {
        const schoolName = document.getElementById("basic-schoolName")?.value.trim() || "";
        const builtAt     = document.getElementById("basic-builtAt")?.value.trim() || "";
        const location    = document.getElementById("basic-location")?.value.trim() || "";
        const feature     = document.getElementById("basic-feature")?.value.trim() || "";

        return {
            schoolName,
            builtAt,
            location,
            feature
        };
    }

    // ===== ë§í¬ ëª©ë¡ (ì¶”ê°€ ë§í¬) ìˆ˜ì§‘ =====
    function collectUrls() {
        const urlNames = [];
        const url = [];

        const urlCards = document.querySelectorAll("#url-list > div, #url-list [data-url-card]");
        urlCards.forEach(card => {
            const inputs = card.querySelectorAll("input");
            if (inputs.length >= 2) {
                const nameValue = inputs[0].value.trim();
                const urlValue  = inputs[1].value.trim();

                if (nameValue || urlValue) {
                    urlNames.push(nameValue);
                    url.push(urlValue);
                }
            }
        });

        return {
            urlNames,
            url
        };
    }

    // ===== ë‹¨ê³¼ëŒ€(College) ìˆ˜ì§‘ =====
    // ì§€ê¸ˆ DTOëŠ” ë‹¨ê³¼ëŒ€ 1ê°œë§Œ ë°›ìœ¼ë¯€ë¡œ, ì²« ë²ˆì§¸ ì¹´ë“œë§Œ ì‚¬ìš©
    function collectCollegeDto() {
        const firstCard = document.querySelector("#college-list .college-card");
        if (!firstCard) {
            // ë‹¨ê³¼ëŒ€ ì…ë ¥ì´ ì—†ì„ ê²½ìš°, null ë°˜í™˜ (ë°±ì—”ë“œì—ì„œ nullable í—ˆìš©ì´ë©´)
            return null;
        }

        const nameInput = firstCard.querySelector('[data-role="college-name"]');
        const typeSelect = firstCard.querySelector('[data-role="college-type"]');
        const descTextarea = firstCard.querySelector('[data-role="college-description"]');

        const name = nameInput?.value.trim() || "";
        const description = descTextarea?.value.trim() || "";
        const type = typeSelect?.value || "UNDERGRADUATE";

        // í•™ê³¼ íƒœê·¸ë“¤ ìˆ˜ì§‘ â†’ "ì»´ê³µê³¼_ì „ê¸°ê³¼_..." í˜•íƒœ
        const deptChips = firstCard.querySelectorAll("[data-dept-name]");
        const deptList = Array.from(deptChips)
            .map(chip => chip.dataset.deptName || chip.textContent.trim())
            .filter(v => v.length > 0);

        const departments = deptList.join("_"); // DTO ìš”êµ¬ì‚¬í•­ëŒ€ë¡œ '_'ë¡œ join

        return {
            name,
            description,
            type,
            departments
        };
    }

    // ===== ë©”ì¸: ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œ =====
    async function saveIntroBoard() {
        // 1. ê° ë¶€ë¶„ ë°ì´í„° ìˆ˜ì§‘
        const intro = collectIntro();
        const basicInfo = collectBasicInfo();

        const rankRaw = document.getElementById("college-rank")?.value.trim() || "";
        const collegeRank = rankRaw === "" ? 0 : parseInt(rankRaw, 10) || 0;

        const urlsDto = collectUrls();
        const collegeDto = collectCollegeDto();

        const homepageUrl   = document.getElementById("homepage-url")?.value.trim() || "";
        const englishPageUrl = document.getElementById("english-url")?.value.trim() || "";

        // 2. DTO êµ¬ì¡°ì— ë§ëŠ” payload ìƒì„±
        const payload = {
            intro,          // IntroSaveDto
            basicInfo,      // BasicInfoSaveDto
            collegeRank,    // int
            urlsDto,        // HomepageUrlSaveDto
            collegeDto,     // CollegeSaveDto (ë˜ëŠ” null)
            homepageUrl,
            englishPageUrl
        };

        console.log("ë³´ë‚´ëŠ” TotalIntroSaveDto:", payload);

        const requestUrl = "/api/v1/school/intro"; // TODO: ì‹¤ì œ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë³€ê²½
        // try {
        //     // window.apiê°€ ìˆìœ¼ë©´:
        //     if (window.api && typeof window.api.post === "function") {
        //         const res = await window.api.post(requestUrl, payload);
        //         // ì„œë²„ ì‘ë‹µ êµ¬ì¡°ì— ë”°ë¼ ìˆ˜ì •
        //         alert("ì†Œê°œ í˜ì´ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        //         // í•„ìš”í•˜ë©´ ëª©ë¡ í™”ë©´ìœ¼ë¡œ ì´ë™
        //         // showBoardList();
        //         return;
        //     }
        //
        //     // api í—¬í¼ê°€ ì—†ë‹¤ë©´ fetch ì‚¬ìš©
        //     const res = await fetch(requestUrl, {
        //         method: "POST",
        //         headers: {
        //             "Content-Type": "application/json"
        //         },
        //         body: JSON.stringify(payload)
        //     });
        //
        //     if (!res.ok) {
        //         throw new Error("HTTP " + res.status);
        //     }
        //
        //     const data = await res.json().catch(() => null);
        //     console.log("ì„œë²„ ì‘ë‹µ:", data);
        //     alert("ì†Œê°œ í˜ì´ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        //     // showBoardList();
        // } catch (e) {
        //     console.error("ì†Œê°œ ì €ì¥ ì¤‘ ì˜¤ë¥˜:", e);
        //     alert("ì†Œê°œ í˜ì´ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        // }
    }

    window.saveIntroBoard = saveIntroBoard;

</script>

<script id="board-management" type="module">
    // fixme: ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ìœ„í•œ ì „ì—­ë³€ìˆ˜ ì¸ì§€ í™•ì¸ í•„ìš”, ì§€ì—­ ë³€ìˆ˜ë¡œ ë³€ê²½í•´ë„ ë˜ëŠ”ì§€ íŒŒì•… í•„ìš”
    window.currentView = "board-list";
    window.currentBoardName = "";
    window.currentPostTitle = "";

    const fileInputs = [
        document.getElementById("file-input-1"),
        document.getElementById("file-input-2"),
        document.getElementById("file-input-3")
    ];

    function toggleSchool(schoolId) {
        console.log("school " + schoolId);
        const arrow = document.getElementById(schoolId + "-arrow");
        const children = document.getElementById(schoolId + "-children");
        const node = arrow.closest(".tree-node");
        if (node.classList.contains("expanded")) {
            node.classList.remove("expanded");
            arrow.style.transform = "rotate(0deg)";
        } else {
            node.classList.add("expanded");
            arrow.style.transform = "rotate(90deg)";
        }
    }

    function showBoardList() {
        document.getElementById("board-list-view").classList.remove("hidden");
        document.getElementById("intro-board-editor").classList.add("hidden");
        document.getElementById("board-list-editor").classList.add("hidden");
        document.getElementById("schedule-list-editor").classList.add("hidden");
        document.getElementById("post-editor").classList.add("hidden");
        document.getElementById("filePost-editor").classList.add("hidden");
        window.currentView = "board-list";
    }

    function editBoardList(boardTitle, boardId, boardType) {
        window.currentBoardName = boardTitle;
        window.currentBoardId = boardId; // ì „ì—­ì— ì €ì¥
        window.currentBoardType = boardType;

        document.getElementById("board-list-title").textContent = boardTitle + " ê´€ë¦¬";
        document.getElementById("board-list-title").dataset.type = boardType;

        document.getElementById("board-list-view").classList.add("hidden");
        document.getElementById("intro-board-editor").classList.add("hidden");
        document.getElementById("board-list-editor").classList.remove("hidden");
        document.getElementById("post-editor").classList.add("hidden");
        document.getElementById("filePost-editor").classList.add("hidden");
        window.currentView = "board-list-editor";

        fetchPostList(boardId, 0); // â† ê²Œì‹œíŒ IDë¡œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    }

    function showBoardListEditor() {
        resetFilePostEditor();
        window.currentPostId = null;
        document.getElementById("board-list-view").classList.add("hidden");
        document.getElementById("intro-board-editor").classList.add("hidden");
        document.getElementById("board-list-editor").classList.remove("hidden");
        document.getElementById("schedule-list-editor").classList.add("hidden");
        document.getElementById("post-editor").classList.add("hidden");
        document.getElementById("filePost-editor").classList.add("hidden");
        window.currentView = "board-list-editor";
    }

    //ìŠ¤ì¼€ì¤„ ëª©ë¡ ê´€ë¦¬
    function editScheduleList(boardTitle, boardId, boardType) {
        window.currentBoardName = boardTitle;
        window.currentBoardId = boardId; // ì „ì—­ì— ì €ì¥
        window.currentBoardType = boardType;

        document.getElementById("board-list-title").textContent = boardTitle + " ê´€ë¦¬";
        document.getElementById("board-list-title").dataset.type = boardType;

        document.getElementById("board-list-view").classList.add("hidden");
        document.getElementById("intro-board-editor").classList.add("hidden");
        document.getElementById("board-list-editor").classList.add("hidden");
        document.getElementById("schedule-list-editor").classList.remove("hidden");
        document.getElementById("post-editor").classList.add("hidden");
        document.getElementById("filePost-editor").classList.add("hidden");
        window.currentView = "board-list-editor";

        fetchScheduleList(boardId, 0); // â† ê²Œì‹œíŒ IDë¡œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    }

    function editIntroBoard(boardName) {
        window.currentBoardName = boardName;
        document.getElementById("intro-board-title").textContent =
            boardName + " ìˆ˜ì •";
        document.getElementById("board-list-view").classList.add("hidden");
        document.getElementById("intro-board-editor").classList.remove("hidden");
        document.getElementById("board-list-editor").classList.add("hidden");
        document.getElementById("schedule-list-editor").classList.add("hidden");
        document.getElementById("post-editor").classList.add("hidden");
        document.getElementById("filePost-editor").classList.add("hidden");
        window.currentView = "intro-editor";
    }

    //intro editor ê´€ë ¨ javascript

    function addAdvantage() {
        const container = document.getElementById("advantages-list");
        if (!container) return;

        const div = document.createElement("div");
        // í•œ ì¤„ì— input + ì‚­ì œë²„íŠ¼, ë°˜ì‘í˜•ìœ¼ë¡œëŠ” ì„¸ë¡œ ìŒ“ì´ê²Œ
        div.className = "flex flex-col md:flex-row gap-2 items-stretch";

        const input = document.createElement("input");
        input.className = "dark-input flex-1";
        input.placeholder = "ê°•ì  ì…ë ¥ (ì˜ˆ: ë†’ì€ ì·¨ì—…ë¥ , ë‹¤ì–‘í•œ êµí™˜í•™ìƒ í”„ë¡œê·¸ë¨ ë“±)";

        const btn = document.createElement("button");
        btn.type = "button";
        btn.innerText = "ì‚­ì œ";
        btn.className =
            "px-3 py-2 rounded-button bg-gray-800 text-gray-300 text-xs md:text-sm " +
            "hover:bg-gray-700 border border-gray-700 whitespace-nowrap";
        btn.onclick = () => div.remove();

        div.appendChild(input);
        div.appendChild(btn);

        container.appendChild(div);
    }


    function addUrlField() {
        const container = document.getElementById("url-list");
        if (!container) return;

        const div = document.createElement("div");
        // ì¹´ë“œí˜•ìœ¼ë¡œ: ì–´ë‘ìš´ ë°°ê²½ + border
        div.className =
            "rounded-2xl border border-gray-800 bg-gray-900/70 p-3 md:p-4 space-y-3";

        div.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
                <label class="block text-xs font-medium text-gray-200 mb-1">
                    ë§í¬ ì´ë¦„
                </label>
                <input
                    class="dark-input"
                    placeholder="ì˜ˆ: ì…í•™ ì•ˆë‚´, ì¥í•™ ì œë„"
                />
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-200 mb-1">
                    URL
                </label>
                <input
                    class="dark-input"
                    placeholder="ì˜ˆ: https://www.example.ac.kr/admission"
                />
            </div>
        </div>
        <div class="flex justify-end">
            <button
                type="button"
                class="mt-1 inline-flex items-center px-3 py-1.5 rounded-button bg-gray-800 text-gray-300 text-xs hover:bg-gray-700 border border-gray-700"
                onclick="this.closest('[data-url-card]')?.remove()">
                <i class="ri-delete-bin-line mr-1 text-sm"></i>
                ë§í¬ ì‚­ì œ
            </button>
        </div>
    `;

        // ì‚­ì œ ë²„íŠ¼ì—ì„œ closestë¡œ ì°¾ì„ ìˆ˜ ìˆê²Œ data ì†ì„± ë¶€ì—¬
        div.setAttribute("data-url-card", "true");

        container.appendChild(div);
    }

    let collegeCounter = 0;

    function addCollege() {
        const list = document.getElementById("college-list");
        const index = collegeCounter++;

        const wrapper = document.createElement("div");
        wrapper.className = "college-card border border-gray-800 rounded-2xl bg-gray-900/70 p-4 md:p-5 space-y-4";
        wrapper.dataset.collegeIndex = String(index);

        // ë‹¨ê³¼ëŒ€ ì¹´ë“œ ë‚´ë¶€ êµ¬ì¡°
        wrapper.innerHTML = `
            <div class="flex items-start justify-between gap-3">
                <div class="flex-1 space-y-3">

                    <!-- ë‹¨ê³¼ëŒ€ ì´ë¦„ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-200 mb-1">
                            ë‹¨ê³¼ëŒ€ ì´ë¦„
                        </label>
                        <input
                            type="text"
                            class="dark-input"
                            data-role="college-name"
                            placeholder="ì˜ˆ: ê³µê³¼ëŒ€í•™"
                        />
                    </div>

                    <!-- í•™ìœ„ êµ¬ë¶„ + ì„¤ëª… -->
                    <div>
                        <label class="block text-sm font-medium text-gray-200 mb-1">
                            í•™ìœ„ êµ¬ë¶„
                        </label>
                        <select class="dark-input" data-role="college-type">
                            <option value="UNDERGRADUATE">í•™ì‚¬ ê³¼ì •</option>
                            <option value="GRADUATE">ì„/ë°•ì‚¬ ê³¼ì •</option>
                        </select>
                        <p class="field-help">í•´ë‹¹ ë‹¨ê³¼ëŒ€ì˜ ì£¼ êµìœ¡ ê³¼ì •ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
                    </div>

                    <!-- ë‹¨ê³¼ëŒ€ ì„¤ëª… -->
                    <div>
                        <label class="block text-sm font-medium text-gray-200 mb-1">
                            ë‹¨ê³¼ëŒ€ ì„¤ëª… (ì„ íƒ)
                        </label>
                        <textarea
                            class="dark-input !rounded-2xl !h-20 !py-2.5 resize-none"
                            data-role="college-description"
                            placeholder="ë‹¨ê³¼ëŒ€ì˜ ì£¼ìš” ì „ê³µ ë° íŠ¹ì§•ì„ ê°„ë‹¨íˆ ì†Œê°œí•´ ì£¼ì„¸ìš”."></textarea>
                    </div>

                    <!-- í•™ê³¼(ê³¼) íƒœê·¸ ì˜ì—­ -->
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <label class="block text-sm font-medium text-gray-200">
                                ì†Œì† í•™ê³¼
                            </label>
                            <span class="text-xs text-gray-500">
                                í•™ê³¼ëª…ì„ ì…ë ¥ í›„ Enterë¥¼ ëˆ„ë¥´ë©´ ì¶”ê°€ë©ë‹ˆë‹¤.
                            </span>
                        </div>

                        <!-- íƒœê·¸ë“¤ì´ ìŒ“ì´ëŠ” ê³³ -->
                        <div class="flex flex-wrap gap-2 mb-2" data-role="department-chips"></div>

                        <!-- í•™ê³¼ ì…ë ¥ -->
                        <input
                            type="text"
                            class="dark-input"
                            data-role="department-input"
                            placeholder="ì˜ˆ: ì»´í“¨í„°ê³µí•™ê³¼, ì „ê¸°ê³µí•™ê³¼ ë“± ì…ë ¥ í›„ Enter"
                        />
                    </div>
                </div>

                <!-- ë‹¨ê³¼ëŒ€ ì‚­ì œ ë²„íŠ¼ -->
                <button
                    type="button"
                    class="ml-2 text-gray-500 hover:text-red-500 text-sm flex-shrink-0"
                    onclick="removeCollege(this)">
                    <i class="ri-close-line mr-0.5"></i> ì‚­ì œ
                </button>
            </div>
        `;

        list.appendChild(wrapper);
        setupDepartmentInput(wrapper);
    }

    function removeCollege(button) {
        const card = button.closest(".college-card");
        if (card) {
            card.remove();
        }
    }

    function setupDepartmentInput(collegeElement) {
        const input = collegeElement.querySelector('[data-role="department-input"]');
        const chipsContainer = collegeElement.querySelector('[data-role="department-chips"]');

        if (!input || !chipsContainer) return;

        // Enter í‚¤ë¡œ íƒœê·¸ ì¶”ê°€
        input.addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                const value = input.value.trim();
                if (!value) return;

                addDepartmentChip(chipsContainer, value);
                input.value = "";
            }
        });
    }

    function addDepartmentChip(container, name) {
        // ê°™ì€ ì´ë¦„ ì¤‘ë³µ ë°©ì§€ (ì›í•˜ë©´ ì œê±°)
        const exists = Array.from(container.querySelectorAll("[data-dept-name]"))
            .some(span => span.dataset.deptName === name);
        if (exists) return;

        const chip = document.createElement("span");
        chip.className = "inline-flex items-center px-2.5 py-1 rounded-full bg-gray-800 text-gray-100 text-xs border border-gray-600";
        chip.dataset.deptName = name;

        chip.innerHTML = `
            <span class="mr-1">${name}</span>
            <button type="button" class="text-gray-400 hover:text-red-400 text-xs"
                    onclick="this.parentElement.remove()">
                <i class="ri-close-line"></i>
            </button>
        `;

        container.appendChild(chip);
    }

    window.addCollege = addCollege;
    window.removeCollege = removeCollege;
    window.addAdvantage = addAdvantage;
    window.addUrlField = addUrlField;


    async function deleteBoard(boardName, boardId) {
        if (confirm(`"${boardName}" ê²Œì‹œíŒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            try {
                const response = await fetch("/api/v1/admin/school/board", {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({boardId: boardId})
                });

                const result = await response.json();
                if (result.isSuccess) {
                    // ì•Œë¦¼ í‘œì‹œ
                    const notification = document.createElement("div");
                    notification.className =
                        "fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
                    notification.textContent = "ê²Œì‹œíŒì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤";
                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.remove();
                        location.reload(); // ìƒˆë¡œê³ ì¹¨
                    }, 1500);
                } else {
                    alert("ì‚­ì œ ì‹¤íŒ¨: " + result.message);
                }
            } catch (e) {
                console.error("ì‚­ì œ ì˜¤ë¥˜:", e);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }
    }

    function createNewPost() {
        document.getElementById("post-editor-title").textContent = "ìƒˆ ê²Œì‹œê¸€ ì‘ì„±";
        const type = window.currentBoardType
        console.log("createNewPost type:", type);
        document.querySelector('#post-editor input[type="text"]').value = "";
        document.querySelector("#post-editor textarea").value = "";

        document.getElementById("board-list-view").classList.add("hidden");
        document.getElementById("intro-board-editor").classList.add("hidden");
        document.getElementById("board-list-editor").classList.add("hidden");
        document.getElementById("schedule-list-editor").classList.add("hidden");

        if (type === "NOTICE") {
            document.getElementById("post-editor").classList.remove("hidden");
            document.getElementById("filePost-editor").classList.add("hidden");
            window.currentView = "post-editor";
        } else {
            document.getElementById("filePost-editor").classList.remove("hidden");
            document.getElementById("post-editor").classList.add("hidden");
            window.currentView = "filePost-editor";
        }
    }

    async function editPost(postTitle, postId, type) {
        console.log(postTitle, postId);
        window.currentPostTitle = postTitle;
        console.log("editPostì—ì„œ " + window.currentPostTitle);
        console.log("type:", type);
        window.currentPostId = postId;
        try {
            const url = "/api/v1/admin/school/" + ((type === "FILES") ? "file" : "post") + `?postId=${postId}`;
            const response = await fetch(url);

            const result = await response.json();
            console.log("ê°’ ê°€ì ¸ì˜´");

            if (result.isSuccess) {
                const post = result.result.post;
                const files = result.result.file;

                if (type === "NOTICE") {
                    console.log("NOTICEíƒ€ì…");
                    // 1. ì œëª©, ì„¤ëª… ì„¸íŒ…
                    const textInputs = document.querySelectorAll('#post-editor input[type="text"]');
                    textInputs[0].value = post.title;
                    textInputs[1].value = post.description;

                    // 2. ë‚´ìš© ì„¸íŒ… (SunEditor)
                    editor.setContents(post.content);

                    // 3. ì¹´í…Œê³ ë¦¬ ì„¤ì • (select)
                    const type = post.type === 'NOTICE' ? 'ê³µì§€ì‚¬í•­' : 'ì¼ë°˜';
                    const select = document.querySelector('#post-editor select');
                    for (let i = 0; i < select.options.length; i++) {
                        if (select.options[i].text === type) {
                            select.selectedIndex = i;
                            break;
                        }
                    }

                    //4.íŒŒì¼ ê°€ì ¸ì˜¨ê±° ì¶”ê°€í•´ì£¼ê¸°
                    for (let i = 0; i < 3; i++) {
                        const nameDiv = document.getElementById(`file-name-${i + 1}`);
                        const input = document.getElementById(`file-input-${i + 1}`);

                        if (files[i]) {
                            nameDiv.textContent = `ğŸ“ ${files[i].name}`;
                            // ë®ì–´ì“´ íŒŒì¼ êµ¬ë¶„ ìœ„í•´ fileId ì €ì¥
                            input.dataset.existingFileId = files[i].fileId;
                            const clearButton = document.querySelector(`.clear-btn[data-index="${i + 1}"]`);
                            clearButton.classList.remove("hidden");
                        } else {
                            nameDiv.textContent = "";
                            delete input.dataset.existingFileId;
                        }
                    }

                    // UI ë³´ì—¬ì£¼ê¸°
                    document.getElementById("post-editor-title").textContent = "ê²Œì‹œê¸€ ìˆ˜ì • - " + post.title;
                    document.getElementById("board-list-view").classList.add("hidden");
                    document.getElementById("intro-board-editor").classList.add("hidden");
                    document.getElementById("board-list-editor").classList.add("hidden");
                    document.getElementById("schedule-list-editor").classList.add("hidden");
                    document.getElementById("post-editor").classList.remove("hidden");
                    document.getElementById("filePost-editor").classList.add("hidden");
                    window.currentView = "post-editor";
                } else if (type === "FILES") {
                    console.log("FILESíƒ€ì…");
                    const textInputs = document.querySelectorAll('#filePost-editor input[type="text"]');
                    textInputs[0].value = post.title;

                    // 3. ì¹´í…Œê³ ë¦¬ ì„¤ì • (select)
                    const type = post.type === 'NOTICE' ? 'ê³µì§€ì‚¬í•­' : 'ì¼ë°˜';
                    const select = document.querySelector('#filePost-editor select');
                    for (let i = 0; i < select.options.length; i++) {
                        if (select.options[i].text === type) {
                            select.selectedIndex = i;
                            break;
                        }
                    }

                    const nameDiv = document.getElementById(`postFile-name`);
                    const input = document.getElementById(`postFile-input`);
                    if (files) {
                        nameDiv.textContent = `ğŸ“ ${files.name}`;
                        // ë®ì–´ì“´ íŒŒì¼ êµ¬ë¶„ ìœ„í•´ fileId ì €ì¥
                        input.dataset.existingFileId = files.fileId;
                        const clearBtn = document.getElementById("clear-postFile");
                        clearBtn.classList.remove("hidden");
                    } else {
                        nameDiv.textContent = "";
                        delete input.dataset.existingFileId;
                    }

                    // UI ë³´ì—¬ì£¼ê¸°
                    document.getElementById("post-editor-title").textContent = "ê²Œì‹œê¸€ ìˆ˜ì • - " + post.title;
                    document.getElementById("board-list-view").classList.add("hidden");
                    document.getElementById("intro-board-editor").classList.add("hidden");
                    document.getElementById("board-list-editor").classList.add("hidden");
                    document.getElementById("schedule-list-editor").classList.add("hidden");
                    document.getElementById("post-editor").classList.add("hidden");
                    document.getElementById("filePost-editor").classList.remove("hidden");
                    window.currentView = "post-editor";
                }
            } else {
                alert("ê²Œì‹œê¸€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                window.currentPostId = null;
            }

        } catch (e) {
            console.error("ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", e);
            alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    async function savePost(status) {
        const boardId = Number(window.currentBoardId);
        const title = document.querySelector('#post-editor input[type="text"]').value.trim();
        const description = document.querySelectorAll('#post-editor input[type="text"]')[1].value.trim();
        const content = editor.getContents();
        const category = document.querySelector('#post-editor select').value;
        const type = category === 'ê³µì§€ì‚¬í•­' ? 'NOTICE' : 'NORMAL';

        const formData = new FormData();
        formData.append("boardId", boardId);
        formData.append("title", title);
        formData.append("description", description);
        formData.append("content", content);
        formData.append("status", status);
        formData.append("type", type);

        const filesToDelete = [];

        fileInputs.forEach(input => {
            const existingFileId = input.dataset.existingFileId;
            const index = input.dataset.index;
            const fileNameDisplay = document.querySelector(`.file-name[data-index="${index}"]`);

            if (input.files.length > 0) {
                formData.append("files", input.files[0]);
                if (existingFileId) {
                    filesToDelete.push(existingFileId);
                }
            } else if (existingFileId && (!fileNameDisplay.textContent || fileNameDisplay.textContent.trim() === '')) {
                filesToDelete.push(existingFileId);
            }
        });

        filesToDelete.forEach(fileId => {
            formData.append("deleteFileIds", fileId);
        });

        try {
            if (window.currentPostId) {
                formData.append("postId", window.currentPostId);
            }
            const response = await fetch("/api/v1/admin/school/post", {
                method: window.currentPostId ? "PATCH" : "POST",
                body: formData
            });

            const result = await response.json();
            window.currentPostId = null;

            if (result.isSuccess) {
                alert("ê²Œì‹œê¸€ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                resetPostEditor();
                await fetchPostList(boardId, 0); // â† ê²Œì‹œíŒ IDë¡œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
                showBoardListEditor();
            } else {
                throw new Error(result.message || "ì €ì¥ ì‹¤íŒ¨");
            }
        } catch (e) {
            console.error(e);
            alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
        }
    }

    async function saveFilePost(status) {

        console.log("saveFilePost");

        const boardId = Number(window.currentBoardId);

        const title = document.querySelector('#filePost-editor input[type="text"]').value.trim();
        const category = document.querySelector('#filePost-editor select').value;
        const type = category === 'ê³µì§€ì‚¬í•­' ? 'NOTICE' : 'NORMAL';

        const formData = new FormData();
        formData.append("boardId", boardId);
        formData.append("title", title);
        formData.append("status", status);
        formData.append("type", type);

        let filesToDelete;

        const fileInput = document.getElementById("postFile-input");

        console.log("fileInput", fileInput);

        if (fileInput) {
            const existingFileId = fileInput.dataset.existingFileId;
            const fileNameDisplay = document.getElementById(`postFile-name`);

            if (fileInput.files.length > 0) {
                formData.append("files", fileInput.files[0]);
                if (existingFileId) {
                    filesToDelete = existingFileId;
                } else if (existingFileId && (!fileNameDisplay.textContent || fileNameDisplay.textContent.trim() === '')) {
                    filesToDelete = existingFileId;
                }
            }
        }

        formData.append("deleteFileIds", filesToDelete);

        try {
            if (window.currentPostId) {
                formData.append("postId", window.currentPostId);
            }

            console.log("forData:", formData);

            const response = await fetch("/api/v1/admin/school/file", {
                method: window.currentPostId ? "PATCH" : "POST",
                body: formData
            });

            const result = await response.json();
            window.currentPostId = null;

            if (result.isSuccess) {
                alert("ê²Œì‹œê¸€ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                resetFilePostEditor();
                await fetchPostList(boardId, 0); // â† ê²Œì‹œíŒ IDë¡œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
                showBoardListEditor();
            } else {
                throw new Error(result.message || "ì €ì¥ ì‹¤íŒ¨");
                console.log("ì €ì¥ ì‹¤íŒ¨");
            }
        } catch (e) {
            console.error(e);
            alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
        }
    }


    const clearButtons = document.querySelectorAll('.clear-btn');
    clearButtons.forEach(button => {
        button.addEventListener('click', () => {
            console.log("ì´ˆê¸°í™” í´ë¦­");
            const index = button.dataset.index;
            const fileInput = document.querySelector(`.file-input[data-index="${index}"]`);
            const fileNameDisplay = document.querySelector(`.file-name[data-index="${index}"]`);

            fileInput.value = '';
            fileNameDisplay.textContent = '';
            button.classList.add('hidden');
        });
    });

    // export module functions
    window.toggleSchool = toggleSchool;
    window.showBoardList = showBoardList;
    window.editBoardList = editBoardList;
    window.showBoardListEditor = showBoardListEditor;
    window.editScheduleList = editScheduleList;
    window.editIntroBoard = editIntroBoard;
    window.deleteBoard = deleteBoard;
    window.createNewPost = createNewPost;
    window.editPost = editPost;
    window.savePost = savePost;
    window.saveFilePost = saveFilePost
</script>
<script type="module">
    // fixme: board-management ëª¨ë“ˆê³¼ í•©ì³ë„ ë  ì§€ ê³ ë¯¼ í•„ìš”
    function renderPagination(pageData, boardId) {
        const paginationContainer = document.getElementById("pagination");
        console.log(paginationContainer + "ê°€ì ¸ì˜´");
        paginationContainer.innerHTML = "";

        const {totalPages, number} = pageData;

        // fix ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€ì— ë²„íŠ¼ì´ ìƒê¹€

        // ì´ì „ ë²„íŠ¼
        const prev = document.createElement("button");
        prev.innerHTML = `<i class="ri-arrow-left-line"></i>`;
        prev.className = "px-3 py-2 text-gray-400 hover:text-white transition-colors";
        prev.disabled = number === 0;
        prev.onclick = () => fetchPostList(boardId, number - 1);
        paginationContainer.appendChild(prev);

        for (let i = 0; i < totalPages; i++) {
            const btn = document.createElement("button");
            btn.textContent = i + 1;
            btn.className = `px-3 py-2 ${i === number ? 'bg-primary text-white' : 'text-gray-400 hover:text-white'}`;
            btn.onclick = () => fetchPostList(boardId, i);
            paginationContainer.appendChild(btn);
        }

        // ë‹¤ìŒ ë²„íŠ¼
        const next = document.createElement("button");
        next.innerHTML = `<i class="ri-arrow-right-line"></i>`;
        next.className = "px-3 py-2 text-gray-400 hover:text-white transition-colors";
        next.disabled = number >= totalPages - 1;
        next.onclick = () => fetchPostList(boardId, number + 1);
        paginationContainer.appendChild(next);
    }

    function renderPostTable(posts) {
        const tbody = document.getElementById("post-table-body");
        console.log("tbody:" + tbody);
        tbody.innerHTML = ''; // ê¸°ì¡´  í…Œì´ë¸” ë¹„ìš°ê¸°

        posts.forEach(post => {
            const id = post.id;
            const isNotice = post.type === "NOTICE";
            const isTemp = post.status === "TEMPORARY";

            const row = document.createElement("tr");
            row.className = "table-row border-b border-gray-700";

            row.innerHTML = `
        <td class="p-3">
            <div class="flex items-center">
                ${isNotice ? '<span class="status-badge px-2 py-1 bg-red-500 bg-opacity-20 text-red-400 text-xs rounded-full mr-3">ê³µì§€</span>' : ''}
                <span class="text-white">${post.title}</span>
            </div>
        </td>
        <td class="p-3 text-gray-300">${post.writer || 'ê´€ë¦¬ì'}</td>
        <td class="p-3 text-gray-400">${post.createdAt || '-'}</td>
        <td class="p-3 text-gray-300">${post.views}</td>
        <td class="p-3">
            <span class="status-badge px-2 py-1 ${isTemp ? 'bg-yellow-500 text-yellow-400' : 'bg-green-500 text-green-400'} bg-opacity-20 text-xs rounded-full">
                ${isTemp ? 'ì„ì‹œì €ì¥' : 'ê²Œì‹œì¤‘'}
            </span>
        </td>
        <td class="p-3">
            <div class="flex space-x-2">
                <button
                    data-post-title="${post.title}"
                    data-post-id="${post.id}"
                    data-post-type="${post.postType}"
                    onclick="editPost(this.dataset.postTitle, this.dataset.postId, this.dataset.postType)"
                    class="px-3 py-1 bg-primary text-white text-sm rounded-button hover:bg-blue-600 transition-colors whitespace-nowrap">
                    ìˆ˜ì •
                </button>
                <button
                data-post-type="${post.postType}"
                data-post-id="${post.id}"
                onclick="deletePost(this.dataset.postId,this.dataset.postType)" class="px-3 py-1 bg-red-600 text-white text-sm rounded-button hover:bg-red-700 transition-colors whitespace-nowrap">ì‚­ì œ</button>
            </div>
        </td>
    `;
            tbody.appendChild(row);
        });
    }

    async function deletePost(postId, type) {
        if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        console.log("postId:", postId);
        try {
            const url = "/api/v1/admin/school/" + ((type === "NOTICE") ? "post" : "file");
            console.log("type:", type);
            console.log("url:", url);
            const response = await fetch(url, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({postId})
            });

            const result = await response.json();
            if (result.isSuccess) {
                alert("ì‚­ì œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                fetchPostList(window.currentBoardId); // ì‚­ì œ í›„ ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            } else {
                alert("ì‚­ì œ ì‹¤íŒ¨: " + result.message);
            }
        } catch (e) {
            console.error(e);
            alert("ì„œë²„ ì˜¤ë¥˜: ì‚­ì œ ìš”ì²­ ì‹¤íŒ¨");
        }
    }

    async function fetchPostList(boardId, page = 0) {
        const status = document.querySelector("#board-list-editor select").value; // í•„í„° (ì˜ˆ: ì „ì²´, PUBLISHED, TEMP)
        const keyword = document.querySelector("#board-list-editor input[type='text']").value.trim();

        const statusMap = {
            "ì¼ë°˜": "NORMAL",
            "ê³µì§€": "NOTICE",
            "ì „ì²´": "ALL"
        };

        const params = new URLSearchParams({
            boardId: boardId,
            page: page,
            size: 10,
            keyword: keyword,
            status: statusMap[status] ?? null
        });

        try {
            const response = await fetch(`/api/v1/admin/school/posts?${params.toString()}`);
            const result = await response.json();
            console.log("ê°’ ê°€ì ¸ì˜´");
            if (result.isSuccess) {
                console.log("ë°ì´í„°:" + result.result.content);
                renderPostTable(result.result.content); // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
                renderPagination(result.result, boardId); // í˜ì´ì§• ë Œë”ë§
            } else {
                alert("ê²Œì‹œê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + result.message);
            }
        } catch (e) {
            console.error(e);
            alert("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
        }
    }

    // export module functions
    window.deleteBoard = deleteBoard;
    window.fetchPostList = fetchPostList;
</script>
<script id="toggle-switches" type="module">
    const toggles = document.querySelectorAll('input[type="checkbox"]');
    toggles.forEach((toggle) => {
        const toggleContainer = toggle.nextElementSibling;
        const toggleBg = toggleContainer.querySelector("div:first-child");
        const toggleThumb = toggleContainer.querySelector("div:last-child");
        toggle.addEventListener("change", function () {
            if (this.checked) {
                toggleBg.classList.remove("bg-gray-600");
                toggleBg.classList.add("bg-primary");
                toggleThumb.classList.add("translate-x-5");
            } else {
                toggleBg.classList.remove("bg-primary");
                toggleBg.classList.add("bg-gray-600");
                toggleThumb.classList.remove("translate-x-5");
            }
        });
    });
    const boardTypeRadios = document.querySelectorAll('input[name="boardType"]');
    boardTypeRadios.forEach((radio) => {
        radio.addEventListener("change", function () {
            const labels = document.querySelectorAll("label.relative");
            labels.forEach((label) => {
                const border = label.querySelector(".absolute");
                if (label.contains(this)) {
                    border.classList.remove("opacity-0");
                    border.classList.add("opacity-100");
                } else {
                    border.classList.remove("opacity-100");
                    border.classList.add("opacity-0");
                }
            });
        });
    });
</script>
<script type="module">
    function submitAddCategory() {
        const modal = document.getElementById("addCategoryModal");
        const schoolId = modal.dataset.schoolId;

        const boardTitle = document.querySelector('input[placeholder="ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"]').value;
        const boardDescription = document.querySelectorAll('input[placeholder="ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"]')[1].value;

        const boardTypeValue = document.querySelector('input[name="boardType"]:checked').value;

        console.log("boardType:", boardTypeValue);

        let boardType;
        if (boardTypeValue === "intro") boardType = "intro";
        else if (boardTypeValue === "files") boardType = "files";
        else if (boardTypeValue === "schedule") boardType = "schedule";
        else boardType = "notice"; // ê¸°ë³¸ê°’

        const data = {
            schoolId: Number(schoolId),
            boardTitle: boardTitle,
            realTitle: boardTitle, // í•„ìš”ì‹œ ë‹¤ë¥¸ ê°’ìœ¼ë¡œ ìˆ˜ì •
            boardDescription: boardDescription,
            boardType: boardType
        };

        fetch("/api/v1/admin/school/board", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("ì¹´í…Œê³ ë¦¬ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
                return response.json();
            })
            .then(result => {
                alert("ì¹´í…Œê³ ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                window.location.href = "/admin/school";
            })
            .catch(error => {
                console.error(error);
                alert("ì—ëŸ¬ ë°œìƒ: " + error.message);
            });
    }

    // export module functions
    window.submitAddCategory = submitAddCategory;
</script>

<script id="textEdit" type="module">
    const editor = SUNEDITOR.create('intro-editor', {
        lang: SUNEDITOR_LANG['ko'],
        height: '300px',
        width: '100%',
        placeholder: 'í•™êµ ì†Œê°œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...',
        buttonList: [
            ['undo', 'redo', 'formatBlock', 'fontSize', 'bold', 'underline', 'italic', 'strike',
                'fontColor', 'hiliteColor', 'align', 'list', 'table', 'link', 'image', 'codeView']
        ],
        imageUploadUrl: '/api/v1/file/school',
        withCredentials: true,
        imageUploadName: 'file',
        imageMultipleFile: false
    });

    // export module functions
    window.editor = editor;
</script>

<script type="module">
    // íŒŒì¼ ì…ë ¥
    document.querySelectorAll('input[type="file"]').forEach((fileInput) => {
        const type = fileInput.dataset.type; // file or image
        const container = fileInput.closest('.space-y-3');
        const fileNameDisplay = type === "image"
            ? container?.querySelector('.image-input')
            : container?.querySelector('.file-name, #postFile-name');

        if (fileNameDisplay) {
            fileInput.addEventListener("change", function () {
                const index = fileInput.dataset.index;
                const clearButton = document.querySelector(`.clear-btn[data-index="${index}"], #clear-postFile`);

                fileNameDisplay.textContent = this.files.length > 0
                    ? `ì„ íƒëœ íŒŒì¼: ${this.files[0].name}`
                    : '';

                if (clearButton) {
                    clearButton.classList.remove('hidden');
                }
            });
        }
    });

    function resetPostEditor() {
        // ì œëª©, ì„¤ëª… ì´ˆê¸°í™”
        const textInputs = document.querySelectorAll('#post-editor input[type="text"]');
        textInputs.forEach(input => input.value = "");

        // SunEditor ë‚´ìš© ì´ˆê¸°í™”
        editor.setContents("");

        // ì¹´í…Œê³ ë¦¬ select ì´ˆê¸°í™”
        document.querySelector('#post-editor select').selectedIndex = 0;

        // íŒŒì¼ input ì´ˆê¸°í™”
        for (let i = 1; i <= 3; i++) {
            const input = document.getElementById(`file-input-${i}`);
            if (input) input.value = "";
            const label = document.getElementById(`file-name-${i}`);
            if (label) label.textContent = "";
        }

    }

    function resetFilePostEditor() {
        // ì œëª©, ì„¤ëª… ì´ˆê¸°í™”
        const textInputs = document.querySelectorAll('#filePost-editor input[type="text"]');
        textInputs.forEach(input => input.value = "");

        // ì¹´í…Œê³ ë¦¬ select ì´ˆê¸°í™”
        document.querySelector('#filePost-editor select').selectedIndex = 0;
        //íŒŒì¼ ì´ˆê¸°í™”
        const input = document.getElementById(`postFile-input`);
        if (input) input.value = "";
        const nameDiv = document.getElementById(`postFile-name`);
        if (nameDiv) nameDiv.textContent = "";
        const clearBtn = document.getElementById(`clear-postFile`);
        if (clearBtn) clearBtn.classList.add("hidden");

    }

    // export module functions
    window.resetPostEditor = resetPostEditor;
    window.resetFilePostEditor = resetFilePostEditor;
</script>
<script type="module">
    const boardTypeRadios = document.querySelectorAll('input[name="boardType"]');

    boardTypeRadios.forEach((radio) => {
        radio.addEventListener("change", function () {
            const allLabels = document.querySelectorAll('label.relative');
            allLabels.forEach((label) => {
                const border = label.querySelector(".absolute");
                border.classList.remove("opacity-100");
                border.classList.add("opacity-0");
            });

            const selectedLabel = this.closest("label.relative");
            const border = selectedLabel.querySelector(".absolute");
            border.classList.remove("opacity-0");
            border.classList.add("opacity-100");
        });
    });
</script>
</body>
</html>