<!DOCTYPE html>
<html th:replace="~{fragments/layout/base :: base(~{::head}, ~{::body})}" xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <title>게시판 관리</title>
    <!--    편집툴-->
    <link href="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/css/suneditor.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/suneditor.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/src/lang/ko.js"></script>
    <style>
        :where([class^="ri-"])::before {
            content: "\f3c2";
        }

        .admin-card {
            background: linear-gradient(145deg, #2C2C3A, #232331);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .table-header {
            background: linear-gradient(135deg, #343446, #2A2A3C);
        }

        .table-row:hover {
            background: rgba(52, 152, 219, 0.1);
        }

        .status-badge {
            backdrop-filter: blur(10px);
        }

        .tree-node {
            transition: all 0.3s ease;
        }

        .tree-node.expanded > .tree-children {
            max-height: 1000px;
            opacity: 1;
        }

        .tree-children {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .editor-toolbar {
            background: linear-gradient(135deg, #343446, #2A2A3C);
            border-bottom: 1px solid #374151;
        }

        .editor-content {
            min-height: 400px;
            background: #1F2937;
            color: #F9FAFB;
        }

        .board-type-tag {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
        }

        .dark-input {
            width: 100%;
            padding: 0.6rem 0.9rem;
            border-radius: 9999px;
            background-color: #111827;
            border: 1px solid #374151;
            color: #e5e7eb;
            font-size: 0.875rem;
            outline: none;
            transition: all 0.15s ease-in-out;
        }

        .dark-input::placeholder {
            color: #6b7280;
        }

        .dark-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59,130,246,0.35);
            background-color: #020617;
        }

        .field-help {
            margin-top: 0.25rem;
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.25rem;
        }

        .section-header-line {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #374151;
        }

        .section-helper {
            font-size: 0.75rem;
            color: #9ca3af;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/school/admin/modals.html :: modals}"></div>
<div class="bg-gradient-to-br from-gray-900 via-slate-800 to-gray-900 min-h-screen text-gray-100">
    <div class="flex">

        <!--    leftSide-->

        <aside th:replace="~{adminpage/common/leftSide :: leftSide}"></aside>

        <main class="flex-1 p-8">
            <div th:replace="~{fragments/school/admin/board-list.html :: boardList(schoolDto=${schoolDto})}"></div>

            <div th:replace="~{fragments/school/admin/intro-editor :: introEditor()}"></div>

            <div th:replace="~{fragments/school/admin/board-list-editor.html :: board-list-editor}"></div>

            <div th:replace="~{fragments/school/admin/schedule-list-editor.html :: schedule-list-editor}"></div>

            <div th:replace="~{fragments/school/admin/post-editor.html :: postEditor}"></div>

            <div th:replace="~{fragments/school/admin/file-post-editor.html :: filePostEditor}"></div>

        </main>
    </div>
</div>

<script id="modal-functions" type="module">
    window.openAddBoardModal = function () {
        document.getElementById("addBoardModal").classList.remove("hidden");
    };
    window.closeAddBoardModal = function () {
        document.getElementById("addBoardModal").classList.add("hidden");
    };
    window.openCategoryModal = function () {
        document.getElementById("categoryModal").classList.remove("hidden");
    };
    window.closeCategoryModal = function () {
        document.getElementById("categoryModal").classList.add("hidden");
    };

    window.openAddCategoryModal = function (buttonElement) {
        const modal = document.getElementById("addCategoryModal");
        const schoolId = buttonElement.dataset.schoolId;
        modal.dataset.schoolId = schoolId;
        modal.classList.remove("hidden");
    };

    window.closeAddCategoryModal = function () {
        const modal = document.getElementById("addCategoryModal");
        modal.classList.add("hidden");
        modal.dataset.schoolId = "";
    };

    window.deleteCategory = function (categoryName) {
        if (confirm(`"${categoryName}" 카테고리를 삭제하시겠습니까?`)) {
            const notification = document.createElement("div");
            notification.className =
                "fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
            notification.textContent = "카테고리가 삭제되었습니다";
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    };

    window.saveNewBoard = async function () {
        const koreanNameInput = document.querySelectorAll(
            '#addBoardModal input[type="text"]'
        )[0]; // 한국어 이름
        const englishNameInput = document.querySelectorAll(
            '#addBoardModal input[type="text"]'
        )[1]; // 영어 이름
        const logoUrlInput = document.querySelector('#addBoardModal input[type="url"]');

        const schoolKoreanName = koreanNameInput.value.trim();
        const schoolEnglishName = englishNameInput.value.trim();
        const imgUrl = logoUrlInput.value.trim();

        if (!schoolKoreanName || !schoolEnglishName || !imgUrl) {
            const notification = document.createElement("div");
            notification.className =
                "fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
            notification.textContent = "모든 항목을 입력해주세요";
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
            return;
        }

        const payload = {
            schoolKoreanName: schoolKoreanName,
            schoolEnglishName: schoolEnglishName,
            imgUrl: imgUrl,
        };

        try {
            const response = await fetch("/api/v1/admin/school/save", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            });

            const result = await response.json();

            if (result.isSuccess) {
                const notification = document.createElement("div");
                notification.className =
                    "fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
                notification.textContent = "새 게시판이 추가되었습니다";
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
                closeAddBoardModal();
                location.reload(); // 새로고침해서 반영
            } else {
                throw new Error(result.message || "추가 실패");
            }
        } catch (error) {
            const notification = document.createElement("div");
            notification.className =
                "fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
            notification.textContent = "오류 발생: " + error.message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    };
</script>
<script id="schedule-modal-functions" type="module">
    // 신규 작성 열기
    window.openAddScheduleModal = function () {
        const modal = document.getElementById("addScheduleModal");
        // 모드 초기화
        modal.dataset.scheduleId = "";
        document.getElementById("scheduleTitle").value = "";
        document.getElementById("scheduleStartDate").value = "";
        document.getElementById("scheduleEndDate").value = "";
        // 기본 타입 체크
        document.querySelector('input[name="scheduleType"][value="ACADEMIC"]').checked = true;

        // 타이틀도 바꾸고 열기
        modal.querySelector("h3").textContent = "새 일정 추가";
        modal.classList.remove("hidden");
        modal.setAttribute("aria-hidden", "false");
    };

    // 수정 모드 열기 (스케줄 데이터 넣어줌)
    window.openEditScheduleModal = async function (scheduleId) {
        const modal = document.getElementById("addScheduleModal");
        const res = await fetch(`/api/v1/admin/school/schedule?postId=${scheduleId}`);
        const json = await res.json();
        if (!json.isSuccess) throw new Error(json.message || "조회 실패");

        const s = json.result;

        modal.dataset.scheduleId = String(s.id);
        document.getElementById("scheduleTitle").value = s.title ?? "";
        document.getElementById("scheduleStartDate").value = s.startDate ?? "";
        document.getElementById("scheduleEndDate").value = s.endDate ?? "";
        // 타입 라디오
        const typeInput = document.querySelector(`input[name="scheduleType"][value="${s.type}"]`);
        if (typeInput) typeInput.checked = true;

        modal.querySelector("h3").textContent = "일정 수정";
        modal.classList.remove("hidden");
        modal.setAttribute("aria-hidden", "false");
    };

    // 닫기(모든 경로에서 id 제거)
    window.closeAddScheduleModal = function () {
        const modal = document.getElementById("addScheduleModal");
        modal.classList.add("hidden");
        modal.setAttribute("aria-hidden", "true");
        // 다음 열림에 영향 없게 비움
        modal.dataset.scheduleId = "";
    };

    // 모달 초기 바인딩
    const modal = document.getElementById("addScheduleModal");
    if (!modal) {
        console.warn("[ScheduleModal] #addScheduleModal not in DOM at load (will still work if added later).");
    }

    // id="openAddScheduleBtn" 가 있다면 자동 바인딩(선택 사항)
    const openBtn = document.getElementById("openAddScheduleBtn");
    if (openBtn) openBtn.addEventListener("click", openAddScheduleModal);

    // 모달 내부 닫기/취소 버튼 위임 바인딩
    document.addEventListener("click", (e) => {
        // 오버레이 클릭으로 닫기
        const overlay = document.getElementById("addScheduleModal");
        if (overlay && e.target === overlay) {
            closeAddScheduleModal();
            return;
        }

        // 닫기 버튼들
        if (e.target.closest("#closeAddScheduleModalBtn")) {
            closeAddScheduleModal();
            return;
        }
        if (e.target.closest("#scheduleCancelBtn")) {
            closeAddScheduleModal();
            return;
        }
    });

    // ESC 로 닫기
    document.addEventListener("keydown", (e) => {
        const m = document.getElementById("addScheduleModal");
        if (e.key === "Escape" && m && !m.classList.contains("hidden")) {
            closeAddScheduleModal();
        }
    });
</script>
<script id="scheduleFetch" type="module">
    async function fetchScheduleList(boardId, page = 0) {
        const root = document.getElementById("schedule-list-editor");
        const typeEl = root.querySelector("#schedule-type-filter");
        const fromEl = root.querySelector("#schedule-date-from");
        const toEl = root.querySelector("#schedule-date-to");
        const kwEl = root.querySelector("#schedule-search");

        const type = (typeEl?.value || "").trim();           // ACADEMIC|...|""(전체)
        const from = (fromEl?.value || "").trim();           // YYYY-MM-DD
        const to = (toEl?.value || "").trim();             // YYYY-MM-DD
        const keyword = (kwEl?.value || "").trim();

        const params = new URLSearchParams();
        params.append("boardId", boardId);
        params.append("page", String(page));
        // params.append("size", "10");
        if (keyword) params.append("title", keyword);
        if (type) params.append("type", type);
        if (from) params.append("startDate", from);
        if (to) params.append("endDate", to);

        try {
            const res = await fetch(`/api/v1/admin/school/schedules?${params.toString()}`);
            const json = await res.json();

            if (json.isSuccess) {
                const pageData = json.result;          // { content, totalPages, number, ... }
                renderScheduleTable(pageData.content); // tbody 렌더
                renderSchedulePagination(pageData, boardId);
            } else {
                alert("일정 목록 불러오기 실패: " + (json.message || ""));
            }
        } catch (e) {
            console.error(e);
            alert("서버 오류 발생");
        }
    }

    // ✅ 테이블 렌더 (#schedule-table-body)
    function renderScheduleTable(schedules = []) {
        const tbody = document.getElementById("schedule-table-body");
        if (!tbody) return;
        tbody.innerHTML = "";

        const today = new Date();
        const pad2 = (n) => String(n).padStart(2, "0");
        const fmt = (d) => {
            if (!d) return "-";
            // 서버가 'YYYY-MM-DD'라면 그대로 출력
            if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
            // 혹시 ISO면 날짜만
            const dt = new Date(d);
            return isNaN(dt) ? "-" : `${dt.getFullYear()}-${pad2(dt.getMonth() + 1)}-${pad2(dt.getDate())}`;
        };
        const statusBadge = (startDate, endDate) => {
            // 진행 상태 계산 (클라이언트 표시용)
            const s = startDate ? new Date(startDate) : null;
            const e = endDate ? new Date(endDate) : null;

            let label = "진행중", cls = "bg-green-500 text-green-400";
            if (s && s > today) {
                label = "예정";
                cls = "bg-yellow-500 text-yellow-400";
            }
            if (e && e < today) {
                label = "종료";
                cls = "bg-gray-500 text-gray-400";
            }

            return `<span class="status-badge px-2 py-1 ${cls} bg-opacity-20 text-xs rounded-full">${label}</span>`;
        };

        schedules.forEach((sch) => {
            const tr = document.createElement("tr");
            tr.className = "table-row border-b border-gray-700";
            tr.innerHTML = `
        <td class="p-3 text-white">${sch.title || "-"}</td>
        <td class="p-3 text-gray-300">${fmt(sch.startDate)}</td>
        <td class="p-3 text-gray-300">${fmt(sch.endDate)}</td>
        <td class="p-3">
          <span class="status-badge px-2 py-1 bg-blue-500 bg-opacity-20 text-blue-400 text-xs rounded-full">
            ${sch.type || "-"}
          </span>
        </td>
        <td class="p-3">
          ${statusBadge(sch.startDate, sch.endDate)}
        </td>
        <td class="p-3">
          <div class="flex space-x-2">
            <button
              class="px-3 py-1 bg-primary text-white text-sm rounded-button hover:bg-blue-600 transition-colors whitespace-nowrap"
              onclick="openEditScheduleModal(${sch.id})"
            >
              수정
            </button>
            <button
              class="px-3 py-1 bg-red-600 text-white text-sm rounded-button hover:bg-red-700 transition-colors whitespace-nowrap"
              onclick="deleteSchedule(${sch.id})"
            >
              삭제
            </button>
          </div>
        </td>
      `;
            tbody.appendChild(tr);
        });
    }

    // ✅ 페이지네이션 렌더 (#schedule-pagination)
    function renderSchedulePagination(pageData, boardId) {
        const container = document.getElementById("schedule-pagination");
        if (!container) return;
        container.innerHTML = "";

        const {totalPages, number} = pageData;

        const makeBtn = (html, disabled, onClick) => {
            const b = document.createElement("button");
            b.innerHTML = html;
            b.className = `px-3 py-2 ${disabled ? "text-gray-600 cursor-not-allowed" : "text-gray-400 hover:text-white"} transition-colors`;
            b.disabled = !!disabled;
            if (!disabled) b.onclick = onClick;
            return b;
        };

        // Prev
        container.appendChild(
            makeBtn(`<i class="ri-arrow-left-line"></i>`, number === 0, () => fetchScheduleList(boardId, number - 1))
        );

        // Pages
        for (let i = 0; i < totalPages; i++) {
            const btn = document.createElement("button");
            btn.textContent = i + 1;
            btn.className = `px-3 py-2 ${i === number ? "bg-primary text-white" : "text-gray-400 hover:text-white"} transition-colors`;
            btn.onclick = () => fetchScheduleList(boardId, i);
            container.appendChild(btn);
        }

        // Next
        container.appendChild(
            makeBtn(`<i class="ri-arrow-right-line"></i>`, number >= totalPages - 1, () => fetchScheduleList(boardId, number + 1))
        );
    }

    // ✅ 삭제/수정(선택)
    async function deleteSchedule(scheduleId) {
        if (!confirm("일정을 삭제하시겠습니까?")) return;
        try {
            const res = await fetch(`/api/v1/admin/school/schedule`, {
                method: "DELETE",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({postId: scheduleId}),
            });
            const json = await res.json();
            if (!json.isSuccess) throw new Error(json.message || "삭제 실패");
            alert("삭제되었습니다.");
            fetchScheduleList(window.currentBoardId, 0);
        } catch (e) {
            console.error(e);
            alert("서버 오류: " + e.message);
        }
    }

    // ✅ 필터 이벤트 바인딩 (변경 시 자동 조회)
    (function () {
        const root = document.getElementById("schedule-list-editor");
        if (!root) return;

        const requery = () => fetchScheduleList(window.currentBoardId, 0);

        root.querySelector("#schedule-type-filter")?.addEventListener("change", requery);
        root.querySelector("#schedule-date-from")?.addEventListener("change", requery);
        root.querySelector("#schedule-date-to")?.addEventListener("change", requery);

        const search = root.querySelector("#schedule-search");
        if (search) {
            let t;
            search.addEventListener("input", () => {
                clearTimeout(t);
                t = setTimeout(requery, 300); // 간단 디바운스
            });
            search.addEventListener("keydown", (e) => {
                if (e.key === "Enter") requery();
            });
        }
    })();

    // window module export
    window.fetchScheduleList = fetchScheduleList;
    window.deleteSchedule = deleteSchedule;
</script>
<script id="postSchedule" type="module">
    async function submitSchedule() {
        const btn = document.getElementById("scheduleSubmitBtn");
        const modal = document.getElementById("addScheduleModal"); // 모달 루트 엘리먼트
        const isEdit = !!modal.dataset.scheduleId;

        const boardId = Number(window.currentBoardId);
        const title = document.getElementById("scheduleTitle").value.trim();
        const startDate = document.getElementById("scheduleStartDate").value; // YYYY-MM-DD
        const endDate = document.getElementById("scheduleEndDate").value;   // YYYY-MM-DD or ""
        const type = document.querySelector('input[name="scheduleType"]:checked')?.value || "ACADEMIC";

        // 기본 검증
        if (!boardId) return alert("boardId가 없습니다.");
        if (!title) return alert("제목을 입력하세요.");
        if (!startDate) return alert("시작 날짜를 선택하세요.");
        if (endDate && endDate < startDate) return alert("끝 날짜가 시작 날짜보다 빠릅니다.");

        // 공통 바디 (PATCH/POST 동일)
        const fd = new FormData();
        fd.append("boardId", String(boardId));
        fd.append("title", title);
        fd.append("startDate", startDate);
        if (endDate) fd.append("endDate", endDate);
        fd.append("type", type);
        if (isEdit) fd.append("scheduleId", modal.dataset.scheduleId);

        const url = "/api/v1/admin/school/schedule";   // PATCH/POST 동일 URL
        const method = isEdit ? "PATCH" : "POST";

        btn.disabled = true;
        try {
            const res = await fetch(url, {method, body: fd});
            const json = await res.json();
            if (!json.isSuccess) throw new Error(json.message || "저장 실패");

            alert(isEdit ? "일정을 수정했습니다." : "일정을 등록했습니다.");
            closeAddScheduleModal();               // 닫으면서 dataset.scheduleId 비우기
            await fetchScheduleList(boardId, 0);   // 목록 갱신 (프로젝트 함수에 맞게)
        } catch (e) {
            console.error(e);
            alert("오류: " + e.message);
        } finally {
            btn.disabled = false;
        }
    }

    // 버튼 클릭 바인딩 (위임)
    document.addEventListener("click", (e) => {
        if (e.target.closest("#scheduleSubmitBtn")) submitSchedule();
    });
</script>

<script id="saveIntroPage" type="module">
    function collectIntro() {
        const titleInput = document.getElementById("intro-title");
        const descInput = document.getElementById("intro-description");

        const title = titleInput ? titleInput.value.trim() : "";
        const description = descInput ? descInput.value.trim() : "";

        const advantageInputs = document.querySelectorAll("#advantages-list input");
        const advantages = Array.from(advantageInputs)
            .map(i => i.value.trim())
            .filter(v => v.length > 0);

        return {
            title,
            description,
            advantages
        };
    }

    // ===== BasicInfo (기본 정보) 수집 =====
    function collectBasicInfo() {
        const schoolName = document.getElementById("basic-schoolName")?.value.trim() || "";
        const builtAt     = document.getElementById("basic-builtAt")?.value.trim() || "";
        const location    = document.getElementById("basic-location")?.value.trim() || "";
        const feature     = document.getElementById("basic-feature")?.value.trim() || "";

        return {
            schoolName,
            builtAt,
            location,
            feature
        };
    }

    // ===== 링크 목록 (추가 링크) 수집 =====
    function collectUrls() {
        const urlNames = [];
        const url = [];

        const urlCards = document.querySelectorAll("#url-list > div, #url-list [data-url-card]");
        urlCards.forEach(card => {
            const inputs = card.querySelectorAll("input");
            if (inputs.length >= 2) {
                const nameValue = inputs[0].value.trim();
                const urlValue  = inputs[1].value.trim();

                if (nameValue || urlValue) {
                    urlNames.push(nameValue);
                    url.push(urlValue);
                }
            }
        });

        return {
            urlNames,
            url
        };
    }

    // ===== 단과대(College) 수집 =====
    // 지금 DTO는 단과대 1개만 받으므로, 첫 번째 카드만 사용
    function collectCollegeDto() {
        const cards = document.querySelectorAll("#college-list .college-card");

        if (!cards.length) {
            return [];   // 비어있으면 빈 배열
        }

        const dtoList = [];

        cards.forEach(card => {
            const nameInput = card.querySelector('[data-role="college-name"]');
            const typeSelect = card.querySelector('[data-role="college-type"]');
            const descTextarea = card.querySelector('[data-role="college-description"]');

            const name = nameInput?.value.trim() || "";
            const description = descTextarea?.value.trim() || "";
            const type = typeSelect?.value || "UNDERGRADUATE";

            // 학과 태그들 수집
            const deptChips = card.querySelectorAll("[data-dept-name]");
            const deptList = Array.from(deptChips)
                .map(chip => chip.dataset.deptName || chip.textContent.trim())
                .filter(v => v.length > 0);

            const departments = deptList.join("_");

            // 단과대 id가 있을 수도 있음
            const collegeId = card.dataset.id
                ? Number(card.dataset.id)
                : null;

            dtoList.push({
                id: collegeId,   // null → 신규, 숫자 → 기존 업데이트
                name,
                description,
                type,
                departments
            });
        });
        return dtoList;
    }

    // ===== 메인: 저장 버튼 클릭 시 호출 =====
    async function saveIntroBoard() {
        // 1. 각 부분 데이터 수집
        const intro = collectIntro();
        const basicInfo = collectBasicInfo();
        const boardId = Number(window.currentBoardId);

        console.log("boardId: ",boardId);
        console.log("windo boardId: ",Number(window.currentBoardId));

        const rankRaw = document.getElementById("college-rank")?.value.trim() || "";
        const collegeRank = rankRaw === "" ? 0 : parseInt(rankRaw, 10) || 0;

        const urlsDto = collectUrls();
        const collegeDto = collectCollegeDto();

        const homepageUrl   = document.getElementById("homepage-url")?.value.trim() || "";
        const englishPageUrl = document.getElementById("english-url")?.value.trim() || "";

        // 2. DTO 구조에 맞는 payload 생성
        const payload = {
            intro,          // IntroSaveDto
            basicInfo,      // BasicInfoSaveDto
            collegeRank,    // int
            urlsDto,        // HomepageUrlSaveDto
            collegeDto,     // CollegeSaveDto (또는 null)
            homepageUrl,
            englishPageUrl,
            boardId
        };

        console.log("보내는 TotalIntroSaveDto:", payload);

        const requestUrl = "/api/v1/admin/school/intro"; // TODO: 실제 엔드포인트로 변경
        try {
            // window.api가 있으면:
            if (window.api && typeof window.api.post === "function") {
                const res = await window.api.post(requestUrl, payload);
                // 서버 응답 구조에 따라 수정
                alert("소개 페이지가 저장되었습니다.");
                // 필요하면 목록 화면으로 이동
                showBoardList();
                return;
            }

            // api 헬퍼가 없다면 fetch 사용
            const res = await fetch(requestUrl, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                throw new Error("HTTP " + res.status);
            }

            const data = await res.json().catch(() => null);
            console.log("서버 응답:", data);
            alert("소개 페이지가 저장되었습니다.");
            showBoardList();
        } catch (e) {
            console.error("소개 저장 중 오류:", e);
            alert("소개 페이지 저장 중 오류가 발생했습니다.");
        }
    }

    window.saveIntroBoard = saveIntroBoard;

</script>

<script id="load-introPage" type="module">
    async function loadIntroBoard(boardId) {

        const data = await api.get(`/admin/school/intro/${boardId}`);
        console.log("로드된 intro 데이터:", data);

        /* -----------------------------
           1) IntroInfo
        ------------------------------ */
        document.getElementById('intro-title').value = data.intro.title || "";
        document.getElementById('intro-description').value = data.intro.description || "";

        // advantages
        const advList = document.getElementById('advantages-list');
        advList.innerHTML = "";
        if (data.intro.advantages) {
            data.intro.advantages.forEach(adv => addAdvantage(adv));
        }

        /* -----------------------------
           2) BasicInfo
        ------------------------------ */
        document.getElementById('basic-schoolName').value = data.basicInfo.schoolName || "";
        document.getElementById('basic-builtAt').value = data.basicInfo.builtAt || "";
        document.getElementById('basic-location').value = data.basicInfo.location || "";

        // feature (List<String>)
        if (data.basicInfo.feature && data.basicInfo.feature.length > 0) {
            document.getElementById('basic-feature').value = data.basicInfo.feature.join(", ");
        }

        /* -----------------------------
           3) CollegeRank
        ------------------------------ */
        document.getElementById('college-rank').value = data.collegeRank ?? "";

        /* -----------------------------
           4) homepageUrl + englishUrl
        ------------------------------ */
        document.getElementById('homepage-url').value = data.homepageUrl || "";
        document.getElementById('english-url').value = data.englishPageUrl || "";

        /* -----------------------------
           5) UrlInfo (추가 링크 목록)
        ------------------------------ */
        const urlList = document.getElementById('url-list');
        urlList.innerHTML = "";

        if (data.homepageUrls &&
            data.homepageUrls.urlNames &&
            data.homepageUrls.urls) {

            data.homepageUrls.urlNames.forEach((name, idx) => {
                addUrlField(name, data.homepageUrls.urls[idx]);
            });
        }

        /* -----------------------------
           6) CollegeInfo (단과대 정보)
        ------------------------------ */
        const collegeList = document.getElementById('college-list');
        collegeList.innerHTML = "";

        data.colleges.forEach(college => {
            addCollege(college.collegeName, college.type, college.departments,college.id);
        });

    }window.loadIntroBoard = loadIntroBoard;
</script>

<script id="board-management" type="module">
    // fixme: 라이브러리를 위한 전역변수 인지 확인 필요, 지역 변수로 변경해도 되는지 파악 필요
    window.currentView = "board-list";
    window.currentBoardName = "";
    window.currentPostTitle = "";

    const fileInputs = [
        document.getElementById("file-input-1"),
        document.getElementById("file-input-2"),
        document.getElementById("file-input-3")
    ];

    function toggleSchool(schoolId) {
        console.log("school " + schoolId);
        const arrow = document.getElementById(schoolId + "-arrow");
        const children = document.getElementById(schoolId + "-children");
        const node = arrow.closest(".tree-node");
        if (node.classList.contains("expanded")) {
            node.classList.remove("expanded");
            arrow.style.transform = "rotate(0deg)";
        } else {
            node.classList.add("expanded");
            arrow.style.transform = "rotate(90deg)";
        }
    }

    function showBoardList() {
        document.getElementById("board-list-view").classList.remove("hidden");
        document.getElementById("intro-board-editor").classList.add("hidden");
        document.getElementById("board-list-editor").classList.add("hidden");
        document.getElementById("schedule-list-editor").classList.add("hidden");
        document.getElementById("post-editor").classList.add("hidden");
        document.getElementById("filePost-editor").classList.add("hidden");
        window.currentView = "board-list";
    }

    function editBoardList(boardTitle, boardId, boardType) {
        window.currentBoardName = boardTitle;
        window.currentBoardId = boardId; // 전역에 저장
        window.currentBoardType = boardType;

        document.getElementById("board-list-title").textContent = boardTitle + " 관리";
        document.getElementById("board-list-title").dataset.type = boardType;

        document.getElementById("board-list-view").classList.add("hidden");
        document.getElementById("intro-board-editor").classList.add("hidden");
        document.getElementById("board-list-editor").classList.remove("hidden");
        document.getElementById("post-editor").classList.add("hidden");
        document.getElementById("filePost-editor").classList.add("hidden");
        window.currentView = "board-list-editor";

        fetchPostList(boardId, 0); // ← 게시판 ID로 목록 불러오기
    }

    function showBoardListEditor() {
        resetFilePostEditor();
        window.currentPostId = null;
        document.getElementById("board-list-view").classList.add("hidden");
        document.getElementById("intro-board-editor").classList.add("hidden");
        document.getElementById("board-list-editor").classList.remove("hidden");
        document.getElementById("schedule-list-editor").classList.add("hidden");
        document.getElementById("post-editor").classList.add("hidden");
        document.getElementById("filePost-editor").classList.add("hidden");
        window.currentView = "board-list-editor";
    }

    //스케줄 목록 관리
    function editScheduleList(boardTitle, boardId, boardType) {
        window.currentBoardName = boardTitle;
        window.currentBoardId = boardId; // 전역에 저장
        window.currentBoardType = boardType;

        document.getElementById("board-list-title").textContent = boardTitle + " 관리";
        document.getElementById("board-list-title").dataset.type = boardType;

        document.getElementById("board-list-view").classList.add("hidden");
        document.getElementById("intro-board-editor").classList.add("hidden");
        document.getElementById("board-list-editor").classList.add("hidden");
        document.getElementById("schedule-list-editor").classList.remove("hidden");
        document.getElementById("post-editor").classList.add("hidden");
        document.getElementById("filePost-editor").classList.add("hidden");
        window.currentView = "board-list-editor";

        fetchScheduleList(boardId, 0); // ← 게시판 ID로 목록 불러오기
    }

    function editIntroBoard(boardName, boardId) {
        window.currentBoardName = boardName;
        console.log("Intro board수정 클릭 boardId:",boardId);
        window.currentBoardId = boardId;
        document.getElementById("intro-board-title").textContent =
            boardName + " 수정";
        document.getElementById("board-list-view").classList.add("hidden");
        document.getElementById("intro-board-editor").classList.remove("hidden");
        document.getElementById("board-list-editor").classList.add("hidden");
        document.getElementById("schedule-list-editor").classList.add("hidden");
        document.getElementById("post-editor").classList.add("hidden");
        document.getElementById("filePost-editor").classList.add("hidden");
        loadIntroBoard(boardId);
        window.currentView = "intro-editor";
    }

    //intro editor 관련 javascript

    function addAdvantage(value = "") {
        const container = document.getElementById("advantages-list");
        if (!container) return;

        if(value===""){
            const div = document.createElement("div");
            div.className = "flex flex-col md:flex-row gap-2 items-stretch";

            const input = document.createElement("input");
            input.className = "dark-input flex-1";
            input.placeholder = "강점 입력 (예: 높은 취업률, 다양한 교환학생 프로그램 등)";

            const btn = document.createElement("button");
            btn.type = "button";
            btn.innerText = "삭제";
            btn.className =
                "px-3 py-2 rounded-button bg-gray-800 text-gray-300 text-xs md:text-sm " +
                "hover:bg-gray-700 border border-gray-700 whitespace-nowrap";
            btn.onclick = () => div.remove();

            div.appendChild(input);
            div.appendChild(btn);

            container.appendChild(div);
        }else{
            const row = document.createElement("div");
            row.className = "flex gap-2";

            row.innerHTML = `
        <input class="dark-input flex-1" value="${value}">
        <button type="button" class="text-red-400 hover:text-red-300" onclick="this.parentElement.remove()">
            <i class="ri-delete-bin-line"></i>
        </button>
    `;
            container.appendChild(row);
        }
    }

    function addUrlField(name = "", url = "") {
        const container = document.getElementById("url-list");
        if (!container) return;

        if(name==="" && url===""){
            const div = document.createElement("div");
            // 카드형으로: 어두운 배경 + border
            div.className =
                "rounded-2xl border border-gray-800 bg-gray-900/70 p-3 md:p-4 space-y-3";

            div.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
                <label class="block text-xs font-medium text-gray-200 mb-1">
                    링크 이름
                </label>
                <input
                    class="dark-input"
                    placeholder="예: 입학 안내, 장학 제도"
                />
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-200 mb-1">
                    URL
                </label>
                <input
                    class="dark-input"
                    placeholder="예: https://www.example.ac.kr/admission"
                />
            </div>
        </div>
        <div class="flex justify-end">
            <button
                type="button"
                class="mt-1 inline-flex items-center px-3 py-1.5 rounded-button bg-gray-800 text-gray-300 text-xs hover:bg-gray-700 border border-gray-700"
                onclick="this.closest('[data-url-card]')?.remove()">
                <i class="ri-delete-bin-line mr-1 text-sm"></i>
                링크 삭제
            </button>
        </div>
    `;

            // 삭제 버튼에서 closest로 찾을 수 있게 data 속성 부여
            div.setAttribute("data-url-card", "true");

            container.appendChild(div);
        }else{
            const row = document.createElement("div");
            row.className = "grid grid-cols-1 md:grid-cols-2 gap-3";

            row.innerHTML = `
        <input class="dark-input" placeholder="링크 이름" value="${name}">
        <div class="flex gap-3">
            <input class="dark-input flex-1" placeholder="URL" value="${url}">
            <button type="button" class="text-red-400 hover:text-red-300" onclick="this.parentElement.parentElement.remove()">
                <i class="ri-delete-bin-line"></i>
            </button>
        </div>
    `;
            container.appendChild(row);
        }
    }

    let collegeCounter = 0;

    function addCollege(name = "", type = "UNDERGRADUATE", departments = [],id = null) {
        const list = document.getElementById("college-list");
        const index = collegeCounter++;

        const wrapper = document.createElement("div");
        wrapper.className = "college-card border border-gray-800 rounded-2xl bg-gray-900/70 p-4 md:p-5 space-y-4";
        wrapper.dataset.collegeIndex = String(index);

        // 카드 HTML (원본 그대로 유지)
        wrapper.innerHTML = `
        <div class="flex items-start justify-between gap-3">
            <div class="flex-1 space-y-3">

                <!-- 단과대 이름 -->
                <div>
                    <label class="block text-sm font-medium text-gray-200 mb-1">
                        단과대 이름
                    </label>
                    <input
                        type="text"
                        class="dark-input"
                        data-role="college-name"
                        placeholder="예: 공과대학"
                    />
                </div>

                <!-- 학위 구분 -->
                <div>
                    <label class="block text-sm font-medium text-gray-200 mb-1">
                        학위 구분
                    </label>
                    <select class="dark-input" data-role="college-type">
                        <option value="UNDERGRADUATE">학사 과정</option>
                        <option value="GRADUATE">석/박사 과정</option>
                    </select>
                    <p class="field-help">해당 단과대의 주 교육 과정을 선택해 주세요.</p>
                </div>

                <!-- 설명 -->
                <div>
                    <label class="block text-sm font-medium text-gray-200 mb-1">
                        단과대 설명 (선택)
                    </label>
                    <textarea
                        class="dark-input !rounded-2xl !h-20 !py-2.5 resize-none"
                        data-role="college-description"
                        placeholder="단과대의 주요 전공 및 특징을 간단히 소개해 주세요."></textarea>
                </div>

                <!-- 학과 태그 영역 -->
                <div>
                    <div class="flex items-center justify-between mb-1">
                        <label class="block text-sm font-medium text-gray-200">
                            소속 학과
                        </label>
                        <span class="text-xs text-gray-500">
                            학과명을 입력 후 Enter를 누르면 추가됩니다.
                        </span>
                    </div>

                    <div class="flex flex-wrap gap-2 mb-2" data-role="department-chips"></div>

                    <input
                        type="text"
                        class="dark-input"
                        data-role="department-input"
                        placeholder="예: 컴퓨터공학과, 전기공학과 등 입력 후 Enter"
                    />
                </div>
            </div>

            <!-- 단과대 삭제 -->
            <button
                type="button"
                class="ml-2 text-gray-500 hover:text-red-500 text-sm flex-shrink-0"
                onclick="removeCollege(this)">
                <i class="ri-close-line mr-0.5"></i> 삭제
            </button>
        </div>
    `;

        list.appendChild(wrapper);
        if (id !== null) wrapper.dataset.id = id;


        wrapper.querySelector('[data-role="college-name"]').value = name || "";
        wrapper.querySelector('[data-role="college-type"]').value = type || "UNDERGRADUATE";
        const chipWrap = wrapper.querySelector('[data-role="department-chips"]');

        if (departments && Array.isArray(departments)) {
            departments.forEach(dep => {
                const chip = document.createElement("span");
                chip.className = "px-2 py-1 bg-gray-700 text-gray-100 text-xs rounded-full flex items-center gap-1 dept-chip";
                chip.dataset.deptName = dep;
                chip.innerHTML = `
                <span class="mr-1">${dep}</span>
                <button type="button" class="text-gray-300 hover:text-red-400"
                        onclick="this.parentElement.remove()">
                    <i class="ri-close-line text-xs"></i>
                </button>
            `;
                chipWrap.appendChild(chip);
            });
        }

        setupDepartmentInput(wrapper);
    }

    function removeCollege(button) {
        const card = button.closest(".college-card");
        if (card) {
            card.remove();
        }
    }

    function setupDepartmentInput(collegeElement) {
        const input = collegeElement.querySelector('[data-role="department-input"]');
        const chipsContainer = collegeElement.querySelector('[data-role="department-chips"]');

        if (!input || !chipsContainer) return;

        // Enter 키로 태그 추가
        input.addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                const value = input.value.trim();
                if (!value) return;

                addDepartmentChip(chipsContainer, value);
                input.value = "";
            }
        });
    }

    function addDepartmentChip(container, name) {
        // 같은 이름 중복 방지 (원하면 제거)
        const exists = Array.from(container.querySelectorAll("[data-dept-name]"))
            .some(span => span.dataset.deptName === name);
        if (exists) return;

        const chip = document.createElement("span");
        chip.className = "inline-flex items-center px-2.5 py-1 rounded-full bg-gray-800 text-gray-100 text-xs border border-gray-600";
        chip.dataset.deptName = name;

        chip.innerHTML = `
            <span class="mr-1">${name}</span>
            <button type="button" class="text-gray-400 hover:text-red-400 text-xs"
                    onclick="this.parentElement.remove()">
                <i class="ri-close-line"></i>
            </button>
        `;

        container.appendChild(chip);
    }

    window.addCollege = addCollege;
    window.removeCollege = removeCollege;
    window.addAdvantage = addAdvantage;
    window.addUrlField = addUrlField;


    async function deleteBoard(boardName, boardId) {
        if (confirm(`"${boardName}" 게시판을 삭제하시겠습니까?`)) {
            try {
                const response = await fetch("/api/v1/admin/school/board", {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({boardId: boardId})
                });

                const result = await response.json();
                if (result.isSuccess) {
                    // 알림 표시
                    const notification = document.createElement("div");
                    notification.className =
                        "fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
                    notification.textContent = "게시판이 삭제되었습니다";
                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.remove();
                        location.reload(); // 새로고침
                    }, 1500);
                } else {
                    alert("삭제 실패: " + result.message);
                }
            } catch (e) {
                console.error("삭제 오류:", e);
                alert("오류가 발생했습니다.");
            }
        }
    }

    function createNewPost() {
        document.getElementById("post-editor-title").textContent = "새 게시글 작성";
        const type = window.currentBoardType
        console.log("createNewPost type:", type);
        document.querySelector('#post-editor input[type="text"]').value = "";
        document.querySelector("#post-editor textarea").value = "";

        document.getElementById("board-list-view").classList.add("hidden");
        document.getElementById("intro-board-editor").classList.add("hidden");
        document.getElementById("board-list-editor").classList.add("hidden");
        document.getElementById("schedule-list-editor").classList.add("hidden");

        if (type === "NOTICE") {
            document.getElementById("post-editor").classList.remove("hidden");
            document.getElementById("filePost-editor").classList.add("hidden");
            window.currentView = "post-editor";
        } else {
            document.getElementById("filePost-editor").classList.remove("hidden");
            document.getElementById("post-editor").classList.add("hidden");
            window.currentView = "filePost-editor";
        }
    }

    async function editPost(postTitle, postId, type) {
        console.log(postTitle, postId);
        window.currentPostTitle = postTitle;
        console.log("editPost에서 " + window.currentPostTitle);
        console.log("type:", type);
        window.currentPostId = postId;
        try {
            const url = "/api/v1/admin/school/" + ((type === "FILES") ? "file" : "post") + `?postId=${postId}`;
            const response = await fetch(url);

            const result = await response.json();
            console.log("값 가져옴");

            if (result.isSuccess) {
                const post = result.result.post;
                const files = result.result.file;

                if (type === "NOTICE") {
                    console.log("NOTICE타입");
                    // 1. 제목, 설명 세팅
                    const textInputs = document.querySelectorAll('#post-editor input[type="text"]');
                    textInputs[0].value = post.title;
                    textInputs[1].value = post.description;

                    // 2. 내용 세팅 (SunEditor)
                    editor.setContents(post.content);

                    // 3. 카테고리 설정 (select)
                    const type = post.type === 'NOTICE' ? '공지사항' : '일반';
                    const select = document.querySelector('#post-editor select');
                    for (let i = 0; i < select.options.length; i++) {
                        if (select.options[i].text === type) {
                            select.selectedIndex = i;
                            break;
                        }
                    }

                    //4.파일 가져온거 추가해주기
                    for (let i = 0; i < 3; i++) {
                        const nameDiv = document.getElementById(`file-name-${i + 1}`);
                        const input = document.getElementById(`file-input-${i + 1}`);

                        if (files[i]) {
                            nameDiv.textContent = `📎 ${files[i].name}`;
                            // 덮어쓴 파일 구분 위해 fileId 저장
                            input.dataset.existingFileId = files[i].fileId;
                            const clearButton = document.querySelector(`.clear-btn[data-index="${i + 1}"]`);
                            clearButton.classList.remove("hidden");
                        } else {
                            nameDiv.textContent = "";
                            delete input.dataset.existingFileId;
                        }
                    }

                    // UI 보여주기
                    document.getElementById("post-editor-title").textContent = "게시글 수정 - " + post.title;
                    document.getElementById("board-list-view").classList.add("hidden");
                    document.getElementById("intro-board-editor").classList.add("hidden");
                    document.getElementById("board-list-editor").classList.add("hidden");
                    document.getElementById("schedule-list-editor").classList.add("hidden");
                    document.getElementById("post-editor").classList.remove("hidden");
                    document.getElementById("filePost-editor").classList.add("hidden");
                    window.currentView = "post-editor";
                } else if (type === "FILES") {
                    console.log("FILES타입");
                    const textInputs = document.querySelectorAll('#filePost-editor input[type="text"]');
                    textInputs[0].value = post.title;

                    // 3. 카테고리 설정 (select)
                    const type = post.type === 'NOTICE' ? '공지사항' : '일반';
                    const select = document.querySelector('#filePost-editor select');
                    for (let i = 0; i < select.options.length; i++) {
                        if (select.options[i].text === type) {
                            select.selectedIndex = i;
                            break;
                        }
                    }

                    const nameDiv = document.getElementById(`postFile-name`);
                    const input = document.getElementById(`postFile-input`);
                    if (files) {
                        nameDiv.textContent = `📎 ${files.name}`;
                        // 덮어쓴 파일 구분 위해 fileId 저장
                        input.dataset.existingFileId = files.fileId;
                        const clearBtn = document.getElementById("clear-postFile");
                        clearBtn.classList.remove("hidden");
                    } else {
                        nameDiv.textContent = "";
                        delete input.dataset.existingFileId;
                    }

                    // UI 보여주기
                    document.getElementById("post-editor-title").textContent = "게시글 수정 - " + post.title;
                    document.getElementById("board-list-view").classList.add("hidden");
                    document.getElementById("intro-board-editor").classList.add("hidden");
                    document.getElementById("board-list-editor").classList.add("hidden");
                    document.getElementById("schedule-list-editor").classList.add("hidden");
                    document.getElementById("post-editor").classList.add("hidden");
                    document.getElementById("filePost-editor").classList.remove("hidden");
                    window.currentView = "post-editor";
                }
            } else {
                alert("게시글 정보를 불러오지 못했습니다.");
                window.currentPostId = null;
            }

        } catch (e) {
            console.error("게시글 불러오기 오류:", e);
            alert("서버 오류가 발생했습니다.");
        }
    }

    async function savePost(status) {
        const boardId = Number(window.currentBoardId);
        const title = document.querySelector('#post-editor input[type="text"]').value.trim();
        const description = document.querySelectorAll('#post-editor input[type="text"]')[1].value.trim();
        const content = editor.getContents();
        const category = document.querySelector('#post-editor select').value;
        const type = category === '공지사항' ? 'NOTICE' : 'NORMAL';

        const formData = new FormData();
        formData.append("boardId", boardId);
        formData.append("title", title);
        formData.append("description", description);
        formData.append("content", content);
        formData.append("status", status);
        formData.append("type", type);

        const filesToDelete = [];

        fileInputs.forEach(input => {
            const existingFileId = input.dataset.existingFileId;
            const index = input.dataset.index;
            const fileNameDisplay = document.querySelector(`.file-name[data-index="${index}"]`);

            if (input.files.length > 0) {
                formData.append("files", input.files[0]);
                if (existingFileId) {
                    filesToDelete.push(existingFileId);
                }
            } else if (existingFileId && (!fileNameDisplay.textContent || fileNameDisplay.textContent.trim() === '')) {
                filesToDelete.push(existingFileId);
            }
        });

        filesToDelete.forEach(fileId => {
            formData.append("deleteFileIds", fileId);
        });

        try {
            if (window.currentPostId) {
                formData.append("postId", window.currentPostId);
            }
            const response = await fetch("/api/v1/admin/school/post", {
                method: window.currentPostId ? "PATCH" : "POST",
                body: formData
            });

            const result = await response.json();
            window.currentPostId = null;

            if (result.isSuccess) {
                alert("게시글이 저장되었습니다.");
                resetPostEditor();
                await fetchPostList(boardId, 0); // ← 게시판 ID로 목록 불러오기
                showBoardListEditor();
            } else {
                throw new Error(result.message || "저장 실패");
            }
        } catch (e) {
            console.error(e);
            alert("오류 발생: " + e.message);
        }
    }

    async function saveFilePost(status) {

        console.log("saveFilePost");

        const boardId = Number(window.currentBoardId);

        const title = document.querySelector('#filePost-editor input[type="text"]').value.trim();
        const category = document.querySelector('#filePost-editor select').value;
        const type = category === '공지사항' ? 'NOTICE' : 'NORMAL';

        const formData = new FormData();
        formData.append("boardId", boardId);
        formData.append("title", title);
        formData.append("status", status);
        formData.append("type", type);

        let filesToDelete;

        const fileInput = document.getElementById("postFile-input");

        console.log("fileInput", fileInput);

        if (fileInput) {
            const existingFileId = fileInput.dataset.existingFileId;
            const fileNameDisplay = document.getElementById(`postFile-name`);

            if (fileInput.files.length > 0) {
                formData.append("files", fileInput.files[0]);
                if (existingFileId) {
                    filesToDelete = existingFileId;
                } else if (existingFileId && (!fileNameDisplay.textContent || fileNameDisplay.textContent.trim() === '')) {
                    filesToDelete = existingFileId;
                }
            }
        }

        formData.append("deleteFileIds", filesToDelete);

        try {
            if (window.currentPostId) {
                formData.append("postId", window.currentPostId);
            }

            console.log("forData:", formData);

            const response = await fetch("/api/v1/admin/school/file", {
                method: window.currentPostId ? "PATCH" : "POST",
                body: formData
            });

            const result = await response.json();
            window.currentPostId = null;

            if (result.isSuccess) {
                alert("게시글이 저장되었습니다.");
                resetFilePostEditor();
                await fetchPostList(boardId, 0); // ← 게시판 ID로 목록 불러오기
                showBoardListEditor();
            } else {
                throw new Error(result.message || "저장 실패");
                console.log("저장 실패");
            }
        } catch (e) {
            console.error(e);
            alert("오류 발생: " + e.message);
        }
    }


    const clearButtons = document.querySelectorAll('.clear-btn');
    clearButtons.forEach(button => {
        button.addEventListener('click', () => {
            console.log("초기화 클릭");
            const index = button.dataset.index;
            const fileInput = document.querySelector(`.file-input[data-index="${index}"]`);
            const fileNameDisplay = document.querySelector(`.file-name[data-index="${index}"]`);

            fileInput.value = '';
            fileNameDisplay.textContent = '';
            button.classList.add('hidden');
        });
    });

    // export module functions
    window.toggleSchool = toggleSchool;
    window.showBoardList = showBoardList;
    window.editBoardList = editBoardList;
    window.showBoardListEditor = showBoardListEditor;
    window.editScheduleList = editScheduleList;
    window.editIntroBoard = editIntroBoard;
    window.deleteBoard = deleteBoard;
    window.createNewPost = createNewPost;
    window.editPost = editPost;
    window.savePost = savePost;
    window.saveFilePost = saveFilePost
</script>
<script type="module">
    // fixme: board-management 모듈과 합쳐도 될 지 고민 필요
    function renderPagination(pageData, boardId) {
        const paginationContainer = document.getElementById("pagination");
        console.log(paginationContainer + "가져옴");
        paginationContainer.innerHTML = "";

        const {totalPages, number} = pageData;

        // fix 새 카테고리 추가에 버튼이 생김

        // 이전 버튼
        const prev = document.createElement("button");
        prev.innerHTML = `<i class="ri-arrow-left-line"></i>`;
        prev.className = "px-3 py-2 text-gray-400 hover:text-white transition-colors";
        prev.disabled = number === 0;
        prev.onclick = () => fetchPostList(boardId, number - 1);
        paginationContainer.appendChild(prev);

        for (let i = 0; i < totalPages; i++) {
            const btn = document.createElement("button");
            btn.textContent = i + 1;
            btn.className = `px-3 py-2 ${i === number ? 'bg-primary text-white' : 'text-gray-400 hover:text-white'}`;
            btn.onclick = () => fetchPostList(boardId, i);
            paginationContainer.appendChild(btn);
        }

        // 다음 버튼
        const next = document.createElement("button");
        next.innerHTML = `<i class="ri-arrow-right-line"></i>`;
        next.className = "px-3 py-2 text-gray-400 hover:text-white transition-colors";
        next.disabled = number >= totalPages - 1;
        next.onclick = () => fetchPostList(boardId, number + 1);
        paginationContainer.appendChild(next);
    }

    function renderPostTable(posts) {
        const tbody = document.getElementById("post-table-body");
        console.log("tbody:" + tbody);
        tbody.innerHTML = ''; // 기존  테이블 비우기

        posts.forEach(post => {
            const id = post.id;
            const isNotice = post.type === "NOTICE";
            const isTemp = post.status === "TEMPORARY";

            const row = document.createElement("tr");
            row.className = "table-row border-b border-gray-700";

            row.innerHTML = `
        <td class="p-3">
            <div class="flex items-center">
                ${isNotice ? '<span class="status-badge px-2 py-1 bg-red-500 bg-opacity-20 text-red-400 text-xs rounded-full mr-3">공지</span>' : ''}
                <span class="text-white">${post.title}</span>
            </div>
        </td>
        <td class="p-3 text-gray-300">${post.writer || '관리자'}</td>
        <td class="p-3 text-gray-400">${post.createdAt || '-'}</td>
        <td class="p-3 text-gray-300">${post.views}</td>
        <td class="p-3">
            <span class="status-badge px-2 py-1 ${isTemp ? 'bg-yellow-500 text-yellow-400' : 'bg-green-500 text-green-400'} bg-opacity-20 text-xs rounded-full">
                ${isTemp ? '임시저장' : '게시중'}
            </span>
        </td>
        <td class="p-3">
            <div class="flex space-x-2">
                <button
                    data-post-title="${post.title}"
                    data-post-id="${post.id}"
                    data-post-type="${post.postType}"
                    onclick="editPost(this.dataset.postTitle, this.dataset.postId, this.dataset.postType)"
                    class="px-3 py-1 bg-primary text-white text-sm rounded-button hover:bg-blue-600 transition-colors whitespace-nowrap">
                    수정
                </button>
                <button
                data-post-type="${post.postType}"
                data-post-id="${post.id}"
                onclick="deletePost(this.dataset.postId,this.dataset.postType)" class="px-3 py-1 bg-red-600 text-white text-sm rounded-button hover:bg-red-700 transition-colors whitespace-nowrap">삭제</button>
            </div>
        </td>
    `;
            tbody.appendChild(row);
        });
    }

    async function deletePost(postId, type) {
        if (!confirm("정말 삭제하시겠습니까?")) return;

        console.log("postId:", postId);
        try {
            const url = "/api/v1/admin/school/" + ((type === "NOTICE") ? "post" : "file");
            console.log("type:", type);
            console.log("url:", url);
            const response = await fetch(url, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({postId})
            });

            const result = await response.json();
            if (result.isSuccess) {
                alert("삭제 완료되었습니다.");
                fetchPostList(window.currentBoardId); // 삭제 후 리스트 다시 불러오기
            } else {
                alert("삭제 실패: " + result.message);
            }
        } catch (e) {
            console.error(e);
            alert("서버 오류: 삭제 요청 실패");
        }
    }

    async function fetchPostList(boardId, page = 0) {
        const status = document.querySelector("#board-list-editor select").value; // 필터 (예: 전체, PUBLISHED, TEMP)
        const keyword = document.querySelector("#board-list-editor input[type='text']").value.trim();

        const statusMap = {
            "일반": "NORMAL",
            "공지": "NOTICE",
            "전체": "ALL"
        };

        const params = new URLSearchParams({
            boardId: boardId,
            page: page,
            size: 10,
            keyword: keyword,
            status: statusMap[status] ?? null
        });

        try {
            const response = await fetch(`/api/v1/admin/school/posts?${params.toString()}`);
            const result = await response.json();
            console.log("값 가져옴");
            if (result.isSuccess) {
                console.log("데이터:" + result.result.content);
                renderPostTable(result.result.content); // 리스트 렌더링
                renderPagination(result.result, boardId); // 페이징 렌더링
            } else {
                alert("게시글 목록 불러오기 실패: " + result.message);
            }
        } catch (e) {
            console.error(e);
            alert("서버 오류 발생");
        }
    }

    // export module functions
    window.deleteBoard = deleteBoard;
    window.fetchPostList = fetchPostList;
</script>
<script id="toggle-switches" type="module">
    const toggles = document.querySelectorAll('input[type="checkbox"]');
    toggles.forEach((toggle) => {
        const toggleContainer = toggle.nextElementSibling;
        const toggleBg = toggleContainer.querySelector("div:first-child");
        const toggleThumb = toggleContainer.querySelector("div:last-child");
        toggle.addEventListener("change", function () {
            if (this.checked) {
                toggleBg.classList.remove("bg-gray-600");
                toggleBg.classList.add("bg-primary");
                toggleThumb.classList.add("translate-x-5");
            } else {
                toggleBg.classList.remove("bg-primary");
                toggleBg.classList.add("bg-gray-600");
                toggleThumb.classList.remove("translate-x-5");
            }
        });
    });
    const boardTypeRadios = document.querySelectorAll('input[name="boardType"]');
    boardTypeRadios.forEach((radio) => {
        radio.addEventListener("change", function () {
            const labels = document.querySelectorAll("label.relative");
            labels.forEach((label) => {
                const border = label.querySelector(".absolute");
                if (label.contains(this)) {
                    border.classList.remove("opacity-0");
                    border.classList.add("opacity-100");
                } else {
                    border.classList.remove("opacity-100");
                    border.classList.add("opacity-0");
                }
            });
        });
    });
</script>
<script type="module">
    function submitAddCategory() {
        const modal = document.getElementById("addCategoryModal");
        const schoolId = modal.dataset.schoolId;

        const boardTitle = document.querySelector('input[placeholder="카테고리 이름을 입력하세요"]').value;
        const boardDescription = document.querySelectorAll('input[placeholder="카테고리 이름을 입력하세요"]')[1].value;

        const boardTypeValue = document.querySelector('input[name="boardType"]:checked').value;

        console.log("boardType:", boardTypeValue);

        let boardType;
        if (boardTypeValue === "intro") boardType = "intro";
        else if (boardTypeValue === "files") boardType = "files";
        else if (boardTypeValue === "schedule") boardType = "schedule";
        else boardType = "notice"; // 기본값

        const data = {
            schoolId: Number(schoolId),
            boardTitle: boardTitle,
            realTitle: boardTitle, // 필요시 다른 값으로 수정
            boardDescription: boardDescription,
            boardType: boardType
        };

        fetch("/api/v1/admin/school/board", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("카테고리 추가에 실패했습니다.");
                }
                return response.json();
            })
            .then(result => {
                alert("카테고리가 성공적으로 추가되었습니다.");
                window.location.href = "/admin/school";
            })
            .catch(error => {
                console.error(error);
                alert("에러 발생: " + error.message);
            });
    }

    // export module functions
    window.submitAddCategory = submitAddCategory;
</script>

<script id="textEdit" type="module">
    const editor = SUNEDITOR.create('intro-editor', {
        lang: SUNEDITOR_LANG['ko'],
        height: '300px',
        width: '100%',
        placeholder: '학교 소개 내용을 입력하세요...',
        buttonList: [
            ['undo', 'redo', 'formatBlock', 'fontSize', 'bold', 'underline', 'italic', 'strike',
                'fontColor', 'hiliteColor', 'align', 'list', 'table', 'link', 'image', 'codeView']
        ],
        imageUploadUrl: '/api/v1/file/school',
        withCredentials: true,
        imageUploadName: 'file',
        imageMultipleFile: false
    });

    // export module functions
    window.editor = editor;
</script>

<script type="module">
    // 파일 입력
    document.querySelectorAll('input[type="file"]').forEach((fileInput) => {
        const type = fileInput.dataset.type; // file or image
        const container = fileInput.closest('.space-y-3');
        const fileNameDisplay = type === "image"
            ? container?.querySelector('.image-input')
            : container?.querySelector('.file-name, #postFile-name');

        if (fileNameDisplay) {
            fileInput.addEventListener("change", function () {
                const index = fileInput.dataset.index;
                const clearButton = document.querySelector(`.clear-btn[data-index="${index}"], #clear-postFile`);

                fileNameDisplay.textContent = this.files.length > 0
                    ? `선택된 파일: ${this.files[0].name}`
                    : '';

                if (clearButton) {
                    clearButton.classList.remove('hidden');
                }
            });
        }
    });

    function resetPostEditor() {
        // 제목, 설명 초기화
        const textInputs = document.querySelectorAll('#post-editor input[type="text"]');
        textInputs.forEach(input => input.value = "");

        // SunEditor 내용 초기화
        editor.setContents("");

        // 카테고리 select 초기화
        document.querySelector('#post-editor select').selectedIndex = 0;

        // 파일 input 초기화
        for (let i = 1; i <= 3; i++) {
            const input = document.getElementById(`file-input-${i}`);
            if (input) input.value = "";
            const label = document.getElementById(`file-name-${i}`);
            if (label) label.textContent = "";
        }

    }

    function resetFilePostEditor() {
        // 제목, 설명 초기화
        const textInputs = document.querySelectorAll('#filePost-editor input[type="text"]');
        textInputs.forEach(input => input.value = "");

        // 카테고리 select 초기화
        document.querySelector('#filePost-editor select').selectedIndex = 0;
        //파일 초기화
        const input = document.getElementById(`postFile-input`);
        if (input) input.value = "";
        const nameDiv = document.getElementById(`postFile-name`);
        if (nameDiv) nameDiv.textContent = "";
        const clearBtn = document.getElementById(`clear-postFile`);
        if (clearBtn) clearBtn.classList.add("hidden");

    }

    // export module functions
    window.resetPostEditor = resetPostEditor;
    window.resetFilePostEditor = resetFilePostEditor;
</script>
<script type="module">
    const boardTypeRadios = document.querySelectorAll('input[name="boardType"]');

    boardTypeRadios.forEach((radio) => {
        radio.addEventListener("change", function () {
            const allLabels = document.querySelectorAll('label.relative');
            allLabels.forEach((label) => {
                const border = label.querySelector(".absolute");
                border.classList.remove("opacity-100");
                border.classList.add("opacity-0");
            });

            const selectedLabel = this.closest("label.relative");
            const border = selectedLabel.querySelector(".absolute");
            border.classList.remove("opacity-0");
            border.classList.add("opacity-100");
        });
    });
</script>
</body>
</html>